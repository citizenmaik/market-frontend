<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Markets">
<meta name="theme-color" content="#0a0b0e" id="themeColorMeta">
<title>Market Dashboard</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CSS Variables â€” Dark & Light Theme
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --green:#00d084; --red:#ff4466; --yellow:#f5c842; --blue:#4d9fff; --accent:#7c6af7;
  --mono:'IBM Plex Mono',monospace; --sans:'IBM Plex Sans',sans-serif;
  --radius:8px; --gap:10px;
  --transition: background .25s, color .25s, border-color .25s;
}
[data-theme="dark"] {
  --bg:#0a0b0e; --surface:#111318; --surface2:#171b22; --border:#1e2330;
  --text:#e8eaf0; --muted:#5a6070; --th-btn:#1e2535;
}
[data-theme="light"] {
  --bg:#f0f2f5; --surface:#ffffff; --surface2:#f7f8fa; --border:#e2e6ed;
  --text:#1a1d24; --muted:#8a94a6; --th-btn:#e8ecf2;
  --green:#00a864; --red:#d63050; --yellow:#c8971a; --blue:#2b7fd4; --accent:#5c4fd6;
}

/* â”€â”€ Reset â”€â”€ */
*{margin:0;padding:0;box-sizing:border-box;}
body {
  background:var(--bg); color:var(--text);
  font-family:var(--sans); min-height:100vh;
  padding: env(safe-area-inset-top,12px) env(safe-area-inset-right,16px)
           env(safe-area-inset-bottom,16px) env(safe-area-inset-left,16px);
  transition: var(--transition);
}

/* â•â• LOGIN SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#loginScreen {
  position:fixed;inset:0;z-index:1000;
  background:var(--bg);
  display:flex;align-items:center;justify-content:center;
  flex-direction:column;gap:20px;
  transition:opacity .3s;
}
#loginScreen.hidden{opacity:0;pointer-events:none;}
.login-box {
  background:var(--surface);border:1px solid var(--border);
  border-radius:14px;padding:32px 28px;width:320px;max-width:90vw;
  box-shadow:0 20px 60px rgba(0,0,0,.4);
}
.login-logo {
  font-family:var(--mono);font-size:11px;letter-spacing:.2em;
  color:var(--muted);text-transform:uppercase;text-align:center;margin-bottom:24px;
}
.login-logo span{display:block;font-size:22px;letter-spacing:.05em;color:var(--text);margin-bottom:6px;}
.login-box input {
  width:100%;background:var(--surface2);border:1px solid var(--border);
  border-radius:7px;padding:11px 14px;color:var(--text);
  font-family:var(--mono);font-size:14px;outline:none;
  transition:border-color .2s;margin-bottom:12px;
}
.login-box input:focus{border-color:var(--accent);}
.login-box input::placeholder{color:var(--muted);}
.login-btn {
  width:100%;padding:11px;border:none;border-radius:7px;
  background:var(--accent);color:#fff;font-family:var(--mono);
  font-size:13px;font-weight:600;cursor:pointer;letter-spacing:.05em;
  transition:opacity .2s;
}
.login-btn:hover{opacity:.85;}
.login-err{color:var(--red);font-family:var(--mono);font-size:11px;text-align:center;height:14px;}

/* â•â• HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.hdr {
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:14px;padding-bottom:12px;border-bottom:1px solid var(--border);
  gap:10px;flex-wrap:wrap;
}
.hdr h1{font-family:var(--mono);font-size:11px;letter-spacing:.15em;color:var(--muted);text-transform:uppercase;}
.hdr-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.dt{font-family:var(--mono);font-size:10px;color:var(--muted);}
.last-upd{font-family:var(--mono);font-size:9px;color:var(--muted);}

/* Theme toggle */
.th-btn {
  width:32px;height:32px;border-radius:50%;border:1px solid var(--border);
  background:var(--th-btn);cursor:pointer;display:flex;align-items:center;
  justify-content:center;font-size:15px;transition:all .2s;flex-shrink:0;
}
.th-btn:hover{border-color:var(--accent);}

/* Status pill */
.pill {
  font-family:var(--mono);font-size:9px;padding:4px 10px;
  border-radius:10px;border:1px solid var(--border);
  color:var(--muted);display:flex;align-items:center;gap:5px;
  cursor:pointer;transition:all .2s;white-space:nowrap;
}
.pill:hover{border-color:var(--accent);}
.pill.live{border-color:rgba(0,208,132,.4);color:var(--green);}
.pill.error{border-color:rgba(255,68,102,.4);color:var(--red);}
.pill.loading{border-color:rgba(77,159,255,.4);color:var(--blue);}
.dot{width:6px;height:6px;border-radius:50%;background:currentColor;flex-shrink:0;}
.pulse{animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* â•â• INDEX CARDS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.idx{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-bottom:12px;}
.ic{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:11px 12px;transition:var(--transition),border-color .2s;cursor:pointer;}
.ic:hover{border-color:var(--accent);}
.ic .tk{font-family:var(--mono);font-size:9px;color:var(--muted);letter-spacing:.1em;margin-bottom:4px;}
.ic .pr{font-family:var(--mono);font-size:14px;font-weight:500;margin-bottom:3px;}
.ic .ch{font-family:var(--mono);font-size:10px;font-weight:600;margin-bottom:4px;}
.ic .nm{font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;}
.up{color:var(--green);} .dn{color:var(--red);}

/* â•â• PANELS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.pnl{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;transition:var(--transition);}
.ph{padding:9px 13px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:7px;}
.ph::before{content:'';display:block;width:3px;height:12px;background:var(--accent);border-radius:2px;flex-shrink:0;}
.ph h3{font-family:var(--mono);font-size:10px;letter-spacing:.11em;text-transform:uppercase;font-weight:500;}

/* â•â• LAYOUT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.r1{display:grid;grid-template-columns:200px 240px 1fr 190px 220px;gap:var(--gap);margin-bottom:var(--gap);}
.r2{display:grid;grid-template-columns:250px 1fr;gap:var(--gap);margin-bottom:var(--gap);}
.r3{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--gap);margin-bottom:var(--gap);}

/* â•â• MARKET CONDITIONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.mc{padding:12px;}
.mc-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.mc-badge{font-family:var(--mono);font-size:12px;font-weight:600;padding:3px 10px;border-radius:4px;}
.mc-badge.neg{background:rgba(255,68,102,.15);color:var(--red);border:1px solid rgba(255,68,102,.3);}
.mc-badge.pos{background:rgba(0,208,132,.15);color:var(--green);border:1px solid rgba(0,208,132,.3);}
.mc-badge.neu{background:rgba(90,96,112,.2);color:var(--muted);border:1px solid rgba(90,96,112,.2);}
.mc-pct{font-family:var(--mono);font-size:17px;font-weight:600;}
.mc-check{display:flex;justify-content:space-between;align-items:center;padding:2px 0;}
.mc-check .lbl{font-family:var(--mono);font-size:9px;color:var(--muted);}
.mc-check .val{font-family:var(--mono);font-size:9px;font-weight:600;}
.mc-bitem{background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:5px 7px;}
.mc-bitem .bl{font-family:var(--mono);font-size:8px;color:var(--muted);margin-bottom:2px;}
.mc-bitem .bv{font-family:var(--mono);font-size:11px;font-weight:600;}
.mc-sub{font-family:var(--mono);font-size:9px;color:var(--muted);margin-bottom:8px;}
.mc-chart{height:52px;}
.mc-chart svg{width:100%;height:100%;}

/* â•â• PERF TABLE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ptable{width:100%;border-collapse:collapse;font-family:var(--mono);font-size:10px;}
.ptable th{padding:6px 7px;font-size:8px;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;border-bottom:1px solid var(--border);text-align:center;font-weight:500;}
.ptable td{padding:5px 7px;text-align:center;border-bottom:1px solid rgba(125,130,145,.12);}
.ptable tr:last-child td{border-bottom:none;}
.bdg{display:inline-block;padding:1px 6px;border-radius:3px;font-size:8px;font-weight:600;}
.bp{background:rgba(0,208,132,.15);color:var(--green);}
.bn{background:rgba(255,68,102,.12);color:var(--red);}
.bu{background:rgba(90,96,112,.18);color:var(--muted);}
.tlo{display:grid;grid-template-columns:repeat(6,1fr);padding:7px;gap:3px;border-top:1px solid var(--border);}
.tlo-c{text-align:center;}
.tlo-c .lbl{font-family:var(--mono);font-size:7px;color:var(--muted);margin-bottom:2px;}
.tlo-c .val{font-family:var(--mono);font-size:9px;margin-bottom:2px;}

/* â•â• TREND STATUS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ts{width:100%;border-collapse:collapse;font-family:var(--mono);font-size:10px;}
.ts th{padding:6px 6px;font-size:8px;color:var(--muted);text-transform:uppercase;border-bottom:1px solid var(--border);text-align:center;font-weight:500;}
.ts th:first-child{text-align:left;}
.ts td{padding:5px 6px;text-align:center;border-bottom:1px solid rgba(125,130,145,.1);font-size:9px;}
.ts tr:last-child td{border-bottom:none;}
.ts td:first-child{text-align:left;color:var(--muted);font-size:8px;}
.ty{color:var(--green);font-weight:600;} .tn{color:var(--red);font-weight:600;}

/* â•â• POWER TREND / FACTORS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ptb,.fb{padding:8px 11px;}
.ptr,.fr{display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid rgba(125,130,145,.1);}
.ptr:last-child,.fr:last-child{border-bottom:none;}
.ptr .lbl,.fr .lbl{font-family:var(--mono);font-size:9px;color:var(--muted);}
.ptr .val,.fr .val{font-family:var(--mono);font-size:10px;font-weight:600;}
.vno{color:var(--red);} .vyes{color:var(--green);} .vnum{color:var(--text);}

/* â•â• RS GAINERS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.rss{padding:8px;}
.rsi{display:flex;align-items:center;gap:7px;padding:5px 4px;border-radius:5px;transition:background .15s;cursor:pointer;}
.rsi:hover{background:var(--surface2);}
.rsb{font-family:var(--mono);font-size:9px;font-weight:600;padding:2px 4px;border-radius:3px;min-width:44px;text-align:center;flex-shrink:0;}
.r100{background:rgba(0,208,132,.15);color:var(--green);border:1px solid rgba(0,208,132,.3);}
.r65{background:rgba(245,200,66,.15);color:var(--yellow);border:1px solid rgba(245,200,66,.3);}
.r50{background:rgba(255,68,102,.1);color:var(--red);border:1px solid rgba(255,68,102,.2);}
.ri{flex:1;}
.ri .tn2{font-family:var(--mono);font-size:11px;font-weight:500;}
.ri .sc{font-size:9px;color:var(--muted);}
.rr{text-align:right;}
.rr .rp{font-family:var(--mono);font-size:11px;font-weight:500;}
.rr .rc{font-family:var(--mono);font-size:10px;font-weight:600;}
.slbl{font-family:var(--mono);font-size:8px;color:var(--muted);letter-spacing:.1em;text-transform:uppercase;padding:6px 4px 3px;}

/* â•â• SECTOR TABLE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tw{overflow-x:auto;-webkit-overflow-scrolling:touch;}
table{width:100%;border-collapse:collapse;font-family:var(--mono);font-size:10px;}
thead th{padding:6px 8px;text-align:left;font-size:8px;letter-spacing:.08em;color:var(--muted);text-transform:uppercase;font-weight:500;border-bottom:1px solid var(--border);white-space:nowrap;}
tbody tr{border-bottom:1px solid rgba(125,130,145,.1);transition:background .15s;cursor:pointer;}
tbody tr:hover{background:var(--surface2);}
tbody tr:last-child{border-bottom:none;}
td{padding:6px 8px;white-space:nowrap;}
.rsc{font-weight:600;font-size:9px;width:30px;height:20px;display:flex;align-items:center;justify-content:center;border-radius:3px;}
.rh{background:rgba(0,208,132,.2);color:var(--green);}
.rm{background:rgba(245,200,66,.15);color:var(--yellow);}
.rl{background:rgba(255,68,102,.12);color:var(--red);}
.rvl{background:rgba(255,68,102,.07);color:var(--red);opacity:.7;}
.tck{color:var(--blue);font-weight:500;font-size:10px;}
.tname{color:var(--text);font-family:var(--sans);font-size:10px;}
.nc{text-align:right;}

/* â•â• TAG GRIDS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tg{padding:9px;display:flex;flex-wrap:wrap;gap:5px;}
.tag{font-family:var(--mono);font-size:10px;padding:3px 7px;border-radius:3px;background:var(--surface2);border:1px solid var(--border);color:var(--text);transition:all .15s;cursor:pointer;position:relative;}
.tag:hover{border-color:var(--accent);color:var(--accent);}
.thl{background:rgba(0,208,132,.1);border-color:rgba(0,208,132,.3);color:var(--green);}
.tyw{background:rgba(245,200,66,.1);border-color:rgba(245,200,66,.25);color:var(--yellow);}
.tip{position:absolute;bottom:calc(100% + 4px);left:50%;transform:translateX(-50%);background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:2px 6px;font-size:9px;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .15s;z-index:10;}
.tag:hover .tip{opacity:1;}

/* â•â• ERROR BANNER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.err{background:rgba(255,68,102,.08);border:1px solid rgba(255,68,102,.2);border-radius:6px;padding:8px 12px;margin-bottom:10px;font-family:var(--mono);font-size:10px;color:var(--red);display:none;}
.err.show{display:block;}

/* â•â• SKELETON â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sk{background:linear-gradient(90deg,var(--surface2) 25%,var(--border) 50%,var(--surface2) 75%);background-size:200% 100%;animation:shimmer 1.4s infinite;border-radius:3px;display:inline-block;}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

/* â•â• MOBILE RESPONSIVE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width:1400px){.r1{grid-template-columns:185px 225px 1fr 175px}}
@media(max-width:1200px){.r1{grid-template-columns:1fr 1fr;}.r1 .pnl:nth-child(3){grid-column:1/-1;}}
@media(max-width:1024px){.r2{grid-template-columns:1fr;}.r3{grid-template-columns:1fr 1fr;}}

@media(max-width:768px){
  .idx{grid-template-columns:repeat(4,1fr);}
  .r1,.r3{grid-template-columns:1fr 1fr;}
  .r1 .pnl{grid-column:auto;}
  .hdr-right .dt{display:none;}
}
@media(max-width:540px){
  .idx{grid-template-columns:repeat(2,1fr);}
  .r1,.r2,.r3{grid-template-columns:1fr;}
  body{padding:10px 10px calc(env(safe-area-inset-bottom,10px) + 10px);}
  .hdr h1 .label{display:none;}
}
</style>
</head>
<body>

<!-- â”€â”€ Login Screen â”€â”€ -->
<div id="loginScreen">
  <div class="login-box">
    <div class="login-logo">
      <span>ğŸ“ˆ Markets</span>
      DASHBOARD
    </div>
    <input type="password" id="pwInput" placeholder="API Key eingebenâ€¦" autocomplete="current-password">
    <button class="login-btn" onclick="doLogin()">Anmelden</button>
    <div class="login-err" id="loginErr"></div>
  </div>
</div>

<!-- â”€â”€ Main App â”€â”€ -->
<div id="app" style="display:none">

  <div class="hdr">
    <h1><span class="label">Market </span>Dashboard</h1>
    <div class="hdr-right">
      <span class="last-upd" id="lastUpd"></span>
      <div class="pill loading" id="pill" onclick="refreshAll()">
        <span class="dot pulse" id="pillDot"></span>
        <span id="pillTxt">Loadingâ€¦</span>
      </div>
      <button class="th-btn" id="thBtn" onclick="toggleTheme()" title="Dark/Light Mode">ğŸŒ™</button>
      <div class="dt" id="dtEl"></div>
    </div>
  </div>

  <div class="err" id="errBanner">âš  API nicht erreichbar â€” statische Fallback-Daten</div>

  <div class="idx" id="idxRow"></div>

  <div class="r1">
    <!-- Market Conditions -->
    <div class="pnl">
      <div class="ph"><h3>Market Conditions</h3></div>
      <div class="mc">
        <div class="mc-row">
          <div class="mc-badge neg" id="mcBadge">â€”</div>
          <div class="mc-score" id="mcScore" style="font-family:var(--mono);font-size:10px;color:var(--muted);">0/4</div>
        </div>
        <div class="mc-checks" id="mcChecks" style="margin-top:8px;display:flex;flex-direction:column;gap:4px;"></div>
        <div style="border-top:1px solid var(--border);margin-top:8px;padding-top:8px;">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;" id="mcBreadth"></div>
        </div>
      </div>
    </div>

    <!-- Performance -->
    <div class="pnl">
      <div class="ph"><h3>Performance Overview</h3></div>
      <table class="ptable">
        <thead><tr><th>YTD</th><th>1W</th><th>1M</th><th>1Y</th><th>52W Hi</th><th>VIX</th></tr></thead>
        <tbody>
          <tr id="perfR"><td colspan="6" style="text-align:center"><span class="sk" style="width:85%;height:11px"></span></td></tr>
          <tr id="perfB"><td colspan="6"></td></tr>
        </tbody>
      </table>
      <div class="tlo" id="tloRow">
        <div class="tlo-c"><div class="lbl">10SMA</div><div class="val sk" style="width:38px;height:10px"></div></div>
        <div class="tlo-c"><div class="lbl">20SMA</div><div class="val sk" style="width:38px;height:10px"></div></div>
        <div class="tlo-c"><div class="lbl">50SMA</div><div class="val sk" style="width:38px;height:10px"></div></div>
        <div class="tlo-c"><div class="lbl">200SMA</div><div class="val sk" style="width:38px;height:10px"></div></div>
        <div class="tlo-c"><div class="lbl">20&gt;50</div><div class="val sk" style="width:38px;height:10px"></div></div>
        <div class="tlo-c"><div class="lbl">50&gt;200</div><div class="val sk" style="width:38px;height:10px"></div></div>
      </div>
    </div>

    <!-- Trend Status -->
    <div class="pnl">
      <div class="ph"><h3>Trend Status</h3></div>
      <table class="ts">
        <thead><tr><th>Signal</th><th>SPY</th><th>RSP</th><th>QQQ</th><th>QQQE</th></tr></thead>
        <tbody id="trendTbl"></tbody>
      </table>
    </div>

    <!-- Power Trend -->
    <div class="pnl">
      <div class="ph"><h3>Power Trend (QQQ)</h3></div>
      <div class="ptb" id="ptEl"></div>
    </div>

    <!-- Factors -->
    <div class="pnl">
      <div class="ph"><h3>Factors vs SP500</h3></div>
      <div class="fb" id="facEl"></div>
    </div>
  </div>

  <div class="r2">
    <div class="pnl">
      <div class="ph"><h3>RS Gainers</h3></div>
      <div class="rss" id="rsEl"></div>
    </div>
    <div class="pnl">
      <div class="ph"><h3>Sector Leaders</h3></div>
      <div class="tw"><table>
        <thead><tr><th>RS</th><th>Ticker</th><th>Name</th><th class="nc">Day%</th><th class="nc">Wk%</th><th class="nc">Mth%</th><th class="nc">RS Day%</th><th class="nc">RS Wk%</th><th class="nc">RS Mth%</th><th class="nc">52W Hi</th></tr></thead>
        <tbody id="secTbl"></tbody>
      </table></div>
    </div>
  </div>

  <div class="r3">
    <div class="pnl"><div class="ph"><h3>21EMA Watch</h3></div><div class="tg" id="emaEl"></div></div>
    <div class="pnl"><div class="ph"><h3>Healthy Charts</h3></div><div class="tg" id="hcEl"></div></div>
    <div class="pnl"><div class="ph"><h3>Momentum 97</h3></div><div class="tg" id="m97El"></div></div>
  </div>

  <div class="r3">
    <div class="pnl"><div class="ph"><h3>4% Gainers (1D)</h3></div><div class="tg" id="g4El"></div></div>
    <div class="pnl"><div class="ph"><h3>Vol Up Gainers (1D)</h3></div><div class="tg" id="vgEl"></div></div>
    <div class="pnl"><div class="ph"><h3>High Est. EPS Growth</h3></div><div class="tg" id="epsEl"></div></div>
  </div>

</div><!-- /#app -->

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Hybrid: Finnhub (quotes) + Yahoo Finance (candles)
//  Kein Backend, kein Proxy â€” direkt im Browser
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const REFRESH = 5 * 60 * 1000;
let FKEY = '';

// â”€â”€ Kill old service workers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.getRegistrations().then(r => r.forEach(sw => sw.unregister()));
  if (window.caches) caches.keys().then(ks => ks.forEach(k => caches.delete(k)));
}

// â”€â”€ Theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleTheme() {
  const html = document.documentElement;
  const next = html.dataset.theme === 'dark' ? 'light' : 'dark';
  html.dataset.theme = next;
  localStorage.setItem('theme', next);
  document.getElementById('thBtn').textContent = next === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
  document.getElementById('themeColorMeta').content = next === 'dark' ? '#0a0b0e' : '#f0f2f5';
}
const savedTheme = localStorage.getItem('theme') || 'dark';
document.documentElement.dataset.theme = savedTheme;
document.getElementById('thBtn').textContent = savedTheme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';

// â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doLogin() {
  const pw = document.getElementById('pwInput').value.trim();
  const err = document.getElementById('loginErr');
  if (!pw) { err.textContent = 'Bitte Finnhub API Key eingeben'; return; }
  err.textContent = 'Verbindeâ€¦';
  verifyKey(pw);
}
document.getElementById('pwInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') doLogin();
});

async function verifyKey(key) {
  const err = document.getElementById('loginErr');
  try {
    const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=SPY&token=${key}`);
    const data = await res.json();
    if (data && data.c > 0) {
      FKEY = key;
      localStorage.setItem('fh_key', key);
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('app').style.display = 'block';
      setTimeout(() => document.getElementById('loginScreen').style.display = 'none', 350);
      init();
    } else {
      err.textContent = 'UngÃ¼ltiger API Key';
    }
  } catch(e) { err.textContent = 'Verbindungsfehler â€” prÃ¼fe Key'; }
}

const savedKey = localStorage.getItem('fh_key');
if (savedKey) { FKEY = savedKey; verifyKey(savedKey); }

// â”€â”€ Data Sources â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Finnhub: real-time quotes (free tier, all symbols)
async function fhQuote(sym) {
  const r = await fetch(`https://finnhub.io/api/v1/quote?symbol=${sym}&token=${FKEY}`);
  return r.json();
}

// Yahoo Finance: candles (works from browser, no auth)
async function yhCandles(sym, range='1y') {
  const s = sym === 'BTC' ? 'BTC-USD' : sym;
  const r = await fetch(
    `https://query1.finance.yahoo.com/v8/finance/chart/${s}?interval=1d&range=${range}`,
    { headers: { 'Accept': 'application/json' } }
  );
  const d = await r.json();
  const q = d?.chart?.result?.[0];
  if (!q) return null;
  return { t: q.timestamp, c: q.indicators.quote[0].close.map(v => v ?? null) };
}

function clean(arr) { return arr ? arr.filter(v => v != null) : []; }

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setStatus(state, text) {
  document.getElementById('pill').className = `pill ${state}`;
  document.getElementById('pillDot').className = `dot${state==='live'?' pulse':''}`;
  document.getElementById('pillTxt').textContent = text;
}
function pct(v, d=2) {
  if (v==null||isNaN(v)) return 'â€”';
  return `<span class="${v>=0?'up':'dn'}">${v>=0?'+':''}${v.toFixed(d)}%</span>`;
}
function bdg(v) {
  if (v==null) return '<span class="bdg bu">â€”</span>';
  if (v>0) return '<span class="bdg bp">Positive</span>';
  if (v<0) return '<span class="bdg bn">Negative</span>';
  return '<span class="bdg bu">Neutral</span>';
}
function rsClass(rs) {
  if (rs>=80) return 'rh'; if (rs>=60) return 'rm'; if (rs>=40) return 'rl'; return 'rvl';
}
function sma(arr, n) {
  const s = arr.slice(-n); return s.reduce((a,b)=>a+b,0)/s.length;
}
function emaCalc(arr, n) {
  const k=2/(n+1); let e=arr[0];
  for (let i=1;i<arr.length;i++) e=arr[i]*k+e*(1-k);
  return e;
}

document.getElementById('dtEl').textContent =
  new Date().toLocaleDateString('en-US',{weekday:'short',year:'numeric',month:'short',day:'numeric'});

// â”€â”€ Index Cards (Finnhub real-time) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const INDICES = [
  {sym:'SPY',  fh:'SPY',             name:'S&P 500'},
  {sym:'RSP',  fh:'RSP',             name:'S&P 500 EQ WT'},
  {sym:'QQQ',  fh:'QQQ',             name:'NASDAQ 100'},
  {sym:'QQQE', fh:'QQQE',            name:'NASDAQ 100 EQ WT'},
  {sym:'IWM',  fh:'IWM',             name:'RUSSELL 2000'},
  {sym:'VIX',  fh:'VIX',             name:'VOLATILITY'},
  {sym:'BTC',  fh:'BINANCE:BTCUSDT', name:'BITCOIN'},
];

async function loadIndices() {
  const quotes = await Promise.allSettled(INDICES.map(i => fhQuote(i.fh)));
  const row = document.getElementById('idxRow');
  row.innerHTML = '';
  const result = {};
  INDICES.forEach((idx, i) => {
    const q = quotes[i].status==='fulfilled' ? quotes[i].value : null;
    const price = q?.c || 0;
    const prev  = q?.pc || 0;
    const chg   = prev>0 ? (price-prev)/prev*100 : 0;
    const cls   = chg>=0?'up':'dn';
    const pstr  = idx.sym==='BTC' ? '$'+Math.round(price).toLocaleString() : '$'+price.toFixed(2);
    row.innerHTML += `<div class="ic" style="animation-delay:${i*.05}s">
      <div class="tk">${idx.sym}</div><div class="pr">${pstr}</div>
      <div class="ch ${cls}">${chg>=0?'+':''}${chg.toFixed(2)}%</div>
      <div class="nm">${idx.name}</div></div>`;
    result[idx.sym] = {price, chg};
  });
  return result;
}

// â”€â”€ Performance + SMA Overview (Yahoo Finance) â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPerf() {
  try {
    const d = await yhCandles('SPY', '2y');
    if (!d) return null;
    const c = clean(d.c);
    const price = c[c.length-1];
    const now = new Date();
    const ytdStart = c[c.length - Math.min(c.length, 252 - Math.floor((now - new Date(now.getFullYear(),0,1))/86400000))];
    const wk  = c[c.length-6]  || c[0];
    const mth = c[c.length-22] || c[0];
    const yr  = c[c.length-252]|| c[0];
    const h52 = Math.max(...c.slice(-252));
    const vixQ = await fhQuote('VIX');
    const s10=sma(c,10), s20=sma(c,20), s50=sma(c,50), s200=sma(c,200);
    return {
      ytd:(price/ytdStart-1)*100, w1:(price/wk-1)*100,
      m1:(price/mth-1)*100, y1:(price/yr-1)*100,
      h52w:(price/h52-1)*100, vix:vixQ?.c||null,
      price, h52, closes:c,
      s10,s20,s50,s200,
      spyDayPct:(price/c[c.length-2]-1)*100,
      spyWkPct: (price/wk-1)*100,
      spyMthPct:(price/mth-1)*100,
    };
  } catch(e) { console.error('Perf error',e); return null; }
}

function renderPerf(p) {
  if (!p) return;
  const f = v => v!=null ? `${v>=0?'+':''}${v.toFixed(2)}%` : 'â€”';
  document.getElementById('perfR').innerHTML = `
    <td>${f(p.ytd)}</td><td>${f(p.w1)}</td><td>${f(p.m1)}</td>
    <td>${f(p.y1)}</td><td>${f(p.h52w)}</td>
    <td>${p.vix!=null?p.vix.toFixed(2):'â€”'}</td>`;
  document.getElementById('perfB').innerHTML =
    `<td>${bdg(p.ytd)}</td><td>${bdg(p.w1)}</td><td>${bdg(p.m1)}</td><td>${bdg(p.y1)}</td><td>${bdg(p.h52w)}</td><td><span class="bdg bu">â€”</span></td>`;
  // Market conditions updated via loadMarketConditions()
  // SMA overview
  const {s10,s20,s50,s200,price}=p;
  const mk=(s,n,lbl)=>`<div class="tlo-c"><div class="lbl">${lbl}</div><div class="val">${s.toFixed(0)}</div><div class="bdg ${price>s?'bp':'bn'}" style="font-size:7px;padding:1px 4px">${price>s?'â–²':'â–¼'}</div></div>`;
  const p2050=((s20/s50-1)*100).toFixed(1)+'%', p50200=((s50/s200-1)*100).toFixed(1)+'%';
  document.getElementById('tloRow').innerHTML =
    mk(s10,10,'10SMA')+mk(s20,20,'20SMA')+mk(s50,50,'50SMA')+mk(s200,200,'200SMA')+
    `<div class="tlo-c"><div class="lbl">20>50</div><div class="val">${p2050}</div><div class="bdg ${s20>s50?'bp':'bn'}" style="font-size:7px;padding:1px 4px">${s20>s50?'Yes':'No'}</div></div>`+
    `<div class="tlo-c"><div class="lbl">50>200</div><div class="val">${p50200}</div><div class="bdg ${s50>s200?'bp':'bn'}" style="font-size:7px;padding:1px 4px">${s50>s200?'Yes':'No'}</div></div>`;
}

// â”€â”€ Trend Status (Yahoo Finance candles) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadTrend() {
  const syms=['SPY','RSP','QQQ','QQQE'];
  const candles = await Promise.allSettled(syms.map(s => yhCandles(s,'1y')));
  const result={};
  syms.forEach((sym,i)=>{
    const d=candles[i].status==='fulfilled'?candles[i].value:null;
    if(!d) return;
    const c=clean(d.c); if(c.length<50) return;
    const price=c[c.length-1];
    const e9=emaCalc(c.slice(-50),9), e21=emaCalc(c.slice(-100),21);
    const e50=emaCalc(c.slice(-200),50), e200=emaCalc(c,200);
    const h52=Math.max(...c.slice(-252));
    result[sym]={
      ema9:(price-e9)/e9*100, ema21:(price-e21)/e21*100,
      ema50:(price-e50)/e50*100, ema200:(price-e200)/e200*100,
      d3ema21: c.slice(-3).every(v=>v>emaCalc(c.slice(-100),21)),
      w52h:(price-h52)/h52*100,
    };
  });
  return result;
}

const TREND_LABELS=[['ema9','9 EMA'],['ema21','21 EMA'],['ema50','50 EMA'],['ema200','200 EMA'],['d3ema21','3D>21 EMA'],['w52h','52W High']];

function renderTrend(data) {
  const tb=document.getElementById('trendTbl'); tb.innerHTML='';
  if(!data) return;
  TREND_LABELS.forEach(([key,label])=>{
    const tr=document.createElement('tr');
    let cells=`<td>${label}</td>`;
    ['SPY','RSP','QQQ','QQQE'].forEach(t=>{
      const v=data[t]?data[t][key]:null;
      if(v==null){cells+=`<td>â€”</td>`;return;}
      if(typeof v==='boolean') cells+=`<td class="${v?'ty':'tn'}">${v?'Yes':'No'}</td>`;
      else cells+=`<td class="${v>=0?'up':'dn'}">${v>=0?'+':''}${v.toFixed(2)}%</td>`;
    });
    tr.innerHTML=cells; tb.appendChild(tr);
  });
}

// â”€â”€ Power Trend (Yahoo Finance QQQ candles) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPT() {
  try {
    const d=await yhCandles('QQQ','1y');
    if(!d) return null;
    const c=clean(d.c);
    const avg3=(c[c.length-1]+c[c.length-2]+c[c.length-3])/3;
    const s20=sma(c,20),s50=sma(c,50),s200=sma(c,200);
    return {sma3d20:avg3>s20,sma3d50:avg3>s50,sma3d200:avg3>s200,sma20_50:s20>s50,sma20_200:s20>s200,sma50_200:s50>s200};
  } catch(e){return null;}
}

async function loadYields() {
  try {
    const [t10,t2]=await Promise.all([yhCandles('%5ETNX','5d'),yhCandles('%5EIRX','5d')]);
    return {y10:t10?clean(t10.c).slice(-1)[0]:null, y2:t2?clean(t2.c).slice(-1)[0]:null};
  } catch(e){return {};}
}

function renderPT(data, yields) {
  const el=document.getElementById('ptEl'); el.innerHTML='';
  const rows=[['sma3d20','3D > 20 SMA'],['sma3d50','3D > 50 SMA'],['sma3d200','3D > 200 SMA'],['sma20_50','20 > 50 SMA'],['sma20_200','20 > 200 SMA'],['sma50_200','50 > 200 SMA']];
  rows.forEach(([k,l])=>{
    const d=document.createElement('div'); d.className='ptr';
    const v=data?data[k]:null;
    d.innerHTML=`<span class="lbl">${l}</span><span class="val ${v==null?'vnum':v?'vyes':'vno'}">${v==null?'â€”':v?'Yes':'No'}</span>`;
    el.appendChild(d);
  });
  [['y10','US 10Y Yield'],['y2','US 02Y Yield']].forEach(([k,l])=>{
    const d=document.createElement('div'); d.className='ptr';
    const v=yields?yields[k]:null;
    d.innerHTML=`<span class="lbl">${l}</span><span class="val vnum">${v!=null?v.toFixed(2):'â€”'}</span>`;
    el.appendChild(d);
  });
}

// â”€â”€ Factors vs SP500 (Yahoo Finance) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FACTORS=[{sym:'IVW',label:'Growth'},{sym:'IVE',label:'Value'},{sym:'HDV',label:'High Dividend'},{sym:'OEF',label:'Large-Cap'},{sym:'IJH',label:'Mid-Cap'},{sym:'IJR',label:'Small-Cap'},{sym:'MTUM',label:'Momentum'},{sym:'IPO',label:'IPOs'}];

async function loadFactors(spyMth) {
  const candles=await Promise.allSettled(FACTORS.map(f=>yhCandles(f.sym,'1mo')));
  return FACTORS.map((f,i)=>{
    const d=candles[i].status==='fulfilled'?candles[i].value:null;
    if(!d){return{label:f.label,val:0};}
    const c=clean(d.c); if(c.length<2) return{label:f.label,val:0};
    const mth=(c[c.length-1]/c[0]-1)*100;
    return{label:f.label,val:+(mth-spyMth).toFixed(2)};
  });
}

function renderFac(data) {
  const el=document.getElementById('facEl'); el.innerHTML='';
  data.forEach(r=>{
    const d=document.createElement('div'); d.className='fr';
    d.innerHTML=`<span class="lbl">${r.label}</span><span class="val ${r.val>=0?'up':'dn'}">${r.val>=0?'+':''}${r.val.toFixed(2)}%</span>`;
    el.appendChild(d);
  });
}

// â”€â”€ Sectors (Yahoo Finance) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SECTORS={RSPG:'Energy',RSPN:'Industrials',RSPU:'Utilities',RSPH:'Health Care',RSPR:'Real Estate',RSPM:'Materials',RSPS:'Cons Stpl',RSPC:'Comm Svcs',RSPD:'Cons Disc',RSPT:'Technology',RSPF:'Financials'};

async function loadSectors(spyDay,spyWk,spyMth) {
  const entries=Object.entries(SECTORS);
  const candles=await Promise.allSettled(entries.map(([sym])=>yhCandles(sym,'6mo')));
  const result={};
  entries.forEach(([sym,name],i)=>{
    const d=candles[i].status==='fulfilled'?candles[i].value:null;
    if(!d) return;
    const c=clean(d.c); if(c.length<5) return;
    const price=c[c.length-1];
    const day=(price/c[c.length-2]-1)*100;
    const wk=c.length>6?(price/c[c.length-6]-1)*100:0;
    const mth=c.length>22?(price/c[c.length-22]-1)*100:0;
    const h52=Math.max(...c.slice(-252));
    const rs=Math.min(100,Math.max(0,Math.round(50+(mth-spyMth)*3)));
    result[sym]={name,price:price.toFixed(2),day:+day.toFixed(2),wk:+wk.toFixed(2),mth:+mth.toFixed(2),rs_day:+(day-spyDay).toFixed(2),rs_wk:+(wk-spyWk).toFixed(2),rs_mth:+(mth-spyMth).toFixed(2),high52:+((price/h52-1)*100).toFixed(2),rs};
  });
  return result;
}

function rsGB(rs){return rs>=80?'r100':rs>=60?'r65':'r50';}

function renderSectors(data) {
  const tb=document.getElementById('secTbl'); tb.innerHTML='';
  const rsEl=document.getElementById('rsEl'); rsEl.innerHTML='';
  const sorted=Object.entries(data).sort((a,b)=>b[1].rs-a[1].rs);
  sorted.forEach(([sym,s])=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><div class="rsc ${rsClass(s.rs)}">${s.rs}</div></td><td class="tck">${sym}</td><td class="tname">${s.name}</td><td class="nc">${pct(s.day,1)}</td><td class="nc">${pct(s.wk,1)}</td><td class="nc">${pct(s.mth,1)}</td><td class="nc">${pct(s.rs_day)}</td><td class="nc">${pct(s.rs_wk)}</td><td class="nc">${pct(s.rs_mth)}</td><td class="nc"><span class="${s.high52<-3?'dn':s.high52<0?'':'up'}">${s.high52.toFixed(1)}%</span></td>`;
    tb.appendChild(tr);
  });
  const topD=[...sorted].slice(0,3);
  const topW=[...sorted].sort((a,b)=>b[1].wk-a[1].wk).slice(0,3);
  const card=(sym,s,val,cls)=>`<div class="rsi"><div class="rsb ${rsGB(s.rs)}">RS:${s.rs}</div><div class="ri"><div class="tn2">${sym}</div><div class="sc">${s.name}</div></div><div class="rr"><div class="rp">$${s.price}</div><div class="rc ${cls}">${val>=0?'+':''}${val.toFixed(2)}%</div></div></div>`;
  rsEl.innerHTML='<div class="slbl">Daily</div>'+topD.map(([sym,s])=>card(sym,s,s.day,s.day>=0?'up':'dn')).join('')+'<div class="slbl">Weekly</div>'+topW.map(([sym,s])=>card(sym,s,s.wk,s.wk>=0?'up':'dn')).join('');
}

// â”€â”€ Screener Tags (Finnhub real-time) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SCREENERS={
  emaEl:  ['WSC','AESI','NCLH','LRCX','ASO','VFC','FFIV','CAVA','STNE','BWXT','CAKE','REZI','FLEX','BVN','APH','CALX','MGM','RUN','SMCI'],
  hcEl:   ['CIEN','LITE','AAOI','SNDK','WDC','LRCX','TER','AMAT','AU','BVN','SSRM','BORR','RIG','COHR','ATI','CENX','GLW'],
  m97El:  ['HLF','FSLY','ZIM','CLMT','CGNX','KTOS','IRDM','RELY','SMCI','NVDA','ARM','PLTR'],
  g4El:   ['RELY','HLF','SSRM','SMCI','AAOI','LITE','PWR','XP','CDE','NGD','PAAS','SA','AGI','RIOT','CENX','CALX'],
  vgEl:   ['RELY','HLF','SSRM','KRMN','KTOS','XP','CENX','FLR','EBAY','DASH','AKAM'],
  epsEl:  ['CIEN','LITE','MU','WDC','TER','APH','VRT','FN','CRDO','EQT','CALX','NET','NVDA'],
};

async function loadScreener(tickers) {
  const quotes=await Promise.allSettled(tickers.map(t=>fhQuote(t)));
  return tickers.map((t,i)=>{
    const q=quotes[i].status==='fulfilled'?quotes[i].value:null;
    const chg=q&&q.pc>0?(q.c-q.pc)/q.pc*100:0;
    return{ticker:t,change_pct:+chg.toFixed(2)};
  }).sort((a,b)=>b.change_pct-a.change_pct);
}

function renderScreener(elId,data) {
  const el=document.getElementById(elId); el.innerHTML='';
  data.forEach(item=>{
    const s=document.createElement('span');
    s.className='tag'+(item.change_pct>=4?' thl':item.change_pct>=1?' tyw':'');
    s.innerHTML=`${item.ticker}<span class="tip">${item.change_pct>=0?'+':''}${item.change_pct.toFixed(2)}%</span>`;
    el.appendChild(s);
  });
}


// â”€â”€ Market Conditions (PTMM-style) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadMarketConditions(spyCloses) {
  const badge  = document.getElementById('mcBadge');
  const score  = document.getElementById('mcScore');
  const checks = document.getElementById('mcChecks');
  const breadth= document.getElementById('mcBreadth');

  // Fetch breadth symbols from Yahoo Finance
  const [nymo, nasi, nya50r, nya200r, nyhl] = await Promise.allSettled([
    yhCandles('%5ENYMO',  '3mo'),   // McClellan Oscillator
    yhCandles('%5ENASI',  '3mo'),   // McClellan Summation
    yhCandles('%5ENYA50R','5d'),    // % above 50 SMA
    yhCandles('%5ENYA200R','5d'),   // % above 200 SMA
    yhCandles('%5ENYHL',  '5d'),    // Net New Highs/Lows
  ]);

  const get = (r) => {
    if (r.status !== 'fulfilled' || !r.value) return null;
    const c = clean(r.value.c);
    return c.length ? c[c.length-1] : null;
  };

  const moVal   = get(nymo);
  const siVal   = get(nasi);
  const p50Val  = get(nya50r);
  const p200Val = get(nya200r);
  const hlVal   = get(nyhl);

  // SPY EMA checks from candle data
  const c = spyCloses;
  const price  = c[c.length-1];
  const e21    = emaCalc(c.slice(-100), 21);
  const s50    = sma(c, 50);
  const s200   = sma(c, 200);

  // PTMM-style conditions
  const conds = [
    { label: 'SPY > 21 EMA',        pass: price > e21,   val: `${((price/e21-1)*100).toFixed(2)}%`, required: true  },
    { label: 'SPY > 50 SMA',        pass: price > s50,   val: `${((price/s50-1)*100).toFixed(2)}%`, required: true  },
    { label: 'McClellan Summ. > 0', pass: siVal != null && siVal > 0, val: siVal != null ? siVal.toFixed(0) : 'â€”', required: false },
    { label: '% > 50 SMA > 60%',   pass: p50Val != null && p50Val > 60, val: p50Val != null ? p50Val.toFixed(1)+'%' : 'â€”', required: false },
  ];

  const passCount   = conds.filter(c => c.pass).length;
  const reqPass     = conds.filter(c => c.required).every(c => c.pass);
  const allPass     = passCount === 4;
  const nonePass    = passCount <= 1;

  // Determine status
  let status, cls;
  if (reqPass && passCount >= 3) { status='UPTREND';   cls='pos'; }
  else if (passCount <= 1)       { status='DOWNTREND'; cls='neg'; }
  else                           { status='MIXED';     cls='neu'; }

  badge.textContent = status;
  badge.className   = `mc-badge ${cls}`;
  score.textContent = `${passCount}/4`;

  // Render check rows
  checks.innerHTML = conds.map(c => `
    <div class="mc-check">
      <span class="lbl">${c.label}</span>
      <span class="val" style="display:flex;align-items:center;gap:5px;">
        <span style="font-size:9px;color:var(--muted)">${c.val}</span>
        <span class="${c.pass?'ty':'tn'}">${c.pass?'âœ“':'âœ—'}</span>
      </span>
    </div>`).join('');

  // Breadth boxes
  const bItems = [
    { label: 'McClellan Osc.',  val: moVal,   fmt: v => v.toFixed(0), cls: v => v>0?'up':'dn' },
    { label: 'McClellan Sum.',  val: siVal,   fmt: v => v.toFixed(0), cls: v => v>0?'up':'dn' },
    { label: '% > 50 SMA',     val: p50Val,  fmt: v => v.toFixed(1)+'%', cls: v => v>60?'up':v>40?'':'dn' },
    { label: '% > 200 SMA',    val: p200Val, fmt: v => v.toFixed(1)+'%', cls: v => v>60?'up':v>40?'':'dn' },
    { label: 'Net New Highs',  val: hlVal,   fmt: v => (v>0?'+':'')+v.toFixed(0), cls: v => v>0?'up':'dn' },
    { label: 'SPY vs 200 SMA', val: (price/s200-1)*100, fmt: v => (v>0?'+':'')+v.toFixed(2)+'%', cls: v => v>0?'up':'dn' },
  ];

  breadth.innerHTML = bItems.map(b => {
    const hasVal = b.val != null && !isNaN(b.val);
    const dispVal = hasVal ? b.fmt(b.val) : 'â€”';
    const dispCls = hasVal ? b.cls(b.val) : '';
    return `<div class="mc-bitem"><div class="bl">${b.label}</div><div class="bv ${dispCls}">${dispVal}</div></div>`;
  }).join('');
}

// â”€â”€ Main Refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function refreshAll() {
  setStatus('loading','Loadingâ€¦');
  document.getElementById('errBanner').classList.remove('show');
  try {
    // Batch 1: real-time index quotes + SPY performance candles
    const [_, perfData] = await Promise.all([loadIndices(), loadPerf()]);
    renderPerf(perfData);

    const spyMth=perfData?.spyMthPct||0;
    const spyDay=perfData?.spyDayPct||0;
    const spyWk=perfData?.spyWkPct||0;

    // Load market conditions with breadth data
    if (perfData?.closes) loadMarketConditions(perfData.closes).catch(console.error);

    // Batch 2: trend, power trend, yields, sectors, factors in parallel
    const [trend,pt,yields,sectors,factors] = await Promise.all([
      loadTrend(), loadPT(), loadYields(),
      loadSectors(spyDay,spyWk,spyMth),
      loadFactors(spyMth),
    ]);
    renderTrend(trend);
    renderPT(pt,yields);
    renderFac(factors);
    renderSectors(sectors);

    // Batch 3: screeners
    for (const [elId,tickers] of Object.entries(SCREENERS)) {
      renderScreener(elId, await loadScreener(tickers));
    }

    setStatus('live','Live Â· 5 min');
    document.getElementById('lastUpd').textContent =
      'Updated '+new Date().toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});
  } catch(e) {
    console.error(e);
    setStatus('error','Fehler');
    document.getElementById('errBanner').classList.add('show');
  }
}

function init() { refreshAll(); setInterval(refreshAll,REFRESH); }
</script>
</body>
</html>
