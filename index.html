<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Markets">
<meta name="theme-color" content="#0a0b0e" id="themeColorMeta">
<title>Market Dashboard</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CSS Variables â€” Dark & Light Theme
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --green:#00d084; --red:#ff4466; --yellow:#f5c842; --blue:#4d9fff; --accent:#7c6af7;
  --mono:'IBM Plex Mono',monospace; --sans:'IBM Plex Sans',sans-serif;
  --radius:8px; --gap:10px;
  --transition: background .25s, color .25s, border-color .25s;
}
[data-theme="dark"] {
  --bg:#0a0b0e; --surface:#111318; --surface2:#171b22; --border:#1e2330;
  --text:#e8eaf0; --muted:#5a6070; --th-btn:#1e2535;
}
[data-theme="light"] {
  --bg:#f0f2f5; --surface:#ffffff; --surface2:#f7f8fa; --border:#e2e6ed;
  --text:#1a1d24; --muted:#8a94a6; --th-btn:#e8ecf2;
  --green:#00a864; --red:#d63050; --yellow:#c8971a; --blue:#2b7fd4; --accent:#5c4fd6;
}

/* â”€â”€ Reset â”€â”€ */
*{margin:0;padding:0;box-sizing:border-box;}
body {
  background:var(--bg); color:var(--text);
  font-family:var(--sans); min-height:100vh;
  padding: env(safe-area-inset-top,12px) env(safe-area-inset-right,16px)
           env(safe-area-inset-bottom,16px) env(safe-area-inset-left,16px);
  transition: var(--transition);
}

/* â•â• LOGIN SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#loginScreen {
  position:fixed;inset:0;z-index:1000;
  background:var(--bg);
  display:flex;align-items:center;justify-content:center;
  flex-direction:column;gap:20px;
  transition:opacity .3s;
}
#loginScreen.hidden{opacity:0;pointer-events:none;}
.login-box {
  background:var(--surface);border:1px solid var(--border);
  border-radius:14px;padding:32px 28px;width:320px;max-width:90vw;
  box-shadow:0 20px 60px rgba(0,0,0,.4);
}
.login-logo {
  font-family:var(--mono);font-size:11px;letter-spacing:.2em;
  color:var(--muted);text-transform:uppercase;text-align:center;margin-bottom:24px;
}
.login-logo span{display:block;font-size:22px;letter-spacing:.05em;color:var(--text);margin-bottom:6px;}
.login-box input {
  width:100%;background:var(--surface2);border:1px solid var(--border);
  border-radius:7px;padding:11px 14px;color:var(--text);
  font-family:var(--mono);font-size:14px;outline:none;
  transition:border-color .2s;margin-bottom:12px;
}
.login-box input:focus{border-color:var(--accent);}
.login-box input::placeholder{color:var(--muted);}
.login-btn {
  width:100%;padding:11px;border:none;border-radius:7px;
  background:var(--accent);color:#fff;font-family:var(--mono);
  font-size:13px;font-weight:600;cursor:pointer;letter-spacing:.05em;
  transition:opacity .2s;
}
.login-btn:hover{opacity:.85;}
.login-err{color:var(--red);font-family:var(--mono);font-size:11px;text-align:center;height:14px;}

/* â•â• HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.hdr {
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:14px;padding-bottom:12px;border-bottom:1px solid var(--border);
  gap:10px;flex-wrap:wrap;
}
.hdr h1{font-family:var(--mono);font-size:13px;letter-spacing:.15em;color:var(--muted);text-transform:uppercase;}
.hdr-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.dt{font-family:var(--mono);font-size:12px;color:var(--muted);}
.last-upd{font-family:var(--mono);font-size:11px;color:var(--muted);}

/* Theme toggle */
.th-btn {
  width:32px;height:32px;border-radius:50%;border:1px solid var(--border);
  background:var(--th-btn);cursor:pointer;display:flex;align-items:center;
  justify-content:center;font-size:15px;transition:all .2s;flex-shrink:0;
}
.th-btn:hover{border-color:var(--accent);}

/* Status pill */
.pill {
  font-family:var(--mono);font-size:11px;padding:5px 12px;
  border-radius:10px;border:1px solid var(--border);
  color:var(--muted);display:flex;align-items:center;gap:5px;
  cursor:pointer;transition:all .2s;white-space:nowrap;
}
.pill:hover{border-color:var(--accent);}
.pill.live{border-color:rgba(0,208,132,.4);color:var(--green);}
.pill.error{border-color:rgba(255,68,102,.4);color:var(--red);}
.pill.loading{border-color:rgba(77,159,255,.4);color:var(--blue);}
.dot{width:6px;height:6px;border-radius:50%;background:currentColor;flex-shrink:0;}
.pulse{animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* â•â• INDEX CARDS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.idx{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-bottom:12px;}
.ic{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px 15px;transition:var(--transition),border-color .2s;cursor:pointer;}
.ic:hover{border-color:var(--accent);}
.ic .tk{font-family:var(--mono);font-size:11px;color:var(--muted);letter-spacing:.1em;margin-bottom:5px;}
.ic .pr{font-family:var(--mono);font-size:18px;font-weight:500;margin-bottom:4px;}
.ic .ch{font-family:var(--mono);font-size:12px;font-weight:600;margin-bottom:5px;}
.ic .nm{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;}
.up{color:var(--green);} .dn{color:var(--red);}

/* â•â• PANELS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.pnl{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;transition:var(--transition);}
.ph{padding:11px 15px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:7px;}
.ph::before{content:'';display:block;width:3px;height:12px;background:var(--accent);border-radius:2px;flex-shrink:0;}
.ph h3{font-family:var(--mono);font-size:11px;letter-spacing:.11em;text-transform:uppercase;font-weight:500;}

/* â•â• LAYOUT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.r1{display:grid;grid-template-columns:200px 240px 1fr 190px 220px;gap:var(--gap);margin-bottom:var(--gap);}
.r2{display:grid;grid-template-columns:250px 1fr;gap:var(--gap);margin-bottom:var(--gap);}
.r3{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--gap);margin-bottom:var(--gap);}

/* â•â• MARKET CONDITIONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.mc{padding:12px;}
.mc-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.mc-badge{font-family:var(--mono);font-size:14px;font-weight:600;padding:4px 12px;border-radius:4px;}
.mc-badge.neg{background:rgba(255,68,102,.15);color:var(--red);border:1px solid rgba(255,68,102,.3);}
.mc-badge.pos{background:rgba(0,208,132,.15);color:var(--green);border:1px solid rgba(0,208,132,.3);}
.mc-badge.neu{background:rgba(90,96,112,.2);color:var(--muted);border:1px solid rgba(90,96,112,.2);}
.mc-pct{font-family:var(--mono);font-size:17px;font-weight:600;}
.mc-sub{font-family:var(--mono);font-size:9px;color:var(--muted);margin-bottom:8px;}
.mc-chart{height:52px;}
.mc-chart svg{width:100%;height:100%;}

/* â•â• PERF TABLE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ptable{width:100%;border-collapse:collapse;font-family:var(--mono);font-size:12px;}
.ptable th{padding:7px 9px;font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;border-bottom:1px solid var(--border);text-align:center;font-weight:500;}
.ptable td{padding:7px 9px;text-align:center;border-bottom:1px solid rgba(125,130,145,.12);}
.ptable tr:last-child td{border-bottom:none;}
.bdg{display:inline-block;padding:2px 7px;border-radius:3px;font-size:10px;font-weight:600;}
.bp{background:rgba(0,208,132,.15);color:var(--green);}
.bn{background:rgba(255,68,102,.12);color:var(--red);}
.bu{background:rgba(90,96,112,.18);color:var(--muted);}
.tlo{display:grid;grid-template-columns:repeat(6,1fr);padding:7px;gap:3px;border-top:1px solid var(--border);}
.tlo-c{text-align:center;}
.tlo-c .lbl{font-family:var(--mono);font-size:9px;color:var(--muted);margin-bottom:3px;}
.tlo-c .val{font-family:var(--mono);font-size:11px;margin-bottom:3px;}

/* â•â• TREND STATUS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ts{width:100%;border-collapse:collapse;font-family:var(--mono);font-size:12px;}
.ts th{padding:8px 8px;font-size:10px;color:var(--muted);text-transform:uppercase;border-bottom:1px solid var(--border);text-align:center;font-weight:500;}
.ts th:first-child{text-align:left;}
.ts td{padding:7px 8px;text-align:center;border-bottom:1px solid rgba(125,130,145,.1);font-size:11px;}
.ts tr:last-child td{border-bottom:none;}
.ts td:first-child{text-align:left;color:var(--muted);font-size:10px;}
.ty{color:var(--green);font-weight:600;} .tn{color:var(--red);font-weight:600;}

/* â•â• POWER TREND / FACTORS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ptb,.fb{padding:8px 11px;}
.ptr,.fr{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid rgba(125,130,145,.1);}
.ptr:last-child,.fr:last-child{border-bottom:none;}
.ptr .lbl,.fr .lbl{font-family:var(--mono);font-size:11px;color:var(--muted);}
.ptr .val,.fr .val{font-family:var(--mono);font-size:13px;font-weight:600;}
.vno{color:var(--red);} .vyes{color:var(--green);} .vnum{color:var(--text);}

/* â•â• RS GAINERS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.rss{padding:8px;}
.rsi{display:flex;align-items:center;gap:7px;padding:5px 4px;border-radius:5px;transition:background .15s;cursor:pointer;}
.rsi:hover{background:var(--surface2);}
.rsb{font-family:var(--mono);font-size:11px;font-weight:600;padding:3px 6px;border-radius:3px;min-width:50px;text-align:center;flex-shrink:0;}
.r100{background:rgba(0,208,132,.15);color:var(--green);border:1px solid rgba(0,208,132,.3);}
.r65{background:rgba(245,200,66,.15);color:var(--yellow);border:1px solid rgba(245,200,66,.3);}
.r50{background:rgba(255,68,102,.1);color:var(--red);border:1px solid rgba(255,68,102,.2);}
.ri{flex:1;}
.ri .tn2{font-family:var(--mono);font-size:13px;font-weight:500;}
.ri .sc{font-size:11px;color:var(--muted);}
.rr{text-align:right;}
.rr .rp{font-family:var(--mono);font-size:13px;font-weight:500;}
.rr .rc{font-family:var(--mono);font-size:12px;font-weight:600;}
.slbl{font-family:var(--mono);font-size:10px;color:var(--muted);letter-spacing:.1em;text-transform:uppercase;padding:8px 4px 4px;}

/* â•â• SECTOR TABLE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tw{overflow-x:auto;-webkit-overflow-scrolling:touch;}
table{width:100%;border-collapse:collapse;font-family:var(--mono);font-size:12px;}
thead th{padding:8px 10px;text-align:left;font-size:10px;letter-spacing:.08em;color:var(--muted);text-transform:uppercase;font-weight:500;border-bottom:1px solid var(--border);white-space:nowrap;}
tbody tr{border-bottom:1px solid rgba(125,130,145,.1);transition:background .15s;cursor:pointer;}
tbody tr:hover{background:var(--surface2);}
tbody tr:last-child{border-bottom:none;}
td{padding:8px 10px;white-space:nowrap;}
.rsc{font-weight:600;font-size:11px;width:34px;height:22px;display:flex;align-items:center;justify-content:center;border-radius:3px;}
.rh{background:rgba(0,208,132,.2);color:var(--green);}
.rm{background:rgba(245,200,66,.15);color:var(--yellow);}
.rl{background:rgba(255,68,102,.12);color:var(--red);}
.rvl{background:rgba(255,68,102,.07);color:var(--red);opacity:.7;}
.tck{color:var(--blue);font-weight:500;font-size:12px;}
.tname{color:var(--text);font-family:var(--sans);font-size:12px;}
.nc{text-align:right;}

/* â•â• TAG GRIDS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tg{padding:9px;display:flex;flex-wrap:wrap;gap:5px;}
.tag{font-family:var(--mono);font-size:10px;padding:3px 7px;border-radius:3px;background:var(--surface2);border:1px solid var(--border);color:var(--text);transition:all .15s;cursor:pointer;position:relative;}
.tag:hover{border-color:var(--accent);color:var(--accent);}
.thl{background:rgba(0,208,132,.1);border-color:rgba(0,208,132,.3);color:var(--green);}
.tyw{background:rgba(245,200,66,.1);border-color:rgba(245,200,66,.25);color:var(--yellow);}
.tip{position:absolute;bottom:calc(100% + 4px);left:50%;transform:translateX(-50%);background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:2px 6px;font-size:9px;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .15s;z-index:10;}
.tag:hover .tip{opacity:1;}

/* â•â• ERROR BANNER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.err{background:rgba(255,68,102,.08);border:1px solid rgba(255,68,102,.2);border-radius:6px;padding:8px 12px;margin-bottom:10px;font-family:var(--mono);font-size:10px;color:var(--red);display:none;}
.err.show{display:block;}

/* â•â• SKELETON â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sk{background:linear-gradient(90deg,var(--surface2) 25%,var(--border) 50%,var(--surface2) 75%);background-size:200% 100%;animation:shimmer 1.4s infinite;border-radius:3px;display:inline-block;}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

/* â•â• MOBILE RESPONSIVE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width:1400px){.r1{grid-template-columns:185px 225px 1fr 175px}}
@media(max-width:1200px){.r1{grid-template-columns:1fr 1fr;}.r1 .pnl:nth-child(3){grid-column:1/-1;}}
@media(max-width:1024px){.r2{grid-template-columns:1fr;}.r3{grid-template-columns:1fr 1fr;}}

@media(max-width:768px){
  .idx{grid-template-columns:repeat(4,1fr);}
  .r1,.r3{grid-template-columns:1fr 1fr;}
  .r1 .pnl{grid-column:auto;}
  .hdr-right .dt{display:none;}
}
@media(max-width:540px){
  .idx{grid-template-columns:repeat(2,1fr);}
  .r1,.r2,.r3{grid-template-columns:1fr;}
  body{padding:10px 10px calc(env(safe-area-inset-bottom,10px) + 10px);}
  .hdr h1 .label{display:none;}
}
</style>
</head>
<body>

<!-- â”€â”€ Login Screen â”€â”€ -->
<div id="loginScreen">
  <div class="login-box">
    <div class="login-logo">
      <span>ğŸ“ˆ Markets</span>
      DASHBOARD
    </div>
    <input type="password" id="pwInput" placeholder="API Key eingebenâ€¦" autocomplete="current-password">
    <button class="login-btn" onclick="doLogin()">Anmelden</button>
    <div class="login-err" id="loginErr"></div>
  </div>
</div>

<!-- â”€â”€ Main App â”€â”€ -->
<div id="app" style="display:none">

  <div class="hdr">
    <h1><span class="label">Market </span>Dashboard</h1>
    <div class="hdr-right">
      <span class="last-upd" id="lastUpd"></span>
      <div class="pill loading" id="pill" onclick="refreshAll()">
        <span class="dot pulse" id="pillDot"></span>
        <span id="pillTxt">Loadingâ€¦</span>
      </div>
      <button class="th-btn" id="thBtn" onclick="toggleTheme()" title="Dark/Light Mode">ğŸŒ™</button>
      <div class="dt" id="dtEl"></div>
    </div>
  </div>

  <div class="err" id="errBanner">âš  API nicht erreichbar â€” statische Fallback-Daten</div>

  <div class="idx" id="idxRow"></div>

  <div class="r1">
    <!-- Market Conditions -->
    <div class="pnl">
      <div class="ph"><h3>Market Conditions</h3></div>
      <div class="mc">
        <div class="mc-row">
          <div class="mc-badge neg" id="mcBadge">â€”</div>
          <div class="mc-pct" id="mcPct">â€”</div>
        </div>
        <div class="mc-sub">SPY vs 52W High</div>
        <div class="mc-chart"><svg viewBox="0 0 200 52" preserveAspectRatio="none">
          <defs><linearGradient id="cg" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#ff4466" stop-opacity=".2" id="cgStop"/>
            <stop offset="100%" stop-color="#ff4466" stop-opacity=".01"/>
          </linearGradient></defs>
          <path id="mcL" fill="none" stroke="#ff4466" stroke-width="1.3"
            d="M0,40 C8,38 16,26 30,24 C44,22 52,13 65,16 C78,19 88,32 102,35 C116,38 126,44 138,42 C150,40 160,46 172,49 C184,52 194,46 200,44"/>
          <path id="mcF" fill="url(#cg)"
            d="M0,40 C8,38 16,26 30,24 C44,22 52,13 65,16 C78,19 88,32 102,35 C116,38 126,44 138,42 C150,40 160,46 172,49 C184,52 194,46 200,44 L200,52 L0,52Z"/>
        </svg></div>
      </div>
    </div>

    <!-- Performance -->
    <div class="pnl">
      <div class="ph"><h3>Performance Overview</h3></div>
      <table class="ptable">
        <thead><tr><th>YTD</th><th>1W</th><th>1M</th><th>1Y</th><th>52W Hi</th><th>VIX</th></tr></thead>
        <tbody>
          <tr id="perfR"><td colspan="6" style="text-align:center"><span class="sk" style="width:85%;height:11px"></span></td></tr>
          <tr id="perfB"><td colspan="6"></td></tr>
        </tbody>
      </table>
      <div class="tlo">
        <div class="tlo-c"><div class="lbl">10SMA</div><div class="val sk" style="width:38px;height:10px"></div></div>
        <div class="tlo-c"><div class="lbl">20SMA</div><div class="val sk" style="width:38px;height:10px"></div></div>
        <div class="tlo-c"><div class="lbl">50SMA</div><div class="val sk" style="width:38px;height:10px"></div></div>
        <div class="tlo-c"><div class="lbl">200SMA</div><div class="val sk" style="width:38px;height:10px"></div></div>
        <div class="tlo-c"><div class="lbl">20&gt;50</div><div class="val sk" style="width:38px;height:10px"></div></div>
        <div class="tlo-c"><div class="lbl">50&gt;200</div><div class="val sk" style="width:38px;height:10px"></div></div>
      </div>
    </div>

    <!-- Trend Status -->
    <div class="pnl">
      <div class="ph"><h3>Trend Status</h3></div>
      <table class="ts">
        <thead><tr><th>Signal</th><th>SPY</th><th>RSP</th><th>QQQ</th><th>QQQE</th></tr></thead>
        <tbody id="trendTbl"></tbody>
      </table>
    </div>

    <!-- Power Trend -->
    <div class="pnl">
      <div class="ph"><h3>Power Trend (QQQ)</h3></div>
      <div class="ptb" id="ptEl"></div>
    </div>

    <!-- Factors -->
    <div class="pnl">
      <div class="ph"><h3>Factors vs SP500</h3></div>
      <div class="fb" id="facEl"></div>
    </div>
  </div>

  <div class="r2">
    <div class="pnl">
      <div class="ph"><h3>RS Gainers</h3></div>
      <div class="rss" id="rsEl"></div>
    </div>
    <div class="pnl">
      <div class="ph"><h3>Sector Leaders</h3></div>
      <div class="tw"><table>
        <thead><tr><th>RS</th><th>Ticker</th><th>Name</th><th class="nc">Day%</th><th class="nc">Wk%</th><th class="nc">Mth%</th><th class="nc">RS Day%</th><th class="nc">RS Wk%</th><th class="nc">RS Mth%</th><th class="nc">52W Hi</th></tr></thead>
        <tbody id="secTbl"></tbody>
      </table></div>
    </div>
  </div>

  

</div><!-- /#app -->

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Market Dashboard â€” Vercel Serverless Proxy
//  Finnhub (quotes) + Yahoo Finance via /api/data
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const REFRESH  = 5 * 60 * 1000;
const API      = '/api/data';
let   FKEY     = '';

// Kill old service workers
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.getRegistrations().then(r => r.forEach(sw => sw.unregister()));
  if (window.caches) caches.keys().then(ks => ks.forEach(k => caches.delete(k)));
}

// Theme
function toggleTheme() {
  const html = document.documentElement;
  const next = html.dataset.theme === 'dark' ? 'light' : 'dark';
  html.dataset.theme = next;
  localStorage.setItem('theme', next);
  document.getElementById('thBtn').textContent = next === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
  document.getElementById('themeColorMeta').content = next === 'dark' ? '#0a0b0e' : '#f0f2f5';
}
const savedTheme = localStorage.getItem('theme') || 'dark';
document.documentElement.dataset.theme = savedTheme;
document.getElementById('thBtn').textContent = savedTheme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';

// Auth
function doLogin() {
  const pw  = document.getElementById('pwInput').value.trim();
  const err = document.getElementById('loginErr');
  if (!pw) { err.textContent = 'Bitte Finnhub API Key eingeben'; return; }
  err.textContent = 'Verbindeâ€¦';
  verifyKey(pw);
}
document.getElementById('pwInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') doLogin();
});

async function verifyKey(key) {
  const err = document.getElementById('loginErr');
  try {
    const res  = await fetch(`${API}?type=quotes&symbols=SPY&fhkey=${key}`);
    const data = await res.json();
    if (data.SPY && data.SPY.c > 0) {
      FKEY = key;
      localStorage.setItem('fh_key', key);
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('app').style.display = 'block';
      setTimeout(() => document.getElementById('loginScreen').style.display = 'none', 350);
      init();
    } else {
      err.textContent = 'UngÃ¼ltiger API Key';
    }
  } catch(e) { err.textContent = 'Verbindungsfehler'; }
}
const savedKey = localStorage.getItem('fh_key');
if (savedKey) { FKEY = savedKey; verifyKey(savedKey); }

// API helpers
async function getQuotes(symbols) {
  const res = await fetch(`${API}?type=quotes&symbols=${symbols.join(',')}&fhkey=${FKEY}`);
  return res.json();
}
async function getCandles(symbols, range='1y') {
  const encoded = symbols.map(s => s.replace(/\^/g, '__'));
  const res = await fetch(`${API}?type=candles&symbols=${encoded.join(',')}&range=${range}`);
  const data = await res.json();
  const out = {};
  Object.entries(data).forEach(([k,v]) => { out[k.replace(/__/g,'^')] = v; });
  return out;
}
function clean(arr) { return (arr||[]).filter(v => v != null && !isNaN(v)); }

// Math
function sma(arr, n) { const s=arr.slice(-n); return s.reduce((a,b)=>a+b,0)/s.length; }
function emaCalc(arr, n) { const k=2/(n+1); let e=arr[0]; for(let i=1;i<arr.length;i++) e=arr[i]*k+e*(1-k); return e; }

// UI
function setStatus(state, text) {
  document.getElementById('pill').className = `pill ${state}`;
  document.getElementById('pillDot').className = `dot${state==='live'?' pulse':''}`;
  document.getElementById('pillTxt').textContent = text;
}
function pct(v, d=2) {
  if (v==null||isNaN(v)) return 'â€”';
  return `<span class="${v>=0?'up':'dn'}">${v>=0?'+':''}${v.toFixed(d)}%</span>`;
}
function bdg(v) {
  if (v==null) return '<span class="bdg bu">â€”</span>';
  if (v>0) return '<span class="bdg bp">Positive</span>';
  if (v<0) return '<span class="bdg bn">Negative</span>';
  return '<span class="bdg bu">Neutral</span>';
}
function rsClass(rs) { if(rs>=80) return 'rh'; if(rs>=60) return 'rm'; if(rs>=40) return 'rl'; return 'rvl'; }

document.getElementById('dtEl').textContent =
  new Date().toLocaleDateString('en-US',{weekday:'short',year:'numeric',month:'short',day:'numeric'});

// â”€â”€ 1. Index Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const IDX_SYMS = ['SPY','RSP','QQQ','QQQE','IWM','BINANCE:BTCUSDT'];
const IDX_META = {
  'SPY':'S&P 500','RSP':'S&P 500 EQ WT','QQQ':'NASDAQ 100',
  'QQQE':'NASDAQ 100 EQ WT','IWM':'RUSSELL 2000','BINANCE:BTCUSDT':'BITCOIN'
};

async function loadIndices() {
  const [quotesData, vixRes] = await Promise.all([
    getQuotes(IDX_SYMS),
    fetch(`${API}?type=vix`).then(r=>r.json()).catch(()=>({}))
  ]);
  const row = document.getElementById('idxRow');
  row.innerHTML = '';
  IDX_SYMS.forEach((sym,i) => {
    const q     = quotesData[sym];
    const price = q?.c || 0;
    const prev  = q?.pc || 0;
    const chg   = prev>0 ? (price-prev)/prev*100 : 0;
    const disp  = sym==='BINANCE:BTCUSDT' ? 'BTC' : sym;
    const pstr  = sym==='BINANCE:BTCUSDT' ? '$'+Math.round(price).toLocaleString() : '$'+price.toFixed(2);
    row.innerHTML += `<div class="ic" style="animation-delay:${i*.05}s">
      <div class="tk">${disp}</div><div class="pr">${pstr}</div>
      <div class="ch ${chg>=0?'up':'dn'}">${chg>=0?'+':''}${chg.toFixed(2)}%</div>
      <div class="nm">${IDX_META[sym]}</div></div>`;
  });
  // VIX card
  const vix = vixRes.vix;
  if (vix != null) {
    row.innerHTML += `<div class="ic" style="animation-delay:0.35s">
      <div class="tk">VIX</div><div class="pr">${vix.toFixed(2)}</div>
      <div class="ch" style="color:var(--muted)">â€”</div>
      <div class="nm">VOLATILITY</div></div>`;
  }
  return { quotes: quotesData, vix };
}

// â”€â”€ 2. SPY Performance â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPerf() {
  try {
    const data  = await getCandles(['SPY'], '2y');
    const d     = data['SPY'];
    if (!d||!d.c) return null;
    const c     = clean(d.c);
    const price = c[c.length-1];
    const now   = new Date();
    const wk    = c[c.length-6]   || c[0];
    const mth   = c[c.length-22]  || c[0];
    const yr    = c[c.length-252] || c[0];
    const h52   = Math.max(...c.slice(-252));
    const times = d.t || [];
    const ytdIdx= times.findIndex(ts => new Date(ts*1000).getFullYear()===now.getFullYear());
    const ytdP  = ytdIdx>=0 ? c[ytdIdx] : c[0];
    const s10=sma(c,10), s20=sma(c,20), s50=sma(c,50), s200=sma(c,200);
    return {
      ytd:(price/ytdP-1)*100, w1:(price/wk-1)*100,
      m1:(price/mth-1)*100, y1:(price/yr-1)*100,
      h52w:(price/h52-1)*100,
      price, closes:c,
      s10,s20,s50,s200,
      spyDayPct:(price/c[c.length-2]-1)*100,
      spyWkPct:(price/wk-1)*100,
      spyMthPct:(price/mth-1)*100,
    };
  } catch(e) { console.error('Perf error',e); return null; }
}

function renderPerf(p, vix) {
  if (!p) return;
  const f = v => v!=null ? `${v>=0?'+':''}${v.toFixed(2)}%` : 'â€”';
  document.getElementById('perfR').innerHTML = `
    <td>${f(p.ytd)}</td><td>${f(p.w1)}</td><td>${f(p.m1)}</td>
    <td>${f(p.y1)}</td><td>${f(p.h52w)}</td>
    <td>${vix!=null?vix.toFixed(2):'â€”'}</td>`;
  document.getElementById('perfB').innerHTML =
    `<td>${bdg(p.ytd)}</td><td>${bdg(p.w1)}</td><td>${bdg(p.m1)}</td>
     <td>${bdg(p.y1)}</td><td>${bdg(p.h52w)}</td><td><span class="bdg bu">â€”</span></td>`;
  const {s10,s20,s50,s200,price} = p;
  const mk=(s,lbl)=>`<div class="tlo-c"><div class="lbl">${lbl}</div>
    <div class="val">${s.toFixed(0)}</div>
    <div class="bdg ${price>s?'bp':'bn'}" style="font-size:7px;padding:1px 4px">${price>s?'â–²':'â–¼'}</div></div>`;
  const p2050=((s20/s50-1)*100).toFixed(1)+'%', p50200=((s50/s200-1)*100).toFixed(1)+'%';
  document.getElementById('tloRow').innerHTML =
    mk(s10,'10SMA')+mk(s20,'20SMA')+mk(s50,'50SMA')+mk(s200,'200SMA')+
    `<div class="tlo-c"><div class="lbl">20&gt;50</div><div class="val">${p2050}</div>
     <div class="bdg ${s20>s50?'bp':'bn'}" style="font-size:7px;padding:1px 4px">${s20>s50?'Yes':'No'}</div></div>`+
    `<div class="tlo-c"><div class="lbl">50&gt;200</div><div class="val">${p50200}</div>
     <div class="bdg ${s50>s200?'bp':'bn'}" style="font-size:7px;padding:1px 4px">${s50>s200?'Yes':'No'}</div></div>`;
  // Market conditions badge based on h52w
  const v=p.h52w;
  const badge=document.getElementById('mcBadge');
  if(badge && badge.textContent==='â€”') {
    if(v>-2){badge.textContent='Positive';badge.className='mc-badge pos';}
    else if(v<-10){badge.textContent='Negative';badge.className='mc-badge neg';}
    else{badge.textContent='Neutral';badge.className='mc-badge neu';}
  }
}

// â”€â”€ 3. Market Conditions (PTMM-style) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadMarketConditions(spyCloses) {
  const badge  = document.getElementById('mcBadge');
  const score  = document.getElementById('mcScore');
  const checks = document.getElementById('mcChecks');
  const breadth= document.getElementById('mcBreadth');
  let moVal=null, siVal=null, p50Val=null, p200Val=null, hlVal=null;
  try {
    const bRes  = await fetch(`${API}?type=breadth`);
    const bData = await bRes.json();
    moVal  = bData.nymo;
    siVal  = bData.nasi;
    hlVal  = bData.nyhl;
    p50Val = bData.pct50;
    p200Val= bData.pct200;
  } catch(e) { console.error('Breadth error:', e); }
  const c=spyCloses, price=c[c.length-1];
  const e21=emaCalc(c.slice(-100),21), s50=sma(c,50), s200=sma(c,200);
  const conds = [
    {label:'SPY > 21 EMA', pass:price>e21, val:`${((price/e21-1)*100).toFixed(2)}%`},
    {label:'SPY > 50 SMA', pass:price>s50, val:`${((price/s50-1)*100).toFixed(2)}%`},
    {label:'McClellan Summ. > 0', pass:siVal!=null&&siVal>0, val:siVal!=null?siVal.toFixed(0):'â€”'},
    {label:'% > 50 SMA > 60%', pass:p50Val!=null&&p50Val>60, val:p50Val!=null?p50Val.toFixed(1)+'%':'â€”'},
  ];
  const passCount=conds.filter(c=>c.pass).length;
  const reqPass=conds[0].pass&&conds[1].pass;
  let status,cls;
  if(reqPass&&passCount>=3){status='UPTREND';cls='pos';}
  else if(passCount<=1){status='DOWNTREND';cls='neg';}
  else{status='MIXED';cls='neu';}
  badge.textContent=status; badge.className=`mc-badge ${cls}`;
  if(score) score.textContent=`${passCount}/4`;
  if(checks) checks.innerHTML=conds.map(c=>`
    <div class="mc-check">
      <span class="lbl">${c.label}</span>
      <span class="val" style="display:flex;align-items:center;gap:5px;">
        <span style="font-size:9px;color:var(--muted)">${c.val}</span>
        <span class="${c.pass?'ty':'tn'}">${c.pass?'âœ“':'âœ—'}</span>
      </span>
    </div>`).join('');
  if(breadth) {
    const bItems=[
      {label:'McClellan Osc.',val:moVal,fmt:v=>v.toFixed(0),cls:v=>v>0?'up':'dn'},
      {label:'McClellan Sum.',val:siVal,fmt:v=>v.toFixed(0),cls:v=>v>0?'up':'dn'},
      {label:'% > 50 SMA',val:p50Val,fmt:v=>v.toFixed(1)+'%',cls:v=>v>60?'up':v>40?'':'dn'},
      {label:'% > 200 SMA',val:p200Val,fmt:v=>v.toFixed(1)+'%',cls:v=>v>60?'up':v>40?'':'dn'},
      {label:'Net New Highs',val:hlVal,fmt:v=>(v>0?'+':'')+v.toFixed(0),cls:v=>v>0?'up':'dn'},
      {label:'SPY vs 200 SMA',val:(price/s200-1)*100,fmt:v=>(v>0?'+':'')+v.toFixed(2)+'%',cls:v=>v>0?'up':'dn'},
    ];
    breadth.innerHTML=bItems.map(b=>{
      const has=b.val!=null&&!isNaN(b.val);
      return `<div class="mc-bitem"><div class="bl">${b.label}</div>
        <div class="bv ${has?b.cls(b.val):''}">${has?b.fmt(b.val):'â€”'}</div></div>`;
    }).join('');
  }
}

// â”€â”€ 4. Trend Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TREND_LABELS=[['ema9','9 EMA'],['ema21','21 EMA'],['ema50','50 EMA'],['ema200','200 EMA'],['d3ema21','3D>21 EMA'],['w52h','52W High']];

async function loadTrend() {
  const syms=['SPY','RSP','QQQ','QQQE'];
  const data=await getCandles(syms,'1y');
  const result={};
  syms.forEach(sym=>{
    const d=data[sym]; if(!d||!d.c) return;
    const c=clean(d.c); if(c.length<50) return;
    const price=c[c.length-1];
    const e9=emaCalc(c.slice(-50),9), e21=emaCalc(c.slice(-100),21);
    const e50=emaCalc(c.slice(-200),50), e200=emaCalc(c,200);
    const h52=Math.max(...c.slice(-252));
    result[sym]={
      ema9:(price-e9)/e9*100, ema21:(price-e21)/e21*100,
      ema50:(price-e50)/e50*100, ema200:(price-e200)/e200*100,
      d3ema21:c.slice(-3).every(v=>v>emaCalc(c.slice(-100),21)),
      w52h:(price-h52)/h52*100,
    };
  });
  return result;
}

function renderTrend(data) {
  const tb=document.getElementById('trendTbl'); tb.innerHTML='';
  if(!data) return;
  TREND_LABELS.forEach(([key,label])=>{
    const tr=document.createElement('tr');
    let cells=`<td>${label}</td>`;
    ['SPY','RSP','QQQ','QQQE'].forEach(t=>{
      const v=data[t]?data[t][key]:null;
      if(v==null){cells+=`<td>â€”</td>`;return;}
      if(typeof v==='boolean') cells+=`<td class="${v?'ty':'tn'}">${v?'Yes':'No'}</td>`;
      else cells+=`<td class="${v>=0?'up':'dn'}">${v>=0?'+':''}${v.toFixed(2)}%</td>`;
    });
    tr.innerHTML=cells; tb.appendChild(tr);
  });
}

// â”€â”€ 5. Power Trend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPT() {
  try {
    const data=await getCandles(['QQQ'],'1y');
    const c=clean(data['QQQ']?.c||[]);
    if(c.length<50) return null;
    const avg3=(c[c.length-1]+c[c.length-2]+c[c.length-3])/3;
    const s20=sma(c,20),s50=sma(c,50),s200=sma(c,200);
    return {sma3d20:avg3>s20,sma3d50:avg3>s50,sma3d200:avg3>s200,sma20_50:s20>s50,sma20_200:s20>s200,sma50_200:s50>s200};
  } catch(e){return null;}
}

async function loadYields() {
  try {
    const data=await getCandles(['^TNX','^IRX'],'5d');
    const getLast=sym=>{const c=clean(data[sym]?.c||[]);return c.length?c[c.length-1]:null;};
    return {y10:getLast('^TNX'), y2:getLast('^IRX')};
  } catch(e){return {};}
}

function renderPT(data,yields) {
  const el=document.getElementById('ptEl'); el.innerHTML='';
  [['sma3d20','3D > 20 SMA'],['sma3d50','3D > 50 SMA'],['sma3d200','3D > 200 SMA'],
   ['sma20_50','20 > 50 SMA'],['sma20_200','20 > 200 SMA'],['sma50_200','50 > 200 SMA']].forEach(([k,l])=>{
    const d=document.createElement('div'); d.className='ptr';
    const v=data?data[k]:null;
    d.innerHTML=`<span class="lbl">${l}</span><span class="val ${v==null?'vnum':v?'vyes':'vno'}">${v==null?'â€”':v?'Yes':'No'}</span>`;
    el.appendChild(d);
  });
  [['y10','US 10Y Yield'],['y2','US 02Y Yield']].forEach(([k,l])=>{
    const d=document.createElement('div'); d.className='ptr';
    const v=yields?yields[k]:null;
    d.innerHTML=`<span class="lbl">${l}</span><span class="val vnum">${v!=null?v.toFixed(2):'â€”'}</span>`;
    el.appendChild(d);
  });
}

// â”€â”€ 6. Factors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FAC_SYMS=['IVW','IVE','HDV','OEF','IJH','IJR','MTUM','IPO'];
const FAC_LBLS={IVW:'Growth',IVE:'Value',HDV:'High Dividend',OEF:'Large-Cap',IJH:'Mid-Cap',IJR:'Small-Cap',MTUM:'Momentum',IPO:'IPOs'};

async function loadFactors(spyMth) {
  const data=await getCandles(FAC_SYMS,'1mo');
  return FAC_SYMS.map(sym=>{
    const c=clean(data[sym]?.c||[]);
    if(c.length<2) return{label:FAC_LBLS[sym],val:0};
    return{label:FAC_LBLS[sym],val:+((c[c.length-1]/c[0]-1)*100-spyMth).toFixed(2)};
  });
}

function renderFac(data) {
  const el=document.getElementById('facEl'); el.innerHTML='';
  data.forEach(r=>{
    const d=document.createElement('div'); d.className='fr';
    d.innerHTML=`<span class="lbl">${r.label}</span><span class="val ${r.val>=0?'up':'dn'}">${r.val>=0?'+':''}${r.val.toFixed(2)}%</span>`;
    el.appendChild(d);
  });
}

// â”€â”€ 7. Sectors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SEC_SYMS=['RSPG','RSPN','RSPU','RSPH','RSPR','RSPM','RSPS','RSPC','RSPD','RSPT','RSPF'];
const SEC_NAMES={RSPG:'Energy',RSPN:'Industrials',RSPU:'Utilities',RSPH:'Health Care',
  RSPR:'Real Estate',RSPM:'Materials',RSPS:'Cons Stpl',RSPC:'Comm Svcs',
  RSPD:'Cons Disc',RSPT:'Technology',RSPF:'Financials'};

async function loadSectors(spyDay,spyWk,spyMth) {
  const data=await getCandles(SEC_SYMS,'6mo');
  const result={};
  SEC_SYMS.forEach(sym=>{
    const c=clean(data[sym]?.c||[]); if(c.length<5) return;
    const price=c[c.length-1];
    const day=(price/c[c.length-2]-1)*100;
    const wk=c.length>6?(price/c[c.length-6]-1)*100:0;
    const mth=c.length>22?(price/c[c.length-22]-1)*100:0;
    const h52=Math.max(...c.slice(-252));
    const rs=Math.min(100,Math.max(0,Math.round(50+(mth-spyMth)*3)));
    result[sym]={name:SEC_NAMES[sym],price:price.toFixed(2),
      day:+day.toFixed(2),wk:+wk.toFixed(2),mth:+mth.toFixed(2),
      rs_day:+(day-spyDay).toFixed(2),rs_wk:+(wk-spyWk).toFixed(2),rs_mth:+(mth-spyMth).toFixed(2),
      high52:+((price/h52-1)*100).toFixed(2),rs};
  });
  return result;
}

function rsGB(rs){return rs>=80?'r100':rs>=60?'r65':'r50';}

function renderSectors(data) {
  const tb=document.getElementById('secTbl'); tb.innerHTML='';
  const rsEl=document.getElementById('rsEl'); rsEl.innerHTML='';
  const sorted=Object.entries(data).sort((a,b)=>b[1].rs-a[1].rs);
  sorted.forEach(([sym,s])=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><div class="rsc ${rsClass(s.rs)}">${s.rs}</div></td><td class="tck">${sym}</td>
      <td class="tname">${s.name}</td><td class="nc">${pct(s.day,1)}</td>
      <td class="nc">${pct(s.wk,1)}</td><td class="nc">${pct(s.mth,1)}</td>
      <td class="nc">${pct(s.rs_day)}</td><td class="nc">${pct(s.rs_wk)}</td>
      <td class="nc">${pct(s.rs_mth)}</td>
      <td class="nc"><span class="${s.high52<-3?'dn':s.high52<0?'':'up'}">${s.high52.toFixed(1)}%</span></td>`;
    tb.appendChild(tr);
  });
  const topD=[...sorted].slice(0,3);
  const topW=[...sorted].sort((a,b)=>b[1].wk-a[1].wk).slice(0,3);
  const card=(sym,s,val,cls)=>`<div class="rsi">
    <div class="rsb ${rsGB(s.rs)}">RS:${s.rs}</div>
    <div class="ri"><div class="tn2">${sym}</div><div class="sc">${s.name}</div></div>
    <div class="rr"><div class="rp">$${s.price}</div>
    <div class="rc ${cls}">${val>=0?'+':''}${val.toFixed(2)}%</div></div></div>`;
  rsEl.innerHTML='<div class="slbl">Daily</div>'+
    topD.map(([sym,s])=>card(sym,s,s.day,s.day>=0?'up':'dn')).join('')+
    '<div class="slbl">Weekly</div>'+
    topW.map(([sym,s])=>card(sym,s,s.wk,s.wk>=0?'up':'dn')).join('');
}

// â”€â”€ Main Refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function refreshAll() {
  setStatus('loading','Loadingâ€¦');
  document.getElementById('errBanner').classList.remove('show');
  try {
    const [idxData, perfData] = await Promise.all([loadIndices(), loadPerf()]);
    renderPerf(perfData, idxData.vix);

    const spyMth=perfData?.spyMthPct||0;
    const spyDay=perfData?.spyDayPct||0;
    const spyWk =perfData?.spyWkPct ||0;

    const [trend,pt,yields,sectors,factors] = await Promise.all([
      loadTrend(), loadPT(), loadYields(),
      loadSectors(spyDay,spyWk,spyMth),
      loadFactors(spyMth),
    ]);
    renderTrend(trend);
    renderPT(pt,yields);
    renderFac(factors);
    renderSectors(sectors);

    if (perfData?.closes) await loadMarketConditions(perfData.closes);

    setStatus('live','Live Â· 5 min');
    document.getElementById('lastUpd').textContent =
      'Updated '+new Date().toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});
  } catch(e) {
    console.error(e);
    setStatus('error','Fehler');
    document.getElementById('errBanner').classList.add('show');
  }
}

function init() { refreshAll(); setInterval(refreshAll,REFRESH); }
</script>
</body>
</html>