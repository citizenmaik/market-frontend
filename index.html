<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Markets">
<meta name="theme-color" content="#0a0b0e" id="themeColorMeta">
<title>Market Dashboard</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CSS Variables â€” Dark & Light Theme
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --green:#00d084; --green-bright:#00ff9d;
  --red:#ff4466; --yellow:#f5c842; --blue:#4d9fff; --accent:#7c6af7;
  --mono:'IBM Plex Mono',monospace; --sans:'IBM Plex Sans',sans-serif;
  --radius:8px; --gap:12px;
  --pad:16px;    /* universal inner padding */
  --transition: background .25s, color .25s, border-color .25s;
}
[data-theme="dark"] {
  --bg:#0a0b0e; --surface:#111318; --surface2:#171b22; --border:#1e2330;
  --text:#e8eaf0; --muted:#5a6070; --th-btn:#1e2535;
}
[data-theme="light"] {
  --bg:#f0f2f5; --surface:#ffffff; --surface2:#f7f8fa; --border:#e2e6ed;
  --text:#1a1d24; --muted:#8a94a6; --th-btn:#e8ecf2;
  --green:#00a864; --red:#d63050; --yellow:#c8971a; --blue:#2b7fd4; --accent:#5c4fd6;
}

/* â”€â”€ Reset â”€â”€ */
*{margin:0;padding:0;box-sizing:border-box;}
html{height:100%;}
body {
  background:var(--bg); color:var(--text);
  font-family:var(--sans); min-height:100vh;
  padding: max(env(safe-area-inset-top),16px) max(env(safe-area-inset-right),16px)
           max(env(safe-area-inset-bottom),24px) max(env(safe-area-inset-left),16px);
  transition:var(--transition);
}

/* â•â• HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.hdr {
  display:flex; justify-content:space-between; align-items:center;
  margin-bottom:14px; padding-bottom:12px; border-bottom:1px solid var(--border);
  gap:8px;
}
.hdr h1{font-family:var(--mono);font-size:12px;letter-spacing:.15em;color:var(--muted);text-transform:uppercase;white-space:nowrap;}
.hdr-right{display:flex;align-items:center;gap:8px;flex-shrink:0;}
.dt{font-family:var(--mono);font-size:11px;color:var(--muted);white-space:nowrap;}
.last-upd{font-family:var(--mono);font-size:11px;color:var(--muted);white-space:nowrap;}

/* Theme toggle */
.th-btn{width:32px;height:32px;border-radius:50%;border:1px solid var(--border);
  background:var(--th-btn);cursor:pointer;display:flex;align-items:center;
  justify-content:center;font-size:15px;transition:all .2s;flex-shrink:0;}
.th-btn:hover{transform:scale(1.1);}

/* Status pill */
.pill{display:flex;align-items:center;gap:6px;padding:5px 12px;border-radius:20px;
  cursor:pointer;font-family:var(--mono);font-size:11px;border:1px solid var(--border);
  transition:all .2s;white-space:nowrap;}
.pill.live{border-color:rgba(0,208,132,.3);background:rgba(0,208,132,.08);color:var(--green);}
.pill.loading{border-color:var(--border);color:var(--muted);}
.pill.error{border-color:rgba(255,68,102,.3);background:rgba(255,68,102,.08);color:var(--red);}
.dot{width:6px;height:6px;border-radius:50%;background:currentColor;}
.dot.pulse{animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.3;}}

/* Error banner */
.err{background:rgba(255,68,102,.1);border:1px solid rgba(255,68,102,.3);
  color:var(--red);padding:8px 16px;border-radius:6px;font-size:12px;
  margin-bottom:var(--gap);display:none;}
.err.show{display:block;}

/* â•â• INDEX CARDS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.idx{display:grid;grid-template-columns:repeat(8,1fr);gap:var(--gap);margin-bottom:var(--gap);}
.ic{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
  padding:var(--pad);min-height:90px;display:flex;flex-direction:column;
  justify-content:space-between;transition:var(--transition),border-color .2s;cursor:pointer;}
.ic:hover{border-color:var(--accent);}
.ic .tk{font-family:var(--mono);font-size:11px;color:var(--muted);letter-spacing:.08em;margin-bottom:4px;}
.ic .pr{font-size:20px;font-weight:700;letter-spacing:-.02em;margin-bottom:3px;}
.ic .ch{font-family:var(--mono);font-size:13px;font-weight:600;margin-bottom:3px;}
.ic .nm{font-family:var(--mono);font-size:9px;color:var(--muted);letter-spacing:.06em;text-transform:uppercase;}

/* â•â• LAYOUT ROWS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.r1  {display:grid;grid-template-columns:1fr 1fr 1fr;gap:var(--gap);margin-bottom:var(--gap);}
.rtd {display:block;margin-bottom:var(--gap);}
.r1b {display:grid;grid-template-columns:1fr 1fr;gap:var(--gap);margin-bottom:var(--gap);}
.rsec{display:block;margin-bottom:var(--gap);}
.rrs {display:block;margin-bottom:var(--gap);}

/* â•â• PANELS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.pnl{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
  overflow:visible;transition:var(--transition);}
.ph{padding:12px var(--pad);border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:7px;}
.ph h3{font-family:var(--mono);font-size:11px;letter-spacing:.12em;text-transform:uppercase;color:var(--text);}
.ph::before{content:'';width:3px;height:14px;background:var(--accent);border-radius:2px;flex-shrink:0;}

/* â•â• MARKET CONDITIONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.mc-top{display:flex;justify-content:space-between;align-items:center;padding:var(--pad);border-bottom:1px solid var(--border);}
.mc{padding:var(--pad);}
.mc-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.mc-badge{font-family:var(--mono);font-size:13px;font-weight:600;padding:4px 12px;border-radius:4px;}
.mc-badge.neg{background:rgba(255,68,102,.15);color:var(--red);border:1px solid rgba(255,68,102,.3);}
.mc-badge.pos{background:rgba(0,208,132,.15);color:var(--green);border:1px solid rgba(0,208,132,.3);}
.mc-badge.neu{background:rgba(90,96,112,.2);color:var(--muted);border:1px solid rgba(90,96,112,.2);}
.mc-pct{font-family:var(--mono);font-size:17px;font-weight:600;}
.mc-sub{font-family:var(--mono);font-size:9px;color:var(--muted);margin-bottom:8px;}
.mc-bitem{background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:5px 8px;}
.mc-bitem .bl{font-family:var(--mono);font-size:10px;color:var(--muted);margin-bottom:2px;white-space:nowrap;}
.mc-bitem .bv{font-family:var(--mono);font-size:12px;font-weight:600;}
.mc-bitem .bv.up{color:var(--green-bright);}
.mc-bitem .bv.dn{color:var(--red);}

/* â•â• TREND STATUS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ts-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;}
.ts{width:100%;border-collapse:collapse;font-size:13px;min-width:480px;}
.ts th{font-family:var(--mono);font-size:10px;color:var(--muted);text-align:left;
  padding:10px var(--pad);border-bottom:1px solid var(--border);letter-spacing:.08em;font-weight:500;}
.ts td{padding:9px var(--pad);border-bottom:1px solid var(--border);font-family:var(--mono);font-size:13px;}
.ts tr:last-child td{border-bottom:none;}
.ty{color:var(--green);font-weight:600;}
.tn{color:var(--red);font-weight:600;}

/* â•â• POWER TREND â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ptb,.fb{padding:var(--pad);}
.ptr,.fr{display:flex;justify-content:space-between;align-items:center;
  padding:8px 0;border-bottom:1px solid var(--border);font-size:13px;}
.ptr:last-child,.fr:last-child{border-bottom:none;}
.ptr .lbl,.fr .lbl{font-family:var(--mono);font-size:12px;color:var(--muted);}
.ptr .val,.fr .val{font-family:var(--mono);font-size:13px;font-weight:600;}
.vyes{color:var(--green);} .vno{color:var(--red);} .vnum{color:var(--text);}

/* â•â• PERFORMANCE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ptable{width:100%;border-collapse:collapse;font-size:13px;}
.ptable th{font-family:var(--mono);font-size:10px;color:var(--muted);
  padding:9px var(--pad);border-bottom:1px solid var(--border);letter-spacing:.08em;font-weight:500;}
.ptable td{padding:9px var(--pad);font-family:var(--mono);font-size:13px;border-bottom:1px solid var(--border);}
.ptable tr:last-child td{border-bottom:none;}
.tlo{display:grid;grid-template-columns:repeat(6,1fr);padding:10px var(--pad);
  gap:4px;border-top:1px solid var(--border);}
.tlo-c .lbl{font-family:var(--mono);font-size:9px;color:var(--muted);margin-bottom:3px;}
.tlo-c .val{font-family:var(--mono);font-size:11px;font-weight:600;}

/* â•â• SECTOR / INDUSTRY TABLE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tw{overflow-x:auto;-webkit-overflow-scrolling:touch;}
.tw table{width:100%;border-collapse:collapse;font-size:13px;min-width:600px;}
.tw thead th{font-family:var(--mono);font-size:10px;color:var(--muted);
  padding:10px var(--pad);border-bottom:1px solid var(--border);
  letter-spacing:.08em;font-weight:500;text-align:left;white-space:nowrap;}
.tw td{padding:9px var(--pad);border-bottom:1px solid var(--border);font-family:var(--mono);font-size:13px;}
.tw tr:last-child td{border-bottom:none;}
.tck{color:var(--accent);font-weight:700;}
.tname{color:var(--text);font-size:12px;}
.nc{text-align:right;}
.rsc{width:36px;height:22px;border-radius:4px;display:flex;align-items:center;justify-content:center;
  font-family:var(--mono);font-size:11px;font-weight:700;}
.rh{background:rgba(0,208,132,.2);color:var(--green);}
.rm{background:rgba(245,200,66,.15);color:var(--yellow);}
.rl{background:rgba(255,68,102,.15);color:var(--red);}
.rvl{background:rgba(255,68,102,.25);color:var(--red);}

/* â•â• RS GAINERS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.slbl{font-family:var(--mono);font-size:10px;color:var(--muted);
  letter-spacing:.1em;text-transform:uppercase;padding:10px var(--pad) 6px;}
.rss{border-right:1px solid var(--border);}
.rss:last-child{border-right:none;}
.rsi{display:flex;align-items:center;gap:10px;padding:8px var(--pad);
  border-radius:5px;transition:background .15s;cursor:pointer;}
.rsi:hover{background:var(--surface2);}
.rsb{font-family:var(--mono);font-size:11px;font-weight:700;padding:4px 7px;
  border-radius:4px;white-space:nowrap;min-width:52px;text-align:center;}
.r100{background:rgba(0,208,132,.2);color:var(--green);}
.r65{background:rgba(245,200,66,.15);color:var(--yellow);}
.r50{background:rgba(255,68,102,.15);color:var(--red);}
.ri{flex:1;min-width:0;}
.tn2{font-family:var(--mono);font-size:14px;font-weight:700;color:var(--accent);}
.sc{font-size:11px;color:var(--muted);}
.rr{text-align:right;flex-shrink:0;}
.rp{font-family:var(--mono);font-size:13px;font-weight:600;margin-bottom:2px;}
.rc{font-family:var(--mono);font-size:12px;font-weight:600;}

/* â•â• SKELETON â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sk{display:inline-block;background:var(--surface2);border-radius:3px;
  animation:shimmer 1.5s infinite;}
@keyframes shimmer{0%,100%{opacity:.4;}50%{opacity:.9;}}

/* â•â• COLORS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.up{color:var(--green);} .dn{color:var(--red);}
.bdg{font-family:var(--mono);font-size:11px;padding:2px 7px;border-radius:3px;}
.bp{background:rgba(0,208,132,.15);color:var(--green);}
.bn{background:rgba(255,68,102,.15);color:var(--red);}
.bu{background:rgba(90,96,112,.15);color:var(--muted);}

/* â•â• RESPONSIVE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 1400px) {
  .idx { grid-template-columns: repeat(4,1fr); }
  .r1  { grid-template-columns: 1fr 1fr 1fr; }
}
@media (max-width: 1100px) {
  .r1  { grid-template-columns: 1fr 1fr; }
  .idx { grid-template-columns: repeat(4,1fr); }
}
@media (max-width: 768px) {
  .r1, .r1b { grid-template-columns: 1fr; }
  .idx { grid-template-columns: repeat(4,1fr); }
}
@media (max-width: 500px) {
  .idx { grid-template-columns: repeat(2,1fr); }
  body { padding: max(env(safe-area-inset-top),20px) 12px max(env(safe-area-inset-bottom),32px); }
  .hdr { margin-bottom:12px; flex-wrap:nowrap; }
  .hdr h1 { font-size:10px; }
  .hdr-right { gap:6px; }
  .dt { display:none; }
  .ic .pr { font-size:17px; }
  .ic { padding:12px; min-height:80px; }
  .ph, .mc, .ptb, .fb { padding:12px; }
  .mc-bitem .bv { font-size:11px; }
  .mc-bitem .bl { font-size:9px; }
  #rsEl, #rsIndEl { grid-template-columns: 1fr !important; }
  .rss { border-right:none; border-bottom:1px solid var(--border); }
}

/* â”€â”€ Overall Indicator responsive â”€â”€ */
.omi-wrap { display:grid; grid-template-columns: 220px 1fr; align-items:stretch; }
.omi-gauge { display:flex; flex-direction:column; align-items:center; justify-content:center;
  padding:20px 16px; border-right:1px solid var(--border); }
.omi-table { overflow-x:hidden; }
@media (max-width: 600px) {
  .omi-wrap { grid-template-columns: 1fr; }
  .omi-gauge { border-right:none; border-bottom:1px solid var(--border); padding:16px; }
}
</style>
</head>



<body>

<!-- v1772004392 Main App -->
<div id="app">

  <div class="hdr">
    <h1><span class="label">Market </span>Dashboard</h1>
    <div class="hdr-right">
      <span class="last-upd" id="lastUpd"></span>
      <div class="pill loading" id="pill" onclick="refreshAll()">
        <span class="dot pulse" id="pillDot"></span>
        <span id="pillTxt">Loadingâ€¦</span>
      </div>
      <button class="th-btn" id="thBtn" onclick="toggleTheme()" title="Dark/Light Mode">ğŸŒ™</button>
      <div class="dt" id="dtEl"></div>
    </div>
  </div>

  <div class="err" id="errBanner">âš  API nicht erreichbar â€” statische Fallback-Daten</div>
  <div class="idx" id="idxRow"></div>

  <!-- â”€â”€ Overall Market Indicator â”€â”€ -->
  <div style="margin-bottom:var(--gap);">
    <div class="pnl">
      <div class="ph"><h3>Overall Market Indicator</h3></div>
      <div class="omi-wrap">
        <!-- Gauge -->
        <div class="omi-gauge">
          <svg width="170" height="95" viewBox="0 0 170 95">
            <path d="M15,85 A70,70 0 0,1 155,85" fill="none" stroke="var(--surface2)" stroke-width="14" stroke-linecap="round"/>
            <path id="gaugeArc" d="M15,85 A70,70 0 0,1 155,85" fill="none" stroke="var(--muted)" stroke-width="14" stroke-linecap="round" stroke-dasharray="220" stroke-dashoffset="220" style="transition:stroke-dashoffset .8s ease,stroke .8s ease;"/>
            <text id="gaugeVal" x="85" y="78" text-anchor="middle" font-family="IBM Plex Mono,monospace" font-size="22" font-weight="700" fill="var(--muted)">â€”</text>
          </svg>
          <div style="display:flex;justify-content:space-between;width:170px;font-family:var(--mono);font-size:9px;color:var(--muted);margin-top:-4px;">
            <span>BEARISH</span><span>NEUTRAL</span><span>BULLISH</span>
          </div>
          <div id="gaugeLbl" style="font-family:var(--mono);font-size:11px;font-weight:700;color:var(--muted);margin-top:10px;letter-spacing:.12em;">â€”</div>
        </div>
        <!-- Tabelle -->
        <div class="omi-table">
          <table style="width:100%;border-collapse:collapse;">
            <thead>
              <tr style="border-bottom:1px solid var(--border);">
                <th style="font-family:var(--mono);font-size:10px;color:var(--muted);padding:8px 12px;text-align:left;font-weight:500;letter-spacing:.08em;">KOMPONENTE</th>
                <th style="font-family:var(--mono);font-size:10px;color:var(--muted);padding:8px 12px;text-align:right;font-weight:500;letter-spacing:.08em;">SCORE</th>
                <th style="font-family:var(--mono);font-size:10px;color:var(--muted);padding:8px 12px;text-align:right;font-weight:500;letter-spacing:.08em;">%</th>
              </tr>
            </thead>
            <tbody id="overallTbl"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ Zeile 1: 3Ã— Market Conditions â”€â”€ -->
    <div class="r1">

    <div class="pnl">
      <div class="ph"><h3>Market Conditions QQQE</h3></div>
      <div class="mc">
        <div class="mc-row" style="margin-bottom:10px;">
          <div class="mc-badge neg" id="mcBadge3">â€”</div>
          <div style="display:flex;align-items:center;gap:6px;">
            <div style="font-family:var(--mono);font-size:10px;color:var(--muted);">SCORE</div>
            <div id="mcScore3" style="font-family:var(--mono);font-size:17px;font-weight:700;color:var(--text);">â€”</div>
          </div>
        </div>
        <div style="margin-bottom:10px;">
          <div style="height:4px;background:var(--surface2);border-radius:3px;overflow:hidden;position:relative;">
            <div style="position:absolute;left:50%;top:0;width:1px;height:100%;background:var(--border);"></div>
            <div id="mcBar3" style="height:100%;position:absolute;background:var(--muted);border-radius:3px;transition:width .4s,background .4s;"></div>
          </div>
          <div style="display:flex;justify-content:space-between;font-family:var(--mono);font-size:8px;color:var(--muted);margin-top:2px;">
            <span>-100</span><span>BEARISH</span><span>0</span><span>BULLISH</span><span>+100</span>
          </div>
        </div>
        <div id="mcChecks3" style="display:flex;flex-direction:column;gap:4px;"></div>
        <div style="border-top:1px solid var(--border);margin-top:10px;padding-top:10px;">
          <div id="mcBreadth3" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px;"></div>
        </div>
      </div>
    </div>

    <div class="pnl">
      <div class="ph"><h3>Market Conditions RSP</h3></div>
      <div class="mc">
        <div class="mc-row" style="margin-bottom:10px;">
          <div class="mc-badge neg" id="mcBadge">â€”</div>
          <div style="display:flex;align-items:center;gap:6px;">
            <div style="font-family:var(--mono);font-size:10px;color:var(--muted);">SCORE</div>
            <div id="mcScore" style="font-family:var(--mono);font-size:17px;font-weight:700;color:var(--text);">â€”</div>
          </div>
        </div>
        <div style="margin-bottom:10px;">
          <div style="height:4px;background:var(--surface2);border-radius:3px;overflow:hidden;position:relative;">
            <div style="position:absolute;left:50%;top:0;width:1px;height:100%;background:var(--border);"></div>
            <div id="mcBar" style="height:100%;position:absolute;background:var(--muted);border-radius:3px;transition:width .4s,background .4s;"></div>
          </div>
          <div style="display:flex;justify-content:space-between;font-family:var(--mono);font-size:8px;color:var(--muted);margin-top:2px;">
            <span>-100</span><span>BEARISH</span><span>0</span><span>BULLISH</span><span>+100</span>
          </div>
        </div>
        <div id="mcChecks" style="display:flex;flex-direction:column;gap:4px;"></div>
        <div style="border-top:1px solid var(--border);margin-top:10px;padding-top:10px;">
          <div id="mcBreadth" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px;"></div>
        </div>
      </div>
    </div>

    <div class="pnl">
      <div class="ph"><h3>Market Conditions IWM</h3></div>
      <div class="mc">
        <div class="mc-row" style="margin-bottom:10px;">
          <div class="mc-badge neg" id="mcBadge2">â€”</div>
          <div style="display:flex;align-items:center;gap:6px;">
            <div style="font-family:var(--mono);font-size:10px;color:var(--muted);">SCORE</div>
            <div id="mcScore2" style="font-family:var(--mono);font-size:17px;font-weight:700;color:var(--text);">â€”</div>
          </div>
        </div>
        <div style="margin-bottom:10px;">
          <div style="height:4px;background:var(--surface2);border-radius:3px;overflow:hidden;position:relative;">
            <div style="position:absolute;left:50%;top:0;width:1px;height:100%;background:var(--border);"></div>
            <div id="mcBar2" style="height:100%;position:absolute;background:var(--muted);border-radius:3px;transition:width .4s,background .4s;"></div>
          </div>
          <div style="display:flex;justify-content:space-between;font-family:var(--mono);font-size:8px;color:var(--muted);margin-top:2px;">
            <span>-100</span><span>BEARISH</span><span>0</span><span>BULLISH</span><span>+100</span>
          </div>
        </div>
        <div id="mcChecks2" style="display:flex;flex-direction:column;gap:4px;"></div>
        <div style="border-top:1px solid var(--border);margin-top:10px;padding-top:10px;">
          <div id="mcBreadth2" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px;"></div>
        </div>
      </div>
    </div>

  </div>

  <!-- â”€â”€ Zeile 2: Trend Status â”€â”€ -->
  <div class="rtd">
    <div class="pnl">
      <div class="ph"><h3>Trend Status</h3></div>
      <div class="ts-wrap"><table class="ts">
        <thead><tr><th>Signal</th><th>SPY</th><th>RSP</th><th>QQQ</th><th>QQQE</th><th>IWM</th></tr></thead>
        <tbody id="trendTbl"></tbody>
      </table></div>
    </div>
  </div>

  <!-- â”€â”€ Zeile 3: Power Trend | Factors â”€â”€ -->
  <div class="r1b">
    <div class="pnl">
      <div class="ph"><h3>Power Trend (QQQ)</h3></div>
      <div class="ptb" id="ptEl"></div>
    </div>
    <div class="pnl">
      <div class="ph"><h3>Factors vs SP500</h3></div>
      <div class="fb" id="facEl"></div>
    </div>
  </div>


  <!-- â”€â”€ Zeile 4: Sector Leaders â”€â”€ -->
  <div class="rsec">
    <div class="pnl">
      <div class="ph"><h3>Sector Leaders</h3></div>
      <div class="tw"><table>
        <thead><tr><th>RS</th><th>Ticker</th><th>Name</th><th>Day%</th><th>Wk%</th><th>Mth%</th><th>RS Day%</th><th>RS Wk%</th><th>RS Mth%</th><th>52W Hi</th></tr></thead>
        <tbody id="secTbl"></tbody>
      </table></div>
    </div>
  </div>

  <!-- â”€â”€ Zeile 5: RS Gainers Sector â”€â”€ -->
  <div class="rrs">
    <div class="pnl">
      <div class="ph"><h3>RS Gainers â€” Sector</h3></div>
      <div id="rsEl"></div>
    </div>
  </div>

  <!-- â”€â”€ Zeile 6: Industry Leaders â”€â”€ -->
  <div class="rsec">
    <div class="pnl">
      <div class="ph"><h3>Industry Leaders</h3></div>
      <div class="tw"><table>
        <thead><tr><th>RS</th><th>Ticker</th><th>Name</th><th>Day%</th><th>Wk%</th><th>Mth%</th><th>RS Day%</th><th>RS Wk%</th><th>RS Mth%</th><th>52W Hi</th></tr></thead>
        <tbody id="indTbl"></tbody>
      </table></div>
    </div>
  </div>

  <!-- â”€â”€ Zeile 7: RS Gainers Industry â”€â”€ -->
  <div class="rrs">
    <div class="pnl">
      <div class="ph"><h3>RS Gainers â€” Industry</h3></div>
      <div id="rsIndEl"></div>
    </div>
  </div>

</div><!-- /#app -->

<script>
const REFRESH = 5 * 60 * 1000;
const API     = '/api/data';
let FKEY = new URLSearchParams(location.search).get('key') || localStorage.getItem('fh_key') || '';
if (new URLSearchParams(location.search).get('key')) {
  localStorage.setItem('fh_key', new URLSearchParams(location.search).get('key'));
  history.replaceState({}, '', location.pathname); // Key aus URL entfernen
}
// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function clean(arr) { return (arr||[]).filter(v=>v!=null&&!isNaN(v)); }
function sma(arr,n)  { const s=arr.slice(-n); return s.length?s.reduce((a,b)=>a+b,0)/s.length:0; }
function emaCalc(arr,n){ if(!arr||!arr.length)return 0; const k=2/(n+1);let e=arr[0];for(let i=1;i<arr.length;i++)e=arr[i]*k+e*(1-k);return e;}
function setStatus(state,text) {
  const pill=document.getElementById('pill');
  const dot =document.getElementById('pillDot');
  const txt =document.getElementById('pillTxt');
  if(pill) pill.className=`pill ${state}`;
  if(dot)  dot.className=`dot${state==='live'?' pulse':''}`;
  if(txt)  txt.textContent=text;
}
function pct(v,d=2) {
  if(v==null||isNaN(v)) return 'â€”';
  return `<span class="${v>=0?'up':'dn'}">${v>=0?'+':''}${v.toFixed(d)}%</span>`;
}
function bdg(v) {
  if(v==null) return '<span class="bdg bu">â€”</span>';
  return v>0?'<span class="bdg bp">Positive</span>':v<0?'<span class="bdg bn">Negative</span>':'<span class="bdg bu">Neutral</span>';
}
function rsClass(rs){ return rs>=80?'rh':rs>=60?'rm':rs>=40?'rl':'rvl'; }
function rsGB(rs)   { return rs>=80?'r100':rs>=60?'r65':'r50'; }



// Kill SW
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.getRegistrations().then(r => r.forEach(sw => sw.unregister()));
  if (window.caches) caches.keys().then(ks => ks.forEach(k => caches.delete(k)));
}

// â”€â”€ Theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleTheme() {
  const html = document.documentElement;
  const next = html.dataset.theme === 'dark' ? 'light' : 'dark';
  html.dataset.theme = next; localStorage.setItem('theme', next);
  document.getElementById('thBtn').textContent = next === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
}
const savedTheme = localStorage.getItem('theme') || 'dark';
document.documentElement.dataset.theme = savedTheme;
document.getElementById('thBtn').textContent = savedTheme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';

// â”€â”€ API Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function getQuotes(symbols) {
  try {
    const res = await fetch(`${API}?type=quotes&symbols=${symbols.join(',')}&fhkey=${FKEY}`);
    if (!res.ok) return {};
    const txt = await res.text();
    return txt ? JSON.parse(txt) : {};
  } catch(e) { console.warn('getQuotes error:', e); return {}; }
}
async function getCandles(symbols, range='1y') {
  const CHUNK = 20; // max symbols per request
  const out = {};
  for (let i = 0; i < symbols.length; i += CHUNK) {
    const batch = symbols.slice(i, i + CHUNK);
    const enc = batch.map(s => s.replace(/\^/g,'__'));
    try {
      const res = await fetch(`${API}?type=candles&symbols=${enc.join(',')}&range=${range}`);
      if (!res.ok) continue;
      const txt = await res.text();
      if (!txt) continue;
      const data = JSON.parse(txt);
      Object.entries(data).forEach(([k,v]) => { out[k.replace(/__/g,'^')]=v; });
    } catch(e) { console.warn('getCandles batch error:', e); }
  }
  return out;
}


// â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const IDX_SYMS = ['SPY','RSP','QQQ','QQQE','IWM','BINANCE:BTCUSDT','GLD'];
const IDX_META = {SPY:'S&P 500',RSP:'S&P 500 EQ WT',QQQ:'NASDAQ 100',QQQE:'NASDAQ 100 EQ WT',IWM:'RUSSELL 2000','BINANCE:BTCUSDT':'BITCOIN',GLD:'GOLD ETF'};

const SEC_SYMS  = ['RSPG','RSPN','RSPU','RSPH','RSPR','RSPM','RSPS','RSPC','RSPD','RSPT','RSPF'];
const SEC_NAMES = {RSPG:'Energy',RSPN:'Industrials',RSPU:'Utilities',RSPH:'Health Care',
  RSPR:'Real Estate',RSPM:'Materials',RSPS:'Cons Stpl',RSPC:'Comm Svcs',RSPD:'Cons Disc',RSPT:'Technology',RSPF:'Financials'};

const IND_SYMS = ['SMH','FAN','LIT','BOAT','COPX','REMX','IEZ','SLX','SIL','POWR','SHLD','CIBR','BOTZ','CLOU','IGV','ICLN','GDX','PAVE','IDU','XLRE','DRIV','CARZ','XBI','WQTM','KBE','QTUM','TAN','URA','PBJ','ITA','XOP','IPO','SOCL','BLOK','IHI','MOO','WGMI'];
const IND_NAMES = {SMH:'Semiconductors',FAN:'Wind Energy',LIT:'Lithium & Battery',BOAT:'Shipping',COPX:'Copper Miners',REMX:'Rare Earth',IEZ:'Oil Equipment',SLX:'Steel',SIL:'Silver Miners',POWR:'Utilities',SHLD:'Cybersecurity',CIBR:'Cybersecurity 2',BOTZ:'Robotics & AI',CLOU:'Cloud Computing',IGV:'Software',ICLN:'Clean Energy',GDX:'Gold Miners',PAVE:'Infrastructure',IDU:'Electric Utilities',XLRE:'Real Estate',DRIV:'Autonomous Vehicles',CARZ:'Auto & Parts',XBI:'Biotech',WQTM:'Quantum Computing',KBE:'Banks',QTUM:'Quantum Tech',TAN:'Solar Energy',URA:'Uranium',PBJ:'Food & Beverage',ITA:'Aerospace & Def',XOP:'Oil & Gas E&P',IPO:'IPOs',SOCL:'Social Media',BLOK:'Blockchain',IHI:'Medical Devices',MOO:'Agribusiness',WGMI:'Bitcoin Miners'};

const FAC_SYMS = ['IVW','IVE','HDV','OEF','IJH','IJR','MTUM','IPO'];
const FAC_LBLS = {IVW:'Growth',IVE:'Value',HDV:'High Dividend',OEF:'Large-Cap',IJH:'Mid-Cap',IJR:'Small-Cap',MTUM:'Momentum',IPO:'IPOs'};




// â”€â”€ Overall Market Indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcOverall(secData, indData, trendData, vix, mcScores) {
  // 1. Sektor-Breadth (30%) â€” max Â±30
  const secs = Object.values(secData);
  const n_sec = secs.length;
  const pct_sec_50 = secs.filter(s=>s.above50).length / n_sec;
  const pct_sec_rs = secs.filter(s=>s.rs>=60).length / n_sec;
  const score_sec  = (pct_sec_50*2-1)*15 + (pct_sec_rs*2-1)*15;

  // 2. Industry-Breadth (30%) â€” max Â±30
  const inds = Object.values(indData);
  const n_ind = inds.length;
  const pct_ind_50 = inds.filter(i=>i.above50).length / n_ind;
  const pct_ind_rs = inds.filter(i=>i.rs>=60).length / n_ind;
  const score_ind  = (pct_ind_50*2-1)*15 + (pct_ind_rs*2-1)*15;

  // 3. Trend Status (25%) â€” max Â±25
  const syms = ['SPY','RSP','QQQ','QQQE','IWM'];
  const keys = ['ema9','ema21','ema50','ema200','d3ema21','w52h'];
  let pos=0, total=0;
  syms.forEach(sym => {
    keys.forEach(k => {
      const v = trendData[sym]?.[k];
      if (v==null) return;
      total++;
      if (typeof v==='boolean' ? v : v>=0) pos++;
    });
  });
  const score_trend = total>0 ? (pos/total*2-1)*25 : 0;

  // 4. VIX (5%) â€” max Â±5
  const score_vix = vix==null?0 : vix<15?5 : vix<18?2.5 : vix<22?0 : vix<28?-2.5 : -5;

  // 5. MC-Scores (10%) â€” max Â±10
  const avg_mc = mcScores.length ? mcScores.reduce((a,b)=>a+b,0)/mcScores.length : 0;
  const score_mc = (avg_mc/100)*10;

  const gesamt = Math.max(-100, Math.min(100, score_sec+score_ind+score_trend+score_vix+score_mc));
  return {
    gesamt,
    rows: [
      {lbl:`Sektor-Breadth`,          score:score_sec,   weight:'30%', detail:`${Math.round(pct_sec_50*100)}% >50SMA, ${Math.round(pct_sec_rs*100)}% RSâ‰¥60`},
      {lbl:`Industry-Breadth`,        score:score_ind,   weight:'30%', detail:`${Math.round(pct_ind_50*100)}% >50SMA, ${Math.round(pct_ind_rs*100)}% RSâ‰¥60`},
      {lbl:`Trend Status`,            score:score_trend, weight:'25%', detail:`${pos}/${total} positiv`},
      {lbl:`VIX ${vix!=null?'('+vix.toFixed(2)+')':''}`, score:score_vix, weight:'5%', detail:''},
      {lbl:`MC-Scores Ã˜`,             score:score_mc,    weight:'10%', detail:`Ã˜ ${avg_mc.toFixed(1)}`},
    ]
  };
}

function renderOverall(result, vix) {
  const {gesamt, rows} = result;
  const zone  = gesamt>=60?'STRONGLY BULLISH':gesamt>=30?'BULLISH':gesamt<=-60?'STRONGLY BEARISH':gesamt<=-30?'BEARISH':'NEUTRAL';
  const color = gesamt>=30?'var(--green)':gesamt<=-30?'var(--red)':'var(--yellow)';

  // Gauge: semicircle 204px arc, map -100..+100 â†’ offset 204..0
  const pct    = (gesamt+100)/200;
  const offset = 204 - pct*204;
  const arc = document.getElementById('gaugeArc');
  const val = document.getElementById('gaugeVal');
  const lbl = document.getElementById('gaugeLbl');
  if(arc){ arc.style.strokeDashoffset=offset; arc.style.stroke=color; }
  if(val){ val.textContent=(gesamt>=0?'+':'')+gesamt.toFixed(1); val.setAttribute('fill',color); }
  if(lbl){ lbl.textContent=zone; lbl.style.color=color; }

  // Table
  const tb = document.getElementById('overallTbl');
  if(!tb) return;
  tb.innerHTML = rows.map(r => {
    const c = r.score>0?'var(--green)':r.score<0?'var(--red)':'var(--muted)';
    return `<tr style="border-bottom:1px solid var(--border);">
      <td style="font-family:var(--mono);font-size:11px;padding:7px 12px;color:var(--text);">
        ${r.lbl}
        ${r.detail?`<br><span style="font-size:9px;color:var(--muted);">${r.detail}</span>`:''}
      </td>
      <td style="font-family:var(--mono);font-size:12px;font-weight:600;padding:7px 12px;text-align:right;color:${c};">${r.score>=0?'+':''}${r.score.toFixed(1)}</td>
      <td style="font-family:var(--mono);font-size:11px;padding:7px 12px;text-align:right;color:var(--muted);white-space:nowrap;">${r.weight}</td>
    </tr>`;
  }).join('') +
  `<tr style="border-top:2px solid var(--border);">
    <td style="font-family:var(--mono);font-size:13px;font-weight:700;padding:10px 16px;color:var(--text);">GESAMT</td>
    <td style="font-family:var(--mono);font-size:15px;font-weight:700;padding:10px 16px;text-align:right;color:${color};">${gesamt>=0?'+':''}${gesamt.toFixed(1)}</td>
    <td style="font-family:var(--mono);font-size:11px;font-weight:700;padding:8px 12px;text-align:right;color:${color};white-space:nowrap;">${zone}</td>
  </tr>`;
}

async function loadIndices() {
  const [quotesData, vixRes] = await Promise.all([
    getQuotes(IDX_SYMS),
    fetch(`${API}?type=vix`).then(r=>r.json()).catch(()=>({}))
  ]);
  const row = document.getElementById('idxRow'); row.innerHTML='';
  IDX_SYMS.forEach((sym,i) => {
    const q=quotesData[sym]; const price=q?.c||0, prev=q?.pc||0;
    const chg=prev>0?(price-prev)/prev*100:0;
    const disp=sym==='BINANCE:BTCUSDT'?'BTC':sym;
    const pstr=sym==='BINANCE:BTCUSDT'?'$'+Math.round(price).toLocaleString():'$'+price.toFixed(2);
    row.innerHTML+=`<div class="ic"><div class="tk">${disp}</div><div class="pr">${pstr}</div>
      <div class="ch ${chg>=0?'up':'dn'}">${chg>=0?'+':''}${chg.toFixed(2)}%</div>
      <div class="nm">${IDX_META[sym]}</div></div>`;
  });
  const vix=vixRes.vix;
  // Always render VIX box (show â€” if data unavailable)
  row.innerHTML+=`<div class="ic"><div class="tk">VIX</div><div class="pr">${vix!=null?vix.toFixed(2):'â€”'}</div>
    <div class="ch" style="color:var(--muted)">â€”</div><div class="nm">VOLATILITY</div></div>`;
  return {quotes:quotesData, vix};
}

// â”€â”€ 2. Market Conditions (Pine Score) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Generische Funktion fÃ¼r SPY, RSP, IWM, QQQE
async function calcMCScore(closes, breadthData) {
  const c=closes;
  if (!c || c.length < 50) return null;
  const price=c[c.length-1], c8ago=c[c.length-9]||c[0];
  const e8=emaCalc(c.slice(-40),8), e21=emaCalc(c.slice(-100),21);
  const s50=sma(c,50), s200=sma(c,200);
  const calcRSI=(arr,n=14)=>{let g=0,l=0;for(let i=arr.length-n;i<arr.length;i++){const d=arr[i]-arr[i-1];d>0?g+=d:l+=Math.abs(d);}return 100-100/(1+(g/n)/(l/n+1e-10));};
  const rsi=calcRSI(c);
  const momentum=(price-c8ago)/c8ago*100;
  const atr10=c.slice(-10).reduce((s,v,i,a)=>s+Math.abs(v-(a[i-1]||v)),0)/10;
  const atrAvg=c.slice(-22,-10).reduce((s,v,i,a)=>s+Math.abs(v-(a[i-1]||v)),0)/12;
  const atrRatio=atrAvg>0?atr10/atrAvg:1;
  const volStatus=atrRatio>1.4?'HIGH':atrRatio>1.1?'MOD':atrRatio<0.7?'LOW':'NORMAL';
  const maAlignBull=e8>e21&&e21>s50&&price>e21;
  const maAlignBear=e8<e21&&e21<s50&&price<e21;
  const maStr=((e8-s50)/s50*100).toFixed(2);
  const {moVal,p50Val,hlVal} = breadthData;
  const rsiW=25,maW=35,volW=20,brdW=12,nhW=8;
  const rsiScore=rsi>75?rsiW:rsi>65?rsiW*.72:rsi>55?rsiW*.48:rsi>50?rsiW*.24:rsi<25?-rsiW:rsi<35?-rsiW*.72:rsi<45?-rsiW*.48:-rsiW*.24;
  const alignBonus=Math.abs(parseFloat(maStr))>5?maW*.167:0;
  const maScore=maAlignBull?maW+alignBonus:maAlignBear?-(maW+alignBonus):price>s50&&e8>e21?maW*.6:price<s50&&e8<e21?-maW*.6:price>s50?maW*.333:-maW*.333;
  const momDir=momentum>0?1:-1,hasMom=Math.abs(momentum)>1.5;
  const volScore=atrRatio>1.4&&hasMom?volW*momDir:atrRatio>1.1&&hasMom?volW*.6*momDir:atrRatio>1.4?volW*.4*momDir:atrRatio<0.7?-volW*.25:0;
  const brdScore=moVal!=null?(moVal>60?brdW:moVal>20?brdW*.6:moVal>0?brdW*.25:moVal<-60?-brdW:moVal<-20?-brdW*.6:-brdW*.25):(p50Val!=null?(p50Val>70?brdW:p50Val>55?brdW*.5:p50Val<30?-brdW:p50Val<45?-brdW*.5:0):0);
  const nhScore=hlVal!=null?(hlVal>50?nhW:hlVal>20?nhW*.625:hlVal>0?nhW*.25:hlVal<-50?-nhW:hlVal<-20?-nhW*.625:-nhW*.25):0;
  const trendScore=Math.max(-100,Math.min(100,rsiScore*1.1+maScore+volScore+brdScore+nhScore));
  return {trendScore,rsi,momentum,volStatus,atrRatio,maAlignBull,maAlignBear,maStr,s50,s200,price,
          rsiScore,maScore,volScore,brdScore,nhScore,moVal,p50Val,hlVal};
}

function renderMCPanel(ids, data) {
  const {badgeId,scoreId,barId,checksId,breadthId} = ids;
  const {trendScore,rsi,momentum,volStatus,atrRatio,maAlignBull,maAlignBear,maStr,s200,price,
         rsiScore,maScore,volScore,brdScore,nhScore,moVal,p50Val,hlVal} = data;
  const tr       = Math.round(trendScore*10)/10;
  const zone     = trendScore>=30?'BULLISH':trendScore<=-30?'BEARISH':'NEUTRAL';
  const zoneCls  = trendScore>=30?'pos':trendScore<=-30?'neg':'neu';
  const zoneColor= trendScore>=30?'var(--green)':trendScore<=-30?'var(--red)':'var(--yellow)';
  const _mom = (typeof momentum==='number'&&!isNaN(momentum))?momentum:0;
  const _vs  = volStatus||'N/A';
  const _rsi = (typeof rsi==='number'&&!isNaN(rsi))?rsi:50;
  const spy200pct = price&&s200 ? ((price/s200-1)*100) : 0;
  const maStr2 = parseFloat(maStr)||0;
  const breadthVal = moVal!=null ? moVal.toFixed(0) : p50Val!=null ? p50Val.toFixed(1)+'%' : 'â€”';
  const breadthLbl = moVal!=null ? 'McC.Osc' : '%>50SMA';

  // Badge + Score
  const badge = document.getElementById(badgeId);
  badge.textContent = zone;
  badge.className = `mc-badge ${zoneCls}`;
  const scoreEl = document.getElementById(scoreId);
  scoreEl.textContent = (tr>=0?'+':'')+tr;
  scoreEl.style.color = zoneColor;

  // Hide old bar
  const bar = document.getElementById(barId);
  if(bar) bar.style.display='none';

  // Rows â€” Factors style: label left, value right
  const rows = [
    { lbl:'MA Alignment', val: (maAlignBull?'Bull':maAlignBear?'Bear':'Mixed'),
      sub: (maStr2>=0?'+':'')+maStr2.toFixed(2)+'%',
      cls: maAlignBull?'up':maAlignBear?'dn':'' },
    { lbl:'RSI (14)',     val: _rsi.toFixed(1)+'',
      sub:'', cls: _rsi>55?'up':_rsi<45?'dn':'' },
    { lbl:'Momentum',     val: (_mom>=0?'+':'')+_mom.toFixed(2)+'%',
      sub:'', cls: _mom>0?'up':_mom<0?'dn':'' },
    { lbl:'Volatility',   val: _vs,
      sub:'', cls: atrRatio>1.4?'dn':atrRatio<0.7?'up':'' },
    { lbl:'Breadth',      val: breadthLbl,
      sub: breadthVal, cls: moVal!=null?(moVal>0?'up':'dn'):p50Val!=null?(p50Val>50?'up':'dn'):'' },
    { lbl:'MA Strength',  val: (maStr2>=0?'+':'')+maStr2.toFixed(2)+'%',
      sub:'', cls: maStr2>0?'up':maStr2<0?'dn':'' },
    { lbl:'/200 SMA',     val: (spy200pct>=0?'+':'')+spy200pct.toFixed(2)+'%',
      sub:'', cls: spy200pct>0?'up':'dn' },
  ];

  document.getElementById(checksId).innerHTML = rows.map(r=>`
    <div class="fr">
      <span class="lbl">${r.lbl}</span>
      <span class="val ${r.cls}">${r.val}${r.sub?` <span style="font-size:10px;opacity:.75">${r.sub}</span>`:''}</span>
    </div>`).join('');

  // Hide old breadth tiles
  const brd = document.getElementById(breadthId);
  if(brd) brd.style.display='none';
}


async function loadAllMarketConditions(candleData, breadthData) {
  const syms=['QQQE','RSP','IWM'];
  const idList=[
    {badgeId:'mcBadge3',scoreId:'mcScore3',barId:'mcBar3',checksId:'mcChecks3',breadthId:'mcBreadth3'},
    {badgeId:'mcBadge', scoreId:'mcScore', barId:'mcBar', checksId:'mcChecks', breadthId:'mcBreadth'},
    {badgeId:'mcBadge2',scoreId:'mcScore2',barId:'mcBar2',checksId:'mcChecks2',breadthId:'mcBreadth2'},
  ];
  const allScores = [];
  for(let i=0;i<syms.length;i++){
    const c=clean(candleData[syms[i]]?.c||[]);
    if(c.length<50) continue;
    const scores=await calcMCScore(c, breadthData);
    if(scores) {
      renderMCPanel(idList[i], scores);
      allScores.push(scores.trendScore);
    }
  }
  if (allScores.length) {
    const ovResult = calcOverall(window._secArr||{}, window._indArr||{}, window._trendData||{}, window._vix||null, allScores);
    renderOverall(ovResult);
  }
}

// â”€â”€ 3. Trend Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TREND_LABELS=[['ema9','9 EMA'],['ema21','21 EMA'],['ema50','50 EMA'],['ema200','200 EMA'],['d3ema21','3D>21 EMA'],['w52h','52W High']];

async function loadTrend(candleData) {
  const syms=['SPY','RSP','QQQ','QQQE','IWM'];
  const result={};
  syms.forEach(sym=>{
    const c=clean(candleData[sym]?.c||[]); if(c.length<50) return;
    const price=c[c.length-1];
    const e9=emaCalc(c.slice(-50),9),e21=emaCalc(c.slice(-100),21),e50=emaCalc(c.slice(-200),50),e200=emaCalc(c,200);
    const h52=Math.max(...c.slice(-252));
    result[sym]={ema9:(price-e9)/e9*100,ema21:(price-e21)/e21*100,ema50:(price-e50)/e50*100,ema200:(price-e200)/e200*100,
      d3ema21:c.slice(-3).every(v=>v>emaCalc(c.slice(-100),21)),w52h:(price-h52)/h52*100};
  });
  return result;
}

function renderTrend(data) {
  const tb=document.getElementById('trendTbl'); tb.innerHTML='';
  if(!data) return;
  TREND_LABELS.forEach(([key,label])=>{
    const tr2=document.createElement('tr'); let cells=`<td>${label}</td>`;
    ['SPY','RSP','QQQ','QQQE','IWM'].forEach(t=>{
      const v=data[t]?.[key];
      if(v==null){cells+='<td>â€”</td>';return;}
      if(typeof v==='boolean') cells+=`<td class="${v?'ty':'tn'}">${v?'Yes':'No'}</td>`;
      else cells+=`<td class="${v>=0?'up':'dn'}">${v>=0?'+':''}${v.toFixed(2)}%</td>`;
    });
    tr2.innerHTML=cells; tb.appendChild(tr2);
  });
}

// â”€â”€ 4. Power Trend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPT(candleData) {
  const c=clean(candleData['QQQ']?.c||[]); if(c.length<50) return null;
  const avg3=(c[c.length-1]+c[c.length-2]+c[c.length-3])/3;
  const s20=sma(c,20),s50=sma(c,50),s200=sma(c,200);
  return {sma3d20:avg3>s20,sma3d50:avg3>s50,sma3d200:avg3>s200,sma20_50:s20>s50,sma20_200:s20>s200,sma50_200:s50>s200};
}

async function loadYields() {
  try{const data=await getCandles(['^TNX','^IRX'],'5d');
  const getLast=sym=>{const c=clean(data[sym]?.c||[]);return c.length?c[c.length-1]:null;};
  return{y10:getLast('^TNX'),y2:getLast('^IRX')};}catch(e){return{};}
}

function renderPT(data,yields) {
  const el=document.getElementById('ptEl'); el.innerHTML='';
  [['sma3d20','3D > 20 SMA'],['sma3d50','3D > 50 SMA'],['sma3d200','3D > 200 SMA'],
   ['sma20_50','20 > 50 SMA'],['sma20_200','20 > 200 SMA'],['sma50_200','50 > 200 SMA']].forEach(([k,l])=>{
    const d2=document.createElement('div');d2.className='ptr';
    const v=data?.[k];
    d2.innerHTML=`<span class="lbl">${l}</span><span class="val ${v==null?'vnum':v?'vyes':'vno'}">${v==null?'â€”':v?'Yes':'No'}</span>`;
    el.appendChild(d2);
  });
  [['y10','US 10Y Yield'],['y2','US 02Y Yield']].forEach(([k,l])=>{
    const d2=document.createElement('div');d2.className='ptr';
    const v=yields?.[k];
    d2.innerHTML=`<span class="lbl">${l}</span><span class="val vnum">${v!=null?v.toFixed(2):'â€”'}</span>`;
    el.appendChild(d2);
  });
}

// â”€â”€ 5. Factors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function loadFactors(candleData, spyMth) {
  return FAC_SYMS.map(sym=>{
    const c=clean(candleData[sym]?.c||[]);
    if(c.length<2) return{label:FAC_LBLS[sym],val:0};
    return{label:FAC_LBLS[sym],val:+((c[c.length-1]/c[0]-1)*100-spyMth).toFixed(2)};
  });
}

function renderFac(data) {
  const el=document.getElementById('facEl'); el.innerHTML='';
  data.forEach(r=>{
    const d2=document.createElement('div');d2.className='fr';
    d2.innerHTML=`<span class="lbl">${r.label}</span><span class="val ${r.val>=0?'up':'dn'}">${r.val>=0?'+':''}${r.val.toFixed(2)}%</span>`;
    el.appendChild(d2);
  });
}

// â”€â”€ 6. Sectors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// â”€â”€ 7. Industry Groups â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function calcSectorData(sym, c, spyDay, spyWk, spyMth, nameMap) {
  if(c.length<5) return null;
  const price=c[c.length-1];
  const day=(price/c[c.length-2]-1)*100;
  const wk=c.length>6?(price/c[c.length-6]-1)*100:0;
  const mth=c.length>22?(price/c[c.length-22]-1)*100:0;
  const h52=Math.max(...c.slice(-252));
  const rs=Math.min(100,Math.max(0,Math.round(50+(mth-spyMth)*3)));
  const s50c=sma(c,50);
  return{name:nameMap[sym]||sym,price:price.toFixed(2),
    day:+day.toFixed(2),wk:+wk.toFixed(2),mth:+mth.toFixed(2),
    rs_day:+(day-spyDay).toFixed(2),rs_wk:+(wk-spyWk).toFixed(2),rs_mth:+(mth-spyMth).toFixed(2),
    high52:+((price/h52-1)*100).toFixed(2),rs,above50:price>s50c};
}

async function loadSectors(candleData, spyDay, spyWk, spyMth) {
  const result={};
  SEC_SYMS.forEach(sym=>{
    const c=clean(candleData[sym]?.c||[]);
    const d=calcSectorData(sym,c,spyDay,spyWk,spyMth,SEC_NAMES);
    if(d) result[sym]=d;
  });
  return result;
}

async function loadIndustries(candleData, spyDay, spyWk, spyMth) {
  const result={};
  IND_SYMS.forEach(sym=>{
    const c=clean(candleData[sym]?.c||[]);
    const d=calcSectorData(sym,c,spyDay,spyWk,spyMth,IND_NAMES);
    if(d) result[sym]=d;
  });
  return result;
}

function renderTable(tbodyId, data) {
  const tb=document.getElementById(tbodyId); tb.innerHTML='';
  const sorted=Object.entries(data).sort((a,b)=>b[1].rs-a[1].rs);
  sorted.forEach(([sym,s])=>{
    const tr2=document.createElement('tr');
    tr2.innerHTML=`<td><div class="rsc ${rsClass(s.rs)}">${s.rs}</div></td>
      <td class="tck">${sym}</td><td class="tname">${s.name}</td>
      <td class="nc">${pct(s.day,1)}</td><td class="nc">${pct(s.wk,1)}</td><td class="nc">${pct(s.mth,1)}</td>
      <td class="nc">${pct(s.rs_day)}</td><td class="nc">${pct(s.rs_wk)}</td><td class="nc">${pct(s.rs_mth)}</td>
      <td class="nc"><span class="${s.high52<-3?'dn':s.high52<0?'':'up'}">${s.high52.toFixed(1)}%</span></td>`;
    tb.appendChild(tr2);
  });
  return Object.entries(data).sort((a,b)=>b[1].rs-a[1].rs);
}

function renderRSGainers(elId, sortedData) {
  const el=document.getElementById(elId);
  const topD=[...sortedData].sort((a,b)=>b[1].day-a[1].day).slice(0,3);
  const topW=[...sortedData].sort((a,b)=>b[1].wk-a[1].wk).slice(0,3);
  const topM=[...sortedData].sort((a,b)=>b[1].mth-a[1].mth).slice(0,3);
  const card=(sym,s,val,cls)=>`<div class="rsi">
    <div class="rsb ${rsGB(s.rs)}">RS:${s.rs}</div>
    <div class="ri"><div class="tn2">${sym}</div><div class="sc">${s.name}</div></div>
    <div class="rr"><div class="rp">$${s.price}</div>
    <div class="rc ${cls}">${val>=0?'+':''}${val.toFixed(2)}%</div></div></div>`;
  el.style.display='grid'; el.style.gridTemplateColumns='1fr 1fr 1fr'; el.style.gap='0';
  el.innerHTML=
    '<div class="rss"><div class="slbl">Daily</div>'+topD.map(([s,v])=>card(s,v,v.day,v.day>=0?'up':'dn')).join('')+'</div>'+
    '<div class="rss"><div class="slbl">Weekly</div>'+topW.map(([s,v])=>card(s,v,v.wk,v.wk>=0?'up':'dn')).join('')+'</div>'+
    '<div class="rss"><div class="slbl">Monthly</div>'+topM.map(([s,v])=>card(s,v,v.mth,v.mth>=0?'up':'dn')).join('')+'</div>';
}

// â”€â”€ Main Refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function refreshAll() {
  setStatus('loading','Loadingâ€¦');
  document.getElementById('errBanner').classList.remove('show');
  try {
    // All symbols to fetch
    const mainSyms = ['SPY','RSP','QQQ','QQQE','IWM',...SEC_SYMS,...IND_SYMS,...FAC_SYMS,'^TNX','^IRX'];

    const [idxData, candleData, breadthRaw] = await Promise.all([
      loadIndices(),
      getCandles(mainSyms, '6mo'),
      fetch(`${API}?type=breadth`).then(r=>r.json()).catch(()=>({}))
    ]);

    const breadthData = {moVal:breadthRaw.nymo??null, p50Val:breadthRaw.pct50??null, hlVal:breadthRaw.nyhl??null};
    console.log('Breadth raw:', JSON.stringify(breadthRaw));

    // SPY perf for RS calculations
    const spyC=clean(candleData['SPY']?.c||[]);
    const spyPrice=spyC[spyC.length-1]||0;
    const spyDay=spyC.length>1?(spyPrice/spyC[spyC.length-2]-1)*100:0;
    const spyWk=spyC.length>6?(spyPrice/spyC[spyC.length-6]-1)*100:0;
    const spyMth=spyC.length>22?(spyPrice/spyC[spyC.length-22]-1)*100:0;

    // Run all in parallel
    const [trend, pt, yields, sectors, industries, factors] = await Promise.all([
      loadTrend(candleData),
      loadPT(candleData),
      loadYields(),
      loadSectors(candleData, spyDay, spyWk, spyMth),
      loadIndustries(candleData, spyDay, spyWk, spyMth),
      loadFactors(candleData, spyMth),
    ]);

    renderTrend(trend);
    // Overall Market Indicator
    const secArr = Object.fromEntries(Object.entries(sectors).map(([k,v])=>([k,{rs:v.rs,above50:v.above50}])));
    const indArr = Object.fromEntries(Object.entries(industries).map(([k,v])=>([k,{rs:v.rs,above50:v.above50}])));
    const vixVal = idxData.vix ?? null;
    window._secArr=secArr; window._indArr=indArr; window._trendData=trend; window._vix=vixVal;
    renderPT(pt, yields);
    renderFac(factors);
    const secSorted = renderTable('secTbl', sectors);
    const indSorted = renderTable('indTbl', industries);
    renderRSGainers('rsEl',    secSorted);
    renderRSGainers('rsIndEl', indSorted);

    await loadAllMarketConditions(candleData, breadthData);

    setStatus('live','Live Â· 5 min');
    document.getElementById('lastUpd').textContent =
      'Updated '+new Date().toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});
  } catch(e) {
    console.error(e);
    setStatus('error','Fehler');
    document.getElementById('errBanner').classList.add('show');
  }
}

function init() {
  // v1772004392 â€” force cache clear on version mismatch
  const _V = 'v1772004392';
  if (sessionStorage.getItem('dv') !== _V) {
    sessionStorage.setItem('dv', _V);
    if (performance.navigation?.type !== 1) { location.reload(true); return; }
  }
  refreshAll();
  setInterval(refreshAll, REFRESH);
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>