<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Markets">
<meta name="theme-color" content="#0a0b0e" id="themeColorMeta">
<title>Market Dashboard</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
/* ══════════════════════════════════════════════════════
   CSS Variables — Dark & Light Theme
══════════════════════════════════════════════════════ */
:root {
  --green:#00d084; --red:#ff4466; --yellow:#f5c842; --blue:#4d9fff; --accent:#7c6af7;
  --mono:'IBM Plex Mono',monospace; --sans:'IBM Plex Sans',sans-serif;
  --radius:8px; --gap:10px;
  --transition: background .25s, color .25s, border-color .25s;
}
[data-theme="dark"] {
  --bg:#0a0b0e; --surface:#111318; --surface2:#171b22; --border:#1e2330;
  --text:#e8eaf0; --muted:#5a6070; --th-btn:#1e2535;
}
[data-theme="light"] {
  --bg:#f0f2f5; --surface:#ffffff; --surface2:#f7f8fa; --border:#e2e6ed;
  --text:#1a1d24; --muted:#8a94a6; --th-btn:#e8ecf2;
  --green:#00a864; --red:#d63050; --yellow:#c8971a; --blue:#2b7fd4; --accent:#5c4fd6;
}

/* ── Reset ── */
*{margin:0;padding:0;box-sizing:border-box;}
body {
  background:var(--bg); color:var(--text);
  font-family:var(--sans); min-height:100vh;
  padding: env(safe-area-inset-top,12px) env(safe-area-inset-right,16px)
           env(safe-area-inset-bottom,16px) env(safe-area-inset-left,16px);
  transition: var(--transition);
}

/* ══ LOGIN SCREEN ══════════════════════════════════════ */
#loginScreen {
  position:fixed;inset:0;z-index:1000;
  background:var(--bg);
  display:flex;align-items:center;justify-content:center;
  flex-direction:column;gap:20px;
  transition:opacity .3s;
}
#loginScreen.hidden{opacity:0;pointer-events:none;}
.login-box {
  background:var(--surface);border:1px solid var(--border);
  border-radius:14px;padding:32px 28px;width:320px;max-width:90vw;
  box-shadow:0 20px 60px rgba(0,0,0,.4);
}
.login-logo {
  font-family:var(--mono);font-size:11px;letter-spacing:.2em;
  color:var(--muted);text-transform:uppercase;text-align:center;margin-bottom:24px;
}
.login-logo span{display:block;font-size:22px;letter-spacing:.05em;color:var(--text);margin-bottom:6px;}
.login-box input {
  width:100%;background:var(--surface2);border:1px solid var(--border);
  border-radius:7px;padding:11px 14px;color:var(--text);
  font-family:var(--mono);font-size:14px;outline:none;
  transition:border-color .2s;margin-bottom:12px;
}
.login-box input:focus{border-color:var(--accent);}
.login-box input::placeholder{color:var(--muted);}
.login-btn {
  width:100%;padding:11px;border:none;border-radius:7px;
  background:var(--accent);color:#fff;font-family:var(--mono);
  font-size:13px;font-weight:600;cursor:pointer;letter-spacing:.05em;
  transition:opacity .2s;
}
.login-btn:hover{opacity:.85;}
.login-err{color:var(--red);font-family:var(--mono);font-size:11px;text-align:center;height:14px;}

/* ══ HEADER ════════════════════════════════════════════ */
.hdr {
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:14px;padding-bottom:12px;border-bottom:1px solid var(--border);
  gap:10px;flex-wrap:wrap;
}
.hdr h1{font-family:var(--mono);font-size:12px;letter-spacing:.15em;color:var(--muted);text-transform:uppercase;}
.hdr-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.dt{font-family:var(--mono);font-size:12px;color:var(--muted);}
.last-upd{font-family:var(--mono);font-size:12px;color:var(--muted);}

/* Theme toggle */
.th-btn {
  width:32px;height:32px;border-radius:50%;border:1px solid var(--border);
  background:var(--th-btn);cursor:pointer;display:flex;align-items:center;
  justify-content:center;font-size:15px;transition:all .2s;flex-shrink:0;
}
.th-btn:hover{border-color:var(--accent);}

/* Status pill */
.pill {
  font-family:var(--mono);font-size:12px;padding:5px 12px;
  border-radius:10px;border:1px solid var(--border);
  color:var(--muted);display:flex;align-items:center;gap:5px;
  cursor:pointer;transition:all .2s;white-space:nowrap;
}
.pill:hover{border-color:var(--accent);}
.pill.live{border-color:rgba(0,208,132,.4);color:var(--green);}
.pill.error{border-color:rgba(255,68,102,.4);color:var(--red);}
.pill.loading{border-color:rgba(77,159,255,.4);color:var(--blue);}
.dot{width:6px;height:6px;border-radius:50%;background:currentColor;flex-shrink:0;}
.pulse{animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* ══ INDEX CARDS ═══════════════════════════════════════ */
.idx{display:grid;grid-template-columns:repeat(7,1fr);gap:10px;margin-bottom:14px;}
.ic{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px 16px;min-height:90px;display:flex;flex-direction:column;justify-content:space-between;transition:var(--transition),border-color .2s;cursor:pointer;}
.ic:hover{border-color:var(--accent);}
.ic .tk{font-family:var(--mono);font-size:12px;color:var(--muted);letter-spacing:.1em;margin-bottom:5px;}
.ic .pr{font-family:var(--mono);font-size:20px;font-weight:500;margin-bottom:4px;}
.ic .ch{font-family:var(--mono);font-size:13px;font-weight:600;margin-bottom:5px;}
.ic .nm{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;}
.up{color:var(--green);} .dn{color:var(--red);}

/* ══ PANELS ════════════════════════════════════════════ */
.pnl{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;transition:var(--transition);}
.ph{padding:11px 15px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:7px;}
.ph::before{content:'';display:block;width:3px;height:12px;background:var(--accent);border-radius:2px;flex-shrink:0;}
.ph h3{font-family:var(--mono);font-size:12px;letter-spacing:.11em;text-transform:uppercase;font-weight:500;}


/* ══ LAYOUT ════════════════════════════════════════════ */
/* Zeile 1: Market Conditions | Performance | Trend (full width) */
.r1{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap);margin-bottom:var(--gap);}
/* Zeile 2: Power Trend | Factors | RS Gainers (full width) */
.rtd{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-bottom:var(--gap);}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}
/* Zeile 3: RS Gainers sidebar | Sector Table */
.r2{display:grid;grid-template-columns:320px 1fr;gap:var(--gap);margin-bottom:var(--gap);}

@media(max-width:1400px){.r1b{grid-template-columns:200px 240px 1fr}.r2{grid-template-columns:280px 1fr}}.rtd{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-bottom:var(--gap);}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}}
  .rtd{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-bottom:var(--gap);}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}
}
@media(max-width:1200px){.r1{grid-template-columns:1fr;}.r1b{grid-template-columns:1fr 1fr;}.r2{grid-template-columns:1fr;}}.r1 .pnl:nth-child(3){grid-column:1/-1;}.rtd{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-bottom:var(--gap);}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}}
  .r1 .pnl:nth-child(3){grid-column:1/-1;}
  .rtd{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-bottom:var(--gap);}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}
}
@media(max-width:1024px){.r1b{grid-template-columns:1fr 1fr;}}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}}
  .rtd{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-bottom:var(--gap);}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}
}
@media(max-width:768px){
  .idx{grid-template-columns:repeat(4,1fr);}
  .r1,.rtd{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-bottom:var(--gap);}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}
  .r1 .pnl{grid-column:auto;}
}
@media(max-width:540px){
  .idx{grid-template-columns:repeat(2,1fr);}
  .r1,.r1b,.r2{display:grid;grid-template-columns:320px 1fr;gap:var(--gap);margin-bottom:var(--gap);}
  body{padding:10px 10px calc(env(safe-area-inset-bottom,10px) + 10px);}
}

/* ══ MARKET CONDITIONS ═════════════════════════════════ */
.mc{padding:11px 13px;}
.mc-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.mc-badge{font-family:var(--mono);font-size:13px;font-weight:600;padding:4px 12px;border-radius:4px;}
.mc-badge.neg{background:rgba(255,68,102,.15);color:var(--red);border:1px solid rgba(255,68,102,.3);}
.mc-badge.pos{background:rgba(0,208,132,.15);color:var(--green);border:1px solid rgba(0,208,132,.3);}
.mc-badge.neu{background:rgba(90,96,112,.2);color:var(--muted);border:1px solid rgba(90,96,112,.2);}
.mc-pct{font-family:var(--mono);font-size:17px;font-weight:600;}
.mc-sub{font-family:var(--mono);font-size:9px;color:var(--muted);margin-bottom:8px;}
.mc-chart{height:52px;}
.mc-chart svg{width:100%;height:100%;}

/* ══ PERF TABLE ════════════════════════════════════════ */
.ptable{width:100%;border-collapse:collapse;font-family:var(--mono);font-size:12px;table-layout:fixed;}
.ptable th{padding:8px 10px;font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;border-bottom:1px solid var(--border);text-align:center;font-weight:500;}
.ptable td{padding:8px 10px;text-align:center;border-bottom:1px solid rgba(125,130,145,.12);font-size:12px;}
.ptable tr:last-child td{border-bottom:none;}
.bdg{display:inline-block;padding:2px 7px;border-radius:3px;font-size:12px;font-weight:600;}
.bp{background:rgba(0,208,132,.15);color:var(--green);}
.bn{background:rgba(255,68,102,.12);color:var(--red);}
.bu{background:rgba(90,96,112,.18);color:var(--muted);}
.tlo{display:grid;grid-template-columns:repeat(6,1fr);padding:10px 12px;gap:4px;border-top:1px solid var(--border);}
.tlo-c{text-align:center;}
.tlo-c .lbl{font-family:var(--mono);font-size:10px;color:var(--muted);margin-bottom:3px;text-align:center;}
.tlo-c .val{font-family:var(--mono);font-size:12px;margin-bottom:3px;text-align:center;}

/* ══ TREND STATUS ══════════════════════════════════════ */
.ts{width:100%;border-collapse:collapse;font-family:var(--mono);font-size:13px;}
.ts th{padding:8px 10px;font-size:12px;color:var(--muted);text-transform:uppercase;border-bottom:1px solid var(--border);text-align:center;font-weight:500;}
.ts th:first-child{text-align:left;}
.ts td{padding:8px 12px;text-align:center;border-bottom:1px solid rgba(125,130,145,.1);font-size:13px;}
.ts tr:last-child td{border-bottom:none;}
.ts td:first-child{text-align:left;color:var(--muted);font-size:12px;}
.ty{color:var(--green);font-weight:600;} .tn{color:var(--red);font-weight:600;}

/* ══ POWER TREND / FACTORS ════════════════════════════ */
.ptb,.fb{padding:12px 14px;}
.ptr,.fr{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(125,130,145,.1);}
.ptr:last-child,.fr:last-child{border-bottom:none;}
.ptr .lbl,.fr .lbl{font-family:var(--mono);font-size:12px;color:var(--muted);}
.ptr .val,.fr .val{font-family:var(--mono);font-size:12px;font-weight:600;}
.vno{color:var(--red);} .vyes{color:var(--green);} .vnum{color:var(--text);}

/* ══ RS GAINERS ════════════════════════════════════════ */
.rss{padding:10px;}
.rsi{display:flex;align-items:center;gap:8px;padding:7px 6px;border-radius:5px;transition:background .15s;cursor:pointer;}
.rsi:hover{background:var(--surface2);}
.rsb{font-family:var(--mono);font-size:12px;font-weight:600;padding:3px 6px;border-radius:3px;min-width:50px;text-align:center;flex-shrink:0;}
.r100{background:rgba(0,208,132,.15);color:var(--green);border:1px solid rgba(0,208,132,.3);}
.r65{background:rgba(245,200,66,.15);color:var(--yellow);border:1px solid rgba(245,200,66,.3);}
.r50{background:rgba(255,68,102,.1);color:var(--red);border:1px solid rgba(255,68,102,.2);}
.ri{flex:1;}
.ri .tn2{font-family:var(--mono);font-size:12px;font-weight:500;}
.ri .sc{font-size:12px;color:var(--muted);}
.rr{text-align:right;}
.rr .rp{font-family:var(--mono);font-size:12px;font-weight:500;}
.rr .rc{font-family:var(--mono);font-size:13px;font-weight:600;}
.slbl{font-family:var(--mono);font-size:12px;color:var(--muted);letter-spacing:.1em;text-transform:uppercase;padding:8px 4px 4px;}

/* ══ SECTOR TABLE ══════════════════════════════════════ */
.tw{overflow-x:auto;-webkit-overflow-scrolling:touch;}
table{width:100%;border-collapse:collapse;font-family:var(--mono);font-size:13px;}
thead th{padding:9px 10px;text-align:center;font-size:12px;letter-spacing:.06em;color:var(--muted);text-transform:uppercase;font-weight:500;border-bottom:1px solid var(--border);white-space:nowrap;}
tbody tr{border-bottom:1px solid rgba(125,130,145,.1);transition:background .15s;cursor:pointer;}
tbody tr:hover{background:var(--surface2);}
tbody tr:last-child{border-bottom:none;}
td{padding:9px 12px;white-space:nowrap;vertical-align:middle;}
.rsc{font-weight:600;font-size:12px;width:34px;height:22px;display:flex;align-items:center;justify-content:center;border-radius:3px;}
.rh{background:rgba(0,208,132,.2);color:var(--green);}
.rm{background:rgba(245,200,66,.15);color:var(--yellow);}
.rl{background:rgba(255,68,102,.12);color:var(--red);}
.rvl{background:rgba(255,68,102,.07);color:var(--red);opacity:.7;}
.tck{color:var(--blue);font-weight:500;font-size:13px;}
.tname{color:var(--text);font-family:var(--sans);font-size:13px;}
.nc{text-align:right;}

/* ══ TAG GRIDS ═════════════════════════════════════════ */
.tg{padding:9px;display:flex;flex-wrap:wrap;gap:5px;}
.tag{font-family:var(--mono);font-size:10px;padding:3px 7px;border-radius:3px;background:var(--surface2);border:1px solid var(--border);color:var(--text);transition:all .15s;cursor:pointer;position:relative;}
.tag:hover{border-color:var(--accent);color:var(--accent);}
.thl{background:rgba(0,208,132,.1);border-color:rgba(0,208,132,.3);color:var(--green);}
.tyw{background:rgba(245,200,66,.1);border-color:rgba(245,200,66,.25);color:var(--yellow);}
.tip{position:absolute;bottom:calc(100% + 4px);left:50%;transform:translateX(-50%);background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:2px 6px;font-size:9px;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .15s;z-index:10;}
.tag:hover .tip{opacity:1;}

/* ══ ERROR BANNER ══════════════════════════════════════ */
.err{background:rgba(255,68,102,.08);border:1px solid rgba(255,68,102,.2);border-radius:6px;padding:8px 12px;margin-bottom:10px;font-family:var(--mono);font-size:10px;color:var(--red);display:none;}
.err.show{display:block;}

/* ══ SKELETON ══════════════════════════════════════════ */
.sk{background:linear-gradient(90deg,var(--surface2) 25%,var(--border) 50%,var(--surface2) 75%);background-size:200% 100%;animation:shimmer 1.4s infinite;border-radius:3px;display:inline-block;}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

/* ══ MOBILE RESPONSIVE ═════════════════════════════════ */
@media(max-width:1400px){.r1b{grid-template-columns:200px 240px 1fr}.r2{grid-template-columns:280px 1fr}}.rtd{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-bottom:var(--gap);}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}}.rtd{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-bottom:var(--gap);}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}}
@media(max-width:1200px){.r1{grid-template-columns:1fr;}.r1b{grid-template-columns:1fr 1fr;}.r2{grid-template-columns:1fr;}}.r1 .pnl:nth-child(3){grid-column:1/-1;}.rtd{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-bottom:var(--gap);}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}}.r1 .pnl:nth-child(3){grid-column:1/-1;}.rtd{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-bottom:var(--gap);}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}}
@media(max-width:1024px){.r1b{grid-template-columns:1fr 1fr;}}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}}.rtd{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-bottom:var(--gap);}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}.r3{grid-template-columns:1fr 1fr;}}

@media(max-width:768px){
  .idx{grid-template-columns:repeat(4,1fr);}
  .r1,.r3{grid-template-columns:1fr 1fr;}
  .r1 .pnl{grid-column:auto;}
  .hdr-right .dt{display:none;}
}
@media(max-width:540px){
  .idx{grid-template-columns:repeat(2,1fr);}
  .r1,.r2,.r3{grid-template-columns:1fr;}
  body{padding:10px 10px calc(env(safe-area-inset-bottom,10px) + 10px);}
  .hdr h1 .label{display:none;}
}
</style>
</head>
<style>
/* ══════════════════════════════════════════════════════
   CSS Variables — Dark & Light Theme
══════════════════════════════════════════════════════ */
:root {
  --green:#00d084; --red:#ff4466; --yellow:#f5c842; --blue:#4d9fff; --accent:#7c6af7;
  --mono:'IBM Plex Mono',monospace; --sans:'IBM Plex Sans',sans-serif;
  --radius:8px; --gap:10px;
  --transition: background .25s, color .25s, border-color .25s;
}
[data-theme="dark"] {
  --bg:#0a0b0e; --surface:#111318; --surface2:#171b22; --border:#1e2330;
  --text:#e8eaf0; --muted:#5a6070; --th-btn:#1e2535;
}
[data-theme="light"] {
  --bg:#f0f2f5; --surface:#ffffff; --surface2:#f7f8fa; --border:#e2e6ed;
  --text:#1a1d24; --muted:#8a94a6; --th-btn:#e8ecf2;
  --green:#00a864; --red:#d63050; --yellow:#c8971a; --blue:#2b7fd4; --accent:#5c4fd6;
}

/* ── Reset ── */
*{margin:0;padding:0;box-sizing:border-box;}
body {
  background:var(--bg); color:var(--text);
  font-family:var(--sans); min-height:100vh;
  padding: env(safe-area-inset-top,12px) env(safe-area-inset-right,16px)
           env(safe-area-inset-bottom,16px) env(safe-area-inset-left,16px);
  transition: var(--transition);
}

/* ══ LOGIN SCREEN ══════════════════════════════════════ */
#loginScreen {
  position:fixed;inset:0;z-index:1000;
  background:var(--bg);
  display:flex;align-items:center;justify-content:center;
  flex-direction:column;gap:20px;
  transition:opacity .3s;
}
#loginScreen.hidden{opacity:0;pointer-events:none;}
.login-box {
  background:var(--surface);border:1px solid var(--border);
  border-radius:14px;padding:32px 28px;width:320px;max-width:90vw;
  box-shadow:0 20px 60px rgba(0,0,0,.4);
}
.login-logo {
  font-family:var(--mono);font-size:11px;letter-spacing:.2em;
  color:var(--muted);text-transform:uppercase;text-align:center;margin-bottom:24px;
}
.login-logo span{display:block;font-size:22px;letter-spacing:.05em;color:var(--text);margin-bottom:6px;}
.login-box input {
  width:100%;background:var(--surface2);border:1px solid var(--border);
  border-radius:7px;padding:11px 14px;color:var(--text);
  font-family:var(--mono);font-size:14px;outline:none;
  transition:border-color .2s;margin-bottom:12px;
}
.login-box input:focus{border-color:var(--accent);}
.login-box input::placeholder{color:var(--muted);}
.login-btn {
  width:100%;padding:11px;border:none;border-radius:7px;
  background:var(--accent);color:#fff;font-family:var(--mono);
  font-size:13px;font-weight:600;cursor:pointer;letter-spacing:.05em;
  transition:opacity .2s;
}
.login-btn:hover{opacity:.85;}
.login-err{color:var(--red);font-family:var(--mono);font-size:11px;text-align:center;height:14px;}

/* ══ HEADER ════════════════════════════════════════════ */
.hdr {
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:14px;padding-bottom:12px;border-bottom:1px solid var(--border);
  gap:10px;flex-wrap:wrap;
}
.hdr h1{font-family:var(--mono);font-size:12px;letter-spacing:.15em;color:var(--muted);text-transform:uppercase;}
.hdr-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.dt{font-family:var(--mono);font-size:12px;color:var(--muted);}
.last-upd{font-family:var(--mono);font-size:12px;color:var(--muted);}

/* Theme toggle */
.th-btn {
  width:32px;height:32px;border-radius:50%;border:1px solid var(--border);
  background:var(--th-btn);cursor:pointer;display:flex;align-items:center;
  justify-content:center;font-size:15px;transition:all .2s;flex-shrink:0;
}
.th-btn:hover{border-color:var(--accent);}

/* Status pill */
.pill {
  font-family:var(--mono);font-size:12px;padding:5px 12px;
  border-radius:10px;border:1px solid var(--border);
  color:var(--muted);display:flex;align-items:center;gap:5px;
  cursor:pointer;transition:all .2s;white-space:nowrap;
}
.pill:hover{border-color:var(--accent);}
.pill.live{border-color:rgba(0,208,132,.4);color:var(--green);}
.pill.error{border-color:rgba(255,68,102,.4);color:var(--red);}
.pill.loading{border-color:rgba(77,159,255,.4);color:var(--blue);}
.dot{width:6px;height:6px;border-radius:50%;background:currentColor;flex-shrink:0;}
.pulse{animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* ══ INDEX CARDS ═══════════════════════════════════════ */
.idx{display:grid;grid-template-columns:repeat(7,1fr);gap:10px;margin-bottom:14px;}
.ic{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px 16px;min-height:90px;display:flex;flex-direction:column;justify-content:space-between;transition:var(--transition),border-color .2s;cursor:pointer;}
.ic:hover{border-color:var(--accent);}
.ic .tk{font-family:var(--mono);font-size:12px;color:var(--muted);letter-spacing:.1em;margin-bottom:5px;}
.ic .pr{font-family:var(--mono);font-size:20px;font-weight:500;margin-bottom:4px;}
.ic .ch{font-family:var(--mono);font-size:13px;font-weight:600;margin-bottom:5px;}
.ic .nm{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;}
.up{color:var(--green);} .dn{color:var(--red);}

/* ══ PANELS ════════════════════════════════════════════ */
.pnl{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;transition:var(--transition);}
.ph{padding:11px 15px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:7px;}
.ph::before{content:'';display:block;width:3px;height:12px;background:var(--accent);border-radius:2px;flex-shrink:0;}
.ph h3{font-family:var(--mono);font-size:12px;letter-spacing:.11em;text-transform:uppercase;font-weight:500;}


/* ══ LAYOUT ════════════════════════════════════════════ */
/* Zeile 1: Market Conditions | Performance | Trend (full width) */
.r1{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap);margin-bottom:var(--gap);}
/* Zeile 2: Power Trend | Factors | RS Gainers (full width) */
.rtd{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-bottom:var(--gap);}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}
/* Zeile 3: RS Gainers sidebar | Sector Table */
.r2{display:grid;grid-template-columns:320px 1fr;gap:var(--gap);margin-bottom:var(--gap);}

@media(max-width:1400px){.r1b{grid-template-columns:200px 240px 1fr}.r2{grid-template-columns:280px 1fr}}.rtd{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-bottom:var(--gap);}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}}
  .rtd{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-bottom:var(--gap);}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}
}
@media(max-width:1200px){.r1{grid-template-columns:1fr;}.r1b{grid-template-columns:1fr 1fr;}.r2{grid-template-columns:1fr;}}.r1 .pnl:nth-child(3){grid-column:1/-1;}.rtd{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-bottom:var(--gap);}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}}
  .r1 .pnl:nth-child(3){grid-column:1/-1;}
  .rtd{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-bottom:var(--gap);}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}
}
@media(max-width:1024px){.r1b{grid-template-columns:1fr 1fr;}}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}}
  .rtd{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-bottom:var(--gap);}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}
}
@media(max-width:768px){
  .idx{grid-template-columns:repeat(4,1fr);}
  .r1,.rtd{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-bottom:var(--gap);}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}
  .r1 .pnl{grid-column:auto;}
}
@media(max-width:540px){
  .idx{grid-template-columns:repeat(2,1fr);}
  .r1,.r1b,.r2{display:grid;grid-template-columns:320px 1fr;gap:var(--gap);margin-bottom:var(--gap);}
  body{padding:10px 10px calc(env(safe-area-inset-bottom,10px) + 10px);}
}

/* ══ MARKET CONDITIONS ═════════════════════════════════ */
.mc{padding:11px 13px;}
.mc-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.mc-badge{font-family:var(--mono);font-size:13px;font-weight:600;padding:4px 12px;border-radius:4px;}
.mc-badge.neg{background:rgba(255,68,102,.15);color:var(--red);border:1px solid rgba(255,68,102,.3);}
.mc-badge.pos{background:rgba(0,208,132,.15);color:var(--green);border:1px solid rgba(0,208,132,.3);}
.mc-badge.neu{background:rgba(90,96,112,.2);color:var(--muted);border:1px solid rgba(90,96,112,.2);}
.mc-pct{font-family:var(--mono);font-size:17px;font-weight:600;}
.mc-sub{font-family:var(--mono);font-size:9px;color:var(--muted);margin-bottom:8px;}
.mc-chart{height:52px;}
.mc-chart svg{width:100%;height:100%;}

/* ══ PERF TABLE ════════════════════════════════════════ */
.ptable{width:100%;border-collapse:collapse;font-family:var(--mono);font-size:12px;table-layout:fixed;}
.ptable th{padding:8px 10px;font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;border-bottom:1px solid var(--border);text-align:center;font-weight:500;}
.ptable td{padding:8px 10px;text-align:center;border-bottom:1px solid rgba(125,130,145,.12);font-size:12px;}
.ptable tr:last-child td{border-bottom:none;}
.bdg{display:inline-block;padding:2px 7px;border-radius:3px;font-size:12px;font-weight:600;}
.bp{background:rgba(0,208,132,.15);color:var(--green);}
.bn{background:rgba(255,68,102,.12);color:var(--red);}
.bu{background:rgba(90,96,112,.18);color:var(--muted);}
.tlo{display:grid;grid-template-columns:repeat(6,1fr);padding:10px 12px;gap:4px;border-top:1px solid var(--border);}
.tlo-c{text-align:center;}
.tlo-c .lbl{font-family:var(--mono);font-size:10px;color:var(--muted);margin-bottom:3px;text-align:center;}
.tlo-c .val{font-family:var(--mono);font-size:12px;margin-bottom:3px;text-align:center;}

/* ══ TREND STATUS ══════════════════════════════════════ */
.ts{width:100%;border-collapse:collapse;font-family:var(--mono);font-size:13px;}
.ts th{padding:8px 10px;font-size:12px;color:var(--muted);text-transform:uppercase;border-bottom:1px solid var(--border);text-align:center;font-weight:500;}
.ts th:first-child{text-align:left;}
.ts td{padding:8px 12px;text-align:center;border-bottom:1px solid rgba(125,130,145,.1);font-size:13px;}
.ts tr:last-child td{border-bottom:none;}
.ts td:first-child{text-align:left;color:var(--muted);font-size:12px;}
.ty{color:var(--green);font-weight:600;} .tn{color:var(--red);font-weight:600;}

/* ══ POWER TREND / FACTORS ════════════════════════════ */
.ptb,.fb{padding:12px 14px;}
.ptr,.fr{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(125,130,145,.1);}
.ptr:last-child,.fr:last-child{border-bottom:none;}
.ptr .lbl,.fr .lbl{font-family:var(--mono);font-size:12px;color:var(--muted);}
.ptr .val,.fr .val{font-family:var(--mono);font-size:12px;font-weight:600;}
.vno{color:var(--red);} .vyes{color:var(--green);} .vnum{color:var(--text);}

/* ══ RS GAINERS ════════════════════════════════════════ */
.rss{padding:10px;}
.rsi{display:flex;align-items:center;gap:8px;padding:7px 6px;border-radius:5px;transition:background .15s;cursor:pointer;}
.rsi:hover{background:var(--surface2);}
.rsb{font-family:var(--mono);font-size:12px;font-weight:600;padding:3px 6px;border-radius:3px;min-width:50px;text-align:center;flex-shrink:0;}
.r100{background:rgba(0,208,132,.15);color:var(--green);border:1px solid rgba(0,208,132,.3);}
.r65{background:rgba(245,200,66,.15);color:var(--yellow);border:1px solid rgba(245,200,66,.3);}
.r50{background:rgba(255,68,102,.1);color:var(--red);border:1px solid rgba(255,68,102,.2);}
.ri{flex:1;}
.ri .tn2{font-family:var(--mono);font-size:12px;font-weight:500;}
.ri .sc{font-size:12px;color:var(--muted);}
.rr{text-align:right;}
.rr .rp{font-family:var(--mono);font-size:12px;font-weight:500;}
.rr .rc{font-family:var(--mono);font-size:13px;font-weight:600;}
.slbl{font-family:var(--mono);font-size:12px;color:var(--muted);letter-spacing:.1em;text-transform:uppercase;padding:8px 4px 4px;}

/* ══ SECTOR TABLE ══════════════════════════════════════ */
.tw{overflow-x:auto;-webkit-overflow-scrolling:touch;}
table{width:100%;border-collapse:collapse;font-family:var(--mono);font-size:13px;}
thead th{padding:9px 10px;text-align:center;font-size:12px;letter-spacing:.06em;color:var(--muted);text-transform:uppercase;font-weight:500;border-bottom:1px solid var(--border);white-space:nowrap;}
tbody tr{border-bottom:1px solid rgba(125,130,145,.1);transition:background .15s;cursor:pointer;}
tbody tr:hover{background:var(--surface2);}
tbody tr:last-child{border-bottom:none;}
td{padding:9px 12px;white-space:nowrap;vertical-align:middle;}
.rsc{font-weight:600;font-size:12px;width:34px;height:22px;display:flex;align-items:center;justify-content:center;border-radius:3px;}
.rh{background:rgba(0,208,132,.2);color:var(--green);}
.rm{background:rgba(245,200,66,.15);color:var(--yellow);}
.rl{background:rgba(255,68,102,.12);color:var(--red);}
.rvl{background:rgba(255,68,102,.07);color:var(--red);opacity:.7;}
.tck{color:var(--blue);font-weight:500;font-size:13px;}
.tname{color:var(--text);font-family:var(--sans);font-size:13px;}
.nc{text-align:right;}

/* ══ TAG GRIDS ═════════════════════════════════════════ */
.tg{padding:9px;display:flex;flex-wrap:wrap;gap:5px;}
.tag{font-family:var(--mono);font-size:10px;padding:3px 7px;border-radius:3px;background:var(--surface2);border:1px solid var(--border);color:var(--text);transition:all .15s;cursor:pointer;position:relative;}
.tag:hover{border-color:var(--accent);color:var(--accent);}
.thl{background:rgba(0,208,132,.1);border-color:rgba(0,208,132,.3);color:var(--green);}
.tyw{background:rgba(245,200,66,.1);border-color:rgba(245,200,66,.25);color:var(--yellow);}
.tip{position:absolute;bottom:calc(100% + 4px);left:50%;transform:translateX(-50%);background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:2px 6px;font-size:9px;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .15s;z-index:10;}
.tag:hover .tip{opacity:1;}

/* ══ ERROR BANNER ══════════════════════════════════════ */
.err{background:rgba(255,68,102,.08);border:1px solid rgba(255,68,102,.2);border-radius:6px;padding:8px 12px;margin-bottom:10px;font-family:var(--mono);font-size:10px;color:var(--red);display:none;}
.err.show{display:block;}

/* ══ SKELETON ══════════════════════════════════════════ */
.sk{background:linear-gradient(90deg,var(--surface2) 25%,var(--border) 50%,var(--surface2) 75%);background-size:200% 100%;animation:shimmer 1.4s infinite;border-radius:3px;display:inline-block;}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

/* ══ MOBILE RESPONSIVE ═════════════════════════════════ */
@media(max-width:1400px){.r1b{grid-template-columns:200px 240px 1fr}.r2{grid-template-columns:280px 1fr}}.rtd{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-bottom:var(--gap);}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}}.rtd{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-bottom:var(--gap);}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}}
@media(max-width:1200px){.r1{grid-template-columns:1fr;}.r1b{grid-template-columns:1fr 1fr;}.r2{grid-template-columns:1fr;}}.r1 .pnl:nth-child(3){grid-column:1/-1;}.rtd{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-bottom:var(--gap);}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}}.r1 .pnl:nth-child(3){grid-column:1/-1;}.rtd{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-bottom:var(--gap);}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}}
@media(max-width:1024px){.r1b{grid-template-columns:1fr 1fr;}}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}}.rtd{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-bottom:var(--gap);}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}.r3{grid-template-columns:1fr 1fr;}}

@media(max-width:768px){
  .idx{grid-template-columns:repeat(4,1fr);}
  .r1,.r3{grid-template-columns:1fr 1fr;}
  .r1 .pnl{grid-column:auto;}
  .hdr-right .dt{display:none;}
}
@media(max-width:540px){
  .idx{grid-template-columns:repeat(2,1fr);}
  .r1,.r2,.r3{grid-template-columns:1fr;}
  body{padding:10px 10px calc(env(safe-area-inset-bottom,10px) + 10px);}
  .hdr h1 .label{display:none;}
}
</style>
<style>
/* ══════════════════════════════════════════════════════
   CSS Variables — Dark & Light Theme
══════════════════════════════════════════════════════ */
:root {
  --green:#00d084; --red:#ff4466; --yellow:#f5c842; --blue:#4d9fff; --accent:#7c6af7;
  --mono:'IBM Plex Mono',monospace; --sans:'IBM Plex Sans',sans-serif;
  --radius:8px; --gap:10px;
  --transition: background .25s, color .25s, border-color .25s;
}
[data-theme="dark"] {
  --bg:#0a0b0e; --surface:#111318; --surface2:#171b22; --border:#1e2330;
  --text:#e8eaf0; --muted:#5a6070; --th-btn:#1e2535;
}
[data-theme="light"] {
  --bg:#f0f2f5; --surface:#ffffff; --surface2:#f7f8fa; --border:#e2e6ed;
  --text:#1a1d24; --muted:#8a94a6; --th-btn:#e8ecf2;
  --green:#00a864; --red:#d63050; --yellow:#c8971a; --blue:#2b7fd4; --accent:#5c4fd6;
}

/* ── Reset ── */
*{margin:0;padding:0;box-sizing:border-box;}
body {
  background:var(--bg); color:var(--text);
  font-family:var(--sans); min-height:100vh;
  padding: env(safe-area-inset-top,12px) env(safe-area-inset-right,16px)
           env(safe-area-inset-bottom,16px) env(safe-area-inset-left,16px);
  transition: var(--transition);
}

/* ══ LOGIN SCREEN ══════════════════════════════════════ */
#loginScreen {
  position:fixed;inset:0;z-index:1000;
  background:var(--bg);
  display:flex;align-items:center;justify-content:center;
  flex-direction:column;gap:20px;
  transition:opacity .3s;
}
#loginScreen.hidden{opacity:0;pointer-events:none;}
.login-box {
  background:var(--surface);border:1px solid var(--border);
  border-radius:14px;padding:32px 28px;width:320px;max-width:90vw;
  box-shadow:0 20px 60px rgba(0,0,0,.4);
}
.login-logo {
  font-family:var(--mono);font-size:11px;letter-spacing:.2em;
  color:var(--muted);text-transform:uppercase;text-align:center;margin-bottom:24px;
}
.login-logo span{display:block;font-size:22px;letter-spacing:.05em;color:var(--text);margin-bottom:6px;}
.login-box input {
  width:100%;background:var(--surface2);border:1px solid var(--border);
  border-radius:7px;padding:11px 14px;color:var(--text);
  font-family:var(--mono);font-size:14px;outline:none;
  transition:border-color .2s;margin-bottom:12px;
}
.login-box input:focus{border-color:var(--accent);}
.login-box input::placeholder{color:var(--muted);}
.login-btn {
  width:100%;padding:11px;border:none;border-radius:7px;
  background:var(--accent);color:#fff;font-family:var(--mono);
  font-size:13px;font-weight:600;cursor:pointer;letter-spacing:.05em;
  transition:opacity .2s;
}
.login-btn:hover{opacity:.85;}
.login-err{color:var(--red);font-family:var(--mono);font-size:11px;text-align:center;height:14px;}

/* ══ HEADER ════════════════════════════════════════════ */
.hdr {
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:14px;padding-bottom:12px;border-bottom:1px solid var(--border);
  gap:10px;flex-wrap:wrap;
}
.hdr h1{font-family:var(--mono);font-size:12px;letter-spacing:.15em;color:var(--muted);text-transform:uppercase;}
.hdr-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.dt{font-family:var(--mono);font-size:12px;color:var(--muted);}
.last-upd{font-family:var(--mono);font-size:12px;color:var(--muted);}

/* Theme toggle */
.th-btn {
  width:32px;height:32px;border-radius:50%;border:1px solid var(--border);
  background:var(--th-btn);cursor:pointer;display:flex;align-items:center;
  justify-content:center;font-size:15px;transition:all .2s;flex-shrink:0;
}
.th-btn:hover{border-color:var(--accent);}

/* Status pill */
.pill {
  font-family:var(--mono);font-size:12px;padding:5px 12px;
  border-radius:10px;border:1px solid var(--border);
  color:var(--muted);display:flex;align-items:center;gap:5px;
  cursor:pointer;transition:all .2s;white-space:nowrap;
}
.pill:hover{border-color:var(--accent);}
.pill.live{border-color:rgba(0,208,132,.4);color:var(--green);}
.pill.error{border-color:rgba(255,68,102,.4);color:var(--red);}
.pill.loading{border-color:rgba(77,159,255,.4);color:var(--blue);}
.dot{width:6px;height:6px;border-radius:50%;background:currentColor;flex-shrink:0;}
.pulse{animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* ══ INDEX CARDS ═══════════════════════════════════════ */
.idx{display:grid;grid-template-columns:repeat(7,1fr);gap:10px;margin-bottom:14px;}
.ic{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px 16px;min-height:90px;display:flex;flex-direction:column;justify-content:space-between;transition:var(--transition),border-color .2s;cursor:pointer;}
.ic:hover{border-color:var(--accent);}
.ic .tk{font-family:var(--mono);font-size:12px;color:var(--muted);letter-spacing:.1em;margin-bottom:5px;}
.ic .pr{font-family:var(--mono);font-size:20px;font-weight:500;margin-bottom:4px;}
.ic .ch{font-family:var(--mono);font-size:13px;font-weight:600;margin-bottom:5px;}
.ic .nm{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;}
.up{color:var(--green);} .dn{color:var(--red);}

/* ══ PANELS ════════════════════════════════════════════ */
.pnl{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;transition:var(--transition);}
.ph{padding:11px 15px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:7px;}
.ph::before{content:'';display:block;width:3px;height:12px;background:var(--accent);border-radius:2px;flex-shrink:0;}
.ph h3{font-family:var(--mono);font-size:12px;letter-spacing:.11em;text-transform:uppercase;font-weight:500;}


/* ══ LAYOUT ════════════════════════════════════════════ */
/* Zeile 1: Market Conditions | Performance | Trend (full width) */
.r1{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap);margin-bottom:var(--gap);}
/* Zeile 2: Power Trend | Factors | RS Gainers (full width) */
.rtd{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-bottom:var(--gap);}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}
/* Zeile 3: RS Gainers sidebar | Sector Table */
.r2{display:grid;grid-template-columns:320px 1fr;gap:var(--gap);margin-bottom:var(--gap);}

@media(max-width:1400px){.r1b{grid-template-columns:200px 240px 1fr}.r2{grid-template-columns:280px 1fr}}.rtd{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-bottom:var(--gap);}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}}
  .rtd{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-bottom:var(--gap);}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}
}
@media(max-width:1200px){.r1{grid-template-columns:1fr;}.r1b{grid-template-columns:1fr 1fr;}.r2{grid-template-columns:1fr;}}.r1 .pnl:nth-child(3){grid-column:1/-1;}.rtd{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-bottom:var(--gap);}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}}
  .r1 .pnl:nth-child(3){grid-column:1/-1;}
  .rtd{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-bottom:var(--gap);}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}
}
@media(max-width:1024px){.r1b{grid-template-columns:1fr 1fr;}}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}}
  .rtd{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-bottom:var(--gap);}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}
}
@media(max-width:768px){
  .idx{grid-template-columns:repeat(4,1fr);}
  .r1,.rtd{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-bottom:var(--gap);}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}
  .r1 .pnl{grid-column:auto;}
}
@media(max-width:540px){
  .idx{grid-template-columns:repeat(2,1fr);}
  .r1,.r1b,.r2{display:grid;grid-template-columns:320px 1fr;gap:var(--gap);margin-bottom:var(--gap);}
  body{padding:10px 10px calc(env(safe-area-inset-bottom,10px) + 10px);}
}

/* ══ MARKET CONDITIONS ═════════════════════════════════ */
.mc{padding:11px 13px;}
.mc-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.mc-badge{font-family:var(--mono);font-size:13px;font-weight:600;padding:4px 12px;border-radius:4px;}
.mc-badge.neg{background:rgba(255,68,102,.15);color:var(--red);border:1px solid rgba(255,68,102,.3);}
.mc-badge.pos{background:rgba(0,208,132,.15);color:var(--green);border:1px solid rgba(0,208,132,.3);}
.mc-badge.neu{background:rgba(90,96,112,.2);color:var(--muted);border:1px solid rgba(90,96,112,.2);}
.mc-pct{font-family:var(--mono);font-size:17px;font-weight:600;}
.mc-sub{font-family:var(--mono);font-size:9px;color:var(--muted);margin-bottom:8px;}
.mc-chart{height:52px;}
.mc-chart svg{width:100%;height:100%;}

/* ══ PERF TABLE ════════════════════════════════════════ */
.ptable{width:100%;border-collapse:collapse;font-family:var(--mono);font-size:12px;table-layout:fixed;}
.ptable th{padding:8px 10px;font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;border-bottom:1px solid var(--border);text-align:center;font-weight:500;}
.ptable td{padding:8px 10px;text-align:center;border-bottom:1px solid rgba(125,130,145,.12);font-size:12px;}
.ptable tr:last-child td{border-bottom:none;}
.bdg{display:inline-block;padding:2px 7px;border-radius:3px;font-size:12px;font-weight:600;}
.bp{background:rgba(0,208,132,.15);color:var(--green);}
.bn{background:rgba(255,68,102,.12);color:var(--red);}
.bu{background:rgba(90,96,112,.18);color:var(--muted);}
.tlo{display:grid;grid-template-columns:repeat(6,1fr);padding:10px 12px;gap:4px;border-top:1px solid var(--border);}
.tlo-c{text-align:center;}
.tlo-c .lbl{font-family:var(--mono);font-size:10px;color:var(--muted);margin-bottom:3px;text-align:center;}
.tlo-c .val{font-family:var(--mono);font-size:12px;margin-bottom:3px;text-align:center;}

/* ══ TREND STATUS ══════════════════════════════════════ */
.ts{width:100%;border-collapse:collapse;font-family:var(--mono);font-size:13px;}
.ts th{padding:8px 10px;font-size:12px;color:var(--muted);text-transform:uppercase;border-bottom:1px solid var(--border);text-align:center;font-weight:500;}
.ts th:first-child{text-align:left;}
.ts td{padding:8px 12px;text-align:center;border-bottom:1px solid rgba(125,130,145,.1);font-size:13px;}
.ts tr:last-child td{border-bottom:none;}
.ts td:first-child{text-align:left;color:var(--muted);font-size:12px;}
.ty{color:var(--green);font-weight:600;} .tn{color:var(--red);font-weight:600;}

/* ══ POWER TREND / FACTORS ════════════════════════════ */
.ptb,.fb{padding:12px 14px;}
.ptr,.fr{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(125,130,145,.1);}
.ptr:last-child,.fr:last-child{border-bottom:none;}
.ptr .lbl,.fr .lbl{font-family:var(--mono);font-size:12px;color:var(--muted);}
.ptr .val,.fr .val{font-family:var(--mono);font-size:12px;font-weight:600;}
.vno{color:var(--red);} .vyes{color:var(--green);} .vnum{color:var(--text);}

/* ══ RS GAINERS ════════════════════════════════════════ */
.rss{padding:10px;}
.rsi{display:flex;align-items:center;gap:8px;padding:7px 6px;border-radius:5px;transition:background .15s;cursor:pointer;}
.rsi:hover{background:var(--surface2);}
.rsb{font-family:var(--mono);font-size:12px;font-weight:600;padding:3px 6px;border-radius:3px;min-width:50px;text-align:center;flex-shrink:0;}
.r100{background:rgba(0,208,132,.15);color:var(--green);border:1px solid rgba(0,208,132,.3);}
.r65{background:rgba(245,200,66,.15);color:var(--yellow);border:1px solid rgba(245,200,66,.3);}
.r50{background:rgba(255,68,102,.1);color:var(--red);border:1px solid rgba(255,68,102,.2);}
.ri{flex:1;}
.ri .tn2{font-family:var(--mono);font-size:12px;font-weight:500;}
.ri .sc{font-size:12px;color:var(--muted);}
.rr{text-align:right;}
.rr .rp{font-family:var(--mono);font-size:12px;font-weight:500;}
.rr .rc{font-family:var(--mono);font-size:13px;font-weight:600;}
.slbl{font-family:var(--mono);font-size:12px;color:var(--muted);letter-spacing:.1em;text-transform:uppercase;padding:8px 4px 4px;}

/* ══ SECTOR TABLE ══════════════════════════════════════ */
.tw{overflow-x:auto;-webkit-overflow-scrolling:touch;}
table{width:100%;border-collapse:collapse;font-family:var(--mono);font-size:13px;}
thead th{padding:9px 10px;text-align:center;font-size:12px;letter-spacing:.06em;color:var(--muted);text-transform:uppercase;font-weight:500;border-bottom:1px solid var(--border);white-space:nowrap;}
tbody tr{border-bottom:1px solid rgba(125,130,145,.1);transition:background .15s;cursor:pointer;}
tbody tr:hover{background:var(--surface2);}
tbody tr:last-child{border-bottom:none;}
td{padding:9px 12px;white-space:nowrap;vertical-align:middle;}
.rsc{font-weight:600;font-size:12px;width:34px;height:22px;display:flex;align-items:center;justify-content:center;border-radius:3px;}
.rh{background:rgba(0,208,132,.2);color:var(--green);}
.rm{background:rgba(245,200,66,.15);color:var(--yellow);}
.rl{background:rgba(255,68,102,.12);color:var(--red);}
.rvl{background:rgba(255,68,102,.07);color:var(--red);opacity:.7;}
.tck{color:var(--blue);font-weight:500;font-size:13px;}
.tname{color:var(--text);font-family:var(--sans);font-size:13px;}
.nc{text-align:right;}

/* ══ TAG GRIDS ═════════════════════════════════════════ */
.tg{padding:9px;display:flex;flex-wrap:wrap;gap:5px;}
.tag{font-family:var(--mono);font-size:10px;padding:3px 7px;border-radius:3px;background:var(--surface2);border:1px solid var(--border);color:var(--text);transition:all .15s;cursor:pointer;position:relative;}
.tag:hover{border-color:var(--accent);color:var(--accent);}
.thl{background:rgba(0,208,132,.1);border-color:rgba(0,208,132,.3);color:var(--green);}
.tyw{background:rgba(245,200,66,.1);border-color:rgba(245,200,66,.25);color:var(--yellow);}
.tip{position:absolute;bottom:calc(100% + 4px);left:50%;transform:translateX(-50%);background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:2px 6px;font-size:9px;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .15s;z-index:10;}
.tag:hover .tip{opacity:1;}

/* ══ ERROR BANNER ══════════════════════════════════════ */
.err{background:rgba(255,68,102,.08);border:1px solid rgba(255,68,102,.2);border-radius:6px;padding:8px 12px;margin-bottom:10px;font-family:var(--mono);font-size:10px;color:var(--red);display:none;}
.err.show{display:block;}

/* ══ SKELETON ══════════════════════════════════════════ */
.sk{background:linear-gradient(90deg,var(--surface2) 25%,var(--border) 50%,var(--surface2) 75%);background-size:200% 100%;animation:shimmer 1.4s infinite;border-radius:3px;display:inline-block;}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

/* ══ MOBILE RESPONSIVE ═════════════════════════════════ */
@media(max-width:1400px){.r1b{grid-template-columns:200px 240px 1fr}.r2{grid-template-columns:280px 1fr}}.rtd{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-bottom:var(--gap);}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}}.rtd{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-bottom:var(--gap);}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}}
@media(max-width:1200px){.r1{grid-template-columns:1fr;}.r1b{grid-template-columns:1fr 1fr;}.r2{grid-template-columns:1fr;}}.r1 .pnl:nth-child(3){grid-column:1/-1;}.rtd{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-bottom:var(--gap);}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}}.r1 .pnl:nth-child(3){grid-column:1/-1;}.rtd{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-bottom:var(--gap);}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}}
@media(max-width:1024px){.r1b{grid-template-columns:1fr 1fr;}}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}}.rtd{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-bottom:var(--gap);}
.r1b{display:grid;grid-template-columns:220px 260px 1fr;gap:var(--gap);margin-bottom:var(--gap);}.r3{grid-template-columns:1fr 1fr;}}

@media(max-width:768px){
  .idx{grid-template-columns:repeat(4,1fr);}
  .r1,.r3{grid-template-columns:1fr 1fr;}
  .r1 .pnl{grid-column:auto;}
  .hdr-right .dt{display:none;}
}
@media(max-width:540px){
  .idx{grid-template-columns:repeat(2,1fr);}
  .r1,.r2,.r3{grid-template-columns:1fr;}
  body{padding:10px 10px calc(env(safe-area-inset-bottom,10px) + 10px);}
  .hdr h1 .label{display:none;}
}
</style>
<body>

<!-- ── Login Screen ── -->
<div id="loginScreen">
  <div class="login-box">
    <div class="login-logo">
      <span>📈 Markets</span>
      DASHBOARD
    </div>
    <input type="password" id="pwInput" placeholder="API Key eingeben…" autocomplete="current-password">
    <button class="login-btn" onclick="doLogin()">Anmelden</button>
    <div class="login-err" id="loginErr"></div>
  </div>
</div>

<!-- ── Main App ── -->
<div id="app" style="display:none">

  <div class="hdr">
    <h1><span class="label">Market </span>Dashboard</h1>
    <div class="hdr-right">
      <span class="last-upd" id="lastUpd"></span>
      <div class="pill loading" id="pill" onclick="refreshAll()">
        <span class="dot pulse" id="pillDot"></span>
        <span id="pillTxt">Loading…</span>
      </div>
      <button class="th-btn" id="thBtn" onclick="toggleTheme()" title="Dark/Light Mode">🌙</button>
      <div class="dt" id="dtEl"></div>
    </div>
  </div>

  <div class="err" id="errBanner">⚠ API nicht erreichbar — statische Fallback-Daten</div>

  <!-- Index Cards -->
  <div class="idx" id="idxRow"></div>

  <!-- ── Zeile 1: Market Conditions | Performance Overview (50/50) ── -->
  <div class="r1">

    <div class="pnl">
      <div class="ph"><h3>Market Conditions</h3></div>
      <div class="mc">

        <!-- Status Badge + Score -->
        <div class="mc-row" style="margin-bottom:12px;">
          <div class="mc-badge neg" id="mcBadge">—</div>
          <div id="mcScoreGauge" style="display:flex;align-items:center;gap:8px;">
            <div style="font-family:var(--mono);font-size:11px;color:var(--muted);">SCORE</div>
            <div id="mcScore" style="font-family:var(--mono);font-size:22px;font-weight:700;color:var(--text);">—</div>
          </div>
        </div>

        <!-- Score Bar -->
        <div style="margin-bottom:12px;">
          <div style="height:6px;background:var(--surface2);border-radius:3px;overflow:hidden;position:relative;">
            <div style="position:absolute;left:50%;top:0;width:1px;height:100%;background:var(--border);"></div>
            <div id="mcBar" style="height:100%;width:50%;background:var(--muted);border-radius:3px;transition:width .4s,background .4s;"></div>
          </div>
          <div style="display:flex;justify-content:space-between;font-family:var(--mono);font-size:9px;color:var(--muted);margin-top:3px;">
            <span>-100</span><span>BEARISH</span><span>0</span><span>BULLISH</span><span>+100</span>
          </div>
        </div>

        <!-- 5 Komponenten -->
        <div id="mcChecks" style="display:flex;flex-direction:column;gap:5px;"></div>

        <!-- Separator -->
        <div style="border-top:1px solid var(--border);margin-top:12px;padding-top:12px;">
          <!-- Marktbedingungen Detail Grid -->
          <div id="mcBreadth" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;"></div>
        </div>

      </div>
    </div>

    <div class="pnl">
      <div class="ph"><h3>Performance Overview</h3></div>
      <table class="ptable">
        <thead><tr><th>YTD</th><th>1W</th><th>1M</th><th>1Y</th><th>52W Hi</th></tr></thead>
        <tbody>
          <tr id="perfR"><td colspan="5" style="text-align:center"><span class="sk" style="width:85%;height:11px"></span></td></tr>
          <tr id="perfB"><td colspan="5"></td></tr>
        </tbody>
      </table>
      <div class="tlo" id="tloRow">
        <div class="tlo-c"><div class="lbl">10SMA</div><div class="val sk" style="width:38px;height:10px"></div></div>
        <div class="tlo-c"><div class="lbl">20SMA</div><div class="val sk" style="width:38px;height:10px"></div></div>
        <div class="tlo-c"><div class="lbl">50SMA</div><div class="val sk" style="width:38px;height:10px"></div></div>
        <div class="tlo-c"><div class="lbl">200SMA</div><div class="val sk" style="width:38px;height:10px"></div></div>
        <div class="tlo-c"><div class="lbl">20&gt;50</div><div class="val sk" style="width:38px;height:10px"></div></div>
        <div class="tlo-c"><div class="lbl">50&gt;200</div><div class="val sk" style="width:38px;height:10px"></div></div>
      </div>
    </div>

  </div>

  <!-- ── Zeile 2: Trend Status (full width) ── -->
  <div class="rtd">

    <div class="pnl">
      <div class="ph"><h3>Trend Status</h3></div>
      <table class="ts">
        <thead><tr><th>Signal</th><th>SPY</th><th>RSP</th><th>QQQ</th><th>QQQE</th></tr></thead>
        <tbody id="trendTbl"></tbody>
      </table>
    </div>

  </div>

  <!-- ── Zeile 3: Power Trend | Factors | RS Gainers ── -->
  <div class="r1b">

    <div class="pnl">
      <div class="ph"><h3>Power Trend (QQQ)</h3></div>
      <div class="ptb" id="ptEl"></div>
    </div>

    <div class="pnl">
      <div class="ph"><h3>Factors vs SP500</h3></div>
      <div class="fb" id="facEl"></div>
    </div>

    <div class="pnl">
      <div class="ph"><h3>RS Gainers</h3></div>
      <div class="rss" id="rsEl"></div>
    </div>

  </div>

  <!-- ── Zeile 4: Sector Leaders (full width) ── -->
  <div class="r2">

    <div class="pnl">
      <div class="ph"><h3>Sector Leaders</h3></div>
      <div class="tw">
        <table>
          <thead><tr>
            <th>RS</th><th>Ticker</th><th>Name</th>
            <th>Day%</th><th>Wk%</th><th>Mth%</th>
            <th>RS Day%</th><th>RS Wk%</th><th>RS Mth%</th>
            <th>52W Hi</th>
          </tr></thead>
          <tbody id="secTbl"></tbody>
        </table>
      </div>
    </div>

  </div>

</div><!-- /#app -->

<script>
// ══════════════════════════════════════════════════════
//  Market Dashboard — Vercel Serverless Proxy
//  Finnhub (quotes) + Yahoo Finance via /api/data
// ══════════════════════════════════════════════════════
const REFRESH  = 5 * 60 * 1000;
const API      = '/api/data';
let   FKEY     = '';

// Kill old service workers
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.getRegistrations().then(r => r.forEach(sw => sw.unregister()));
  if (window.caches) caches.keys().then(ks => ks.forEach(k => caches.delete(k)));
  // Force reload if old cached version
  if (window.location.hash !== '#v3') {
    window.location.hash = '#v3';
    window.location.reload(true);
  }
}

// Theme
function toggleTheme() {
  const html = document.documentElement;
  const next = html.dataset.theme === 'dark' ? 'light' : 'dark';
  html.dataset.theme = next;
  localStorage.setItem('theme', next);
  document.getElementById('thBtn').textContent = next === 'dark' ? '🌙' : '☀️';
  document.getElementById('themeColorMeta').content = next === 'dark' ? '#0a0b0e' : '#f0f2f5';
}
const savedTheme = localStorage.getItem('theme') || 'dark';
document.documentElement.dataset.theme = savedTheme;
document.getElementById('thBtn').textContent = savedTheme === 'dark' ? '🌙' : '☀️';

// Auth
function doLogin() {
  const pw  = document.getElementById('pwInput').value.trim();
  const err = document.getElementById('loginErr');
  if (!pw) { err.textContent = 'Bitte Finnhub API Key eingeben'; return; }
  err.textContent = 'Verbinde…';
  verifyKey(pw);
}
document.getElementById('pwInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') doLogin();
});

async function verifyKey(key) {
  const err = document.getElementById('loginErr');
  try {
    const res  = await fetch(`${API}?type=quotes&symbols=SPY&fhkey=${key}`);
    const data = await res.json();
    if (data.SPY && data.SPY.c > 0) {
      FKEY = key;
      localStorage.setItem('fh_key', key);
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('app').style.display = 'block';
      setTimeout(() => document.getElementById('loginScreen').style.display = 'none', 350);
      init();
    } else {
      err.textContent = 'Ungültiger API Key';
    }
  } catch(e) { err.textContent = 'Verbindungsfehler'; }
}
const savedKey = localStorage.getItem('fh_key');
if (savedKey) { FKEY = savedKey; verifyKey(savedKey); }

// API helpers
async function getQuotes(symbols) {
  const res = await fetch(`${API}?type=quotes&symbols=${symbols.join(',')}&fhkey=${FKEY}`);
  return res.json();
}
async function getCandles(symbols, range='1y') {
  const encoded = symbols.map(s => s.replace(/\^/g, '__'));
  const res = await fetch(`${API}?type=candles&symbols=${encoded.join(',')}&range=${range}`);
  const data = await res.json();
  const out = {};
  Object.entries(data).forEach(([k,v]) => { out[k.replace(/__/g,'^')] = v; });
  return out;
}
function clean(arr) { return (arr||[]).filter(v => v != null && !isNaN(v)); }

// Math
function sma(arr, n) { const s=arr.slice(-n); return s.reduce((a,b)=>a+b,0)/s.length; }
function emaCalc(arr, n) { const k=2/(n+1); let e=arr[0]; for(let i=1;i<arr.length;i++) e=arr[i]*k+e*(1-k); return e; }

// UI
function setStatus(state, text) {
  document.getElementById('pill').className = `pill ${state}`;
  document.getElementById('pillDot').className = `dot${state==='live'?' pulse':''}`;
  document.getElementById('pillTxt').textContent = text;
}
function pct(v, d=2) {
  if (v==null||isNaN(v)) return '—';
  return `<span class="${v>=0?'up':'dn'}">${v>=0?'+':''}${v.toFixed(d)}%</span>`;
}
function bdg(v) {
  if (v==null) return '<span class="bdg bu">—</span>';
  if (v>0) return '<span class="bdg bp">Positive</span>';
  if (v<0) return '<span class="bdg bn">Negative</span>';
  return '<span class="bdg bu">Neutral</span>';
}
function rsClass(rs) { if(rs>=80) return 'rh'; if(rs>=60) return 'rm'; if(rs>=40) return 'rl'; return 'rvl'; }

document.getElementById('dtEl').textContent =
  new Date().toLocaleDateString('en-US',{weekday:'short',year:'numeric',month:'short',day:'numeric'});

// ── 1. Index Cards ────────────────────────────────────
const IDX_SYMS = ['SPY','RSP','QQQ','QQQE','IWM','BINANCE:BTCUSDT'];
const IDX_META = {
  'SPY':'S&P 500','RSP':'S&P 500 EQ WT','QQQ':'NASDAQ 100',
  'QQQE':'NASDAQ 100 EQ WT','IWM':'RUSSELL 2000','BINANCE:BTCUSDT':'BITCOIN'
};

async function loadIndices() {
  const [quotesData, vixRes] = await Promise.all([
    getQuotes(IDX_SYMS),
    fetch(`${API}?type=vix`).then(r=>r.json()).catch(()=>({}))
  ]);
  const row = document.getElementById('idxRow');
  row.innerHTML = '';
  IDX_SYMS.forEach((sym,i) => {
    const q     = quotesData[sym];
    const price = q?.c || 0;
    const prev  = q?.pc || 0;
    const chg   = prev>0 ? (price-prev)/prev*100 : 0;
    const disp  = sym==='BINANCE:BTCUSDT' ? 'BTC' : sym;
    const pstr  = sym==='BINANCE:BTCUSDT' ? '$'+Math.round(price).toLocaleString() : '$'+price.toFixed(2);
    row.innerHTML += `<div class="ic" style="animation-delay:${i*.05}s">
      <div class="tk">${disp}</div><div class="pr">${pstr}</div>
      <div class="ch ${chg>=0?'up':'dn'}">${chg>=0?'+':''}${chg.toFixed(2)}%</div>
      <div class="nm">${IDX_META[sym]}</div></div>`;
  });
  // VIX card
  const vix = vixRes.vix;
  if (vix != null) {
    row.innerHTML += `<div class="ic" style="animation-delay:0.35s">
      <div class="tk">VIX</div><div class="pr">${vix.toFixed(2)}</div>
      <div class="ch" style="color:var(--muted)">—</div>
      <div class="nm">VOLATILITY</div></div>`;
  }
  return { quotes: quotesData, vix };
}

// ── 2. SPY Performance ────────────────────────────────
async function loadPerf() {
  try {
    const data  = await getCandles(['SPY'], '2y');
    const d     = data['SPY'];
    if (!d||!d.c) return null;
    const c     = clean(d.c);
    const price = c[c.length-1];
    const now   = new Date();
    const wk    = c[c.length-6]   || c[0];
    const mth   = c[c.length-22]  || c[0];
    const yr    = c[c.length-252] || c[0];
    const h52   = Math.max(...c.slice(-252));
    const times = d.t || [];
    const ytdIdx= times.findIndex(ts => new Date(ts*1000).getFullYear()===now.getFullYear());
    const ytdP  = ytdIdx>=0 ? c[ytdIdx] : c[0];
    const s10=sma(c,10), s20=sma(c,20), s50=sma(c,50), s200=sma(c,200);
    return {
      ytd:(price/ytdP-1)*100, w1:(price/wk-1)*100,
      m1:(price/mth-1)*100, y1:(price/yr-1)*100,
      h52w:(price/h52-1)*100,
      price, closes:c,
      s10,s20,s50,s200,
      spyDayPct:(price/c[c.length-2]-1)*100,
      spyWkPct:(price/wk-1)*100,
      spyMthPct:(price/mth-1)*100,
    };
  } catch(e) { console.error('Perf error',e); return null; }
}

function renderPerf(p) {
  if (!p) return;
  const f = v => v!=null ? `${v>=0?'+':''}${v.toFixed(2)}%` : '—';
  document.getElementById('perfR').innerHTML = `
    <td>${f(p.ytd)}</td><td>${f(p.w1)}</td><td>${f(p.m1)}</td>
    <td>${f(p.y1)}</td><td>${f(p.h52w)}</td>`;
  document.getElementById('perfB').innerHTML =
    `<td>${bdg(p.ytd)}</td><td>${bdg(p.w1)}</td><td>${bdg(p.m1)}</td>
     <td>${bdg(p.y1)}</td><td>${bdg(p.h52w)}</td>`;
  const {s10,s20,s50,s200,price} = p;
  const mk=(s,lbl)=>`<div class="tlo-c"><div class="lbl">${lbl}</div>
    <div class="val">${s.toFixed(0)}</div>
    <div class="bdg ${price>s?'bp':'bn'}" style="font-size:7px;padding:1px 4px">${price>s?'▲':'▼'}</div></div>`;
  const p2050=((s20/s50-1)*100).toFixed(1)+'%', p50200=((s50/s200-1)*100).toFixed(1)+'%';
  document.getElementById('tloRow').innerHTML =
    mk(s10,'10SMA')+mk(s20,'20SMA')+mk(s50,'50SMA')+mk(s200,'200SMA')+
    `<div class="tlo-c"><div class="lbl">20&gt;50</div><div class="val">${p2050}</div>
     <div class="bdg ${s20>s50?'bp':'bn'}" style="font-size:7px;padding:1px 4px">${s20>s50?'Yes':'No'}</div></div>`+
    `<div class="tlo-c"><div class="lbl">50&gt;200</div><div class="val">${p50200}</div>
     <div class="bdg ${s50>s200?'bp':'bn'}" style="font-size:7px;padding:1px 4px">${s50>s200?'Yes':'No'}</div></div>`;
  // Market conditions badge based on h52w
  const v=p.h52w;
  const badge=document.getElementById('mcBadge');
  if(badge && badge.textContent==='—') {
    if(v>-2){badge.textContent='Positive';badge.className='mc-badge pos';}
    else if(v<-10){badge.textContent='Negative';badge.className='mc-badge neg';}
    else{badge.textContent='Neutral';badge.className='mc-badge neu';}
  }
}

// ── 3. Market Conditions (PTMM-style) ─────────────────
async function loadMarketConditions(spyCloses) {
  const badge  = document.getElementById('mcBadge');
  const score  = document.getElementById('mcScore');
  const bar    = document.getElementById('mcBar');
  const checks = document.getElementById('mcChecks');
  const breadth= document.getElementById('mcBreadth');

  // ── Breadth data vom Proxy ────────────────────────
  let moVal=null, siVal=null, p50Val=null, p200Val=null, hlVal=null;
  try {
    const bRes  = await fetch(`${API}?type=breadth`);
    const bData = await bRes.json();
    moVal  = bData.nymo;
    siVal  = bData.nasi;
    hlVal  = bData.nyhl;
    p50Val = bData.pct50;
    p200Val= bData.pct200;
  } catch(e) { console.error('Breadth:', e); }

  // ── SPY Berechnungen ──────────────────────────────
  const c      = spyCloses;
  const price  = c[c.length-1];
  const prev   = c[c.length-2];
  const c8ago  = c[c.length-9]  || c[0];
  const e8     = emaCalc(c.slice(-40),  8);
  const e21    = emaCalc(c.slice(-100), 21);
  const s50    = sma(c, 50);
  const s200   = sma(c, 200);

  // RSI (14)
  const calcRSI = (closes, n=14) => {
    let gains=0, losses=0;
    for(let i=closes.length-n; i<closes.length; i++){
      const d = closes[i]-closes[i-1];
      if(d>0) gains+=d; else losses+=Math.abs(d);
    }
    const rs = (gains/n) / (losses/n + 1e-10);
    return 100 - 100/(1+rs);
  };
  const rsi = calcRSI(c, 14);

  // Momentum (8-bar)
  const momentum = (price - c8ago) / c8ago * 100;

  // Volatility (ATR10 vs ATR SMA)
  const atr10 = (() => {
    let sum=0;
    for(let i=c.length-10;i<c.length;i++){
      sum += Math.abs(c[i]-(c[i-1]||c[i]));
    }
    return sum/10;
  })();
  const atrAvg = (() => {
    let sum=0;
    for(let i=c.length-22;i<c.length-10;i++){
      sum += Math.abs(c[i]-(c[i-1]||c[i]));
    }
    return sum/12;
  })();
  const atrRatio = atrAvg > 0 ? atr10/atrAvg : 1;
  const volStatus = atrRatio > 1.4 ? 'HIGH' : atrRatio > 1.1 ? 'MODERATE' : atrRatio < 0.7 ? 'LOW' : 'NORMAL';

  // MA Alignment
  const maAlignBull = e8 > e21 && e21 > s50 && price > e21;
  const maAlignBear = e8 < e21 && e21 < s50 && price < e21;
  const maStrength  = ((e8 - s50) / s50 * 100).toFixed(2);

  // ── SCORE BERECHNUNG (Pine Script Logik) ──────────
  let trendScore = 0;

  // RSI Score (weight 25)
  const rsiW = 25;
  const rsiScore = rsi > 75 ? rsiW : rsi > 65 ? rsiW*0.72 : rsi > 55 ? rsiW*0.48 : rsi > 50 ? rsiW*0.24
    : rsi < 25 ? -rsiW : rsi < 35 ? -rsiW*0.72 : rsi < 45 ? -rsiW*0.48 : -rsiW*0.24;
  trendScore += rsiScore * 1.1;

  // MA Score (weight 35)
  const maW = 35;
  const alignBonus = Math.abs(parseFloat(maStrength)) > 5 ? maW*0.167 : 0;
  const maScore = maAlignBull ? maW + alignBonus : maAlignBear ? -(maW + alignBonus)
    : price > s50 && e8 > e21 ? maW*0.6 : price < s50 && e8 < e21 ? -maW*0.6
    : price > s50 ? maW*0.333 : -maW*0.333;
  trendScore += maScore;

  // Volatility Score (weight 20)
  const volW = 20;
  const momDir = momentum > 0 ? 1 : -1;
  const hasMom = Math.abs(momentum) > 1.5;
  const volScore = atrRatio > 1.4 && hasMom ? volW * momDir
    : atrRatio > 1.1 && hasMom ? volW*0.6*momDir
    : atrRatio > 1.4 ? volW*0.4*momDir
    : atrRatio < 0.7 ? -volW*0.25 : 0;
  trendScore += volScore;

  // McClellan Breadth Score (weight 12, replaces volume)
  const breadthW = 12;
  let breadthScore = 0;
  if (moVal != null) {
    breadthScore = moVal > 60 ? breadthW : moVal > 20 ? breadthW*0.6
      : moVal > 0 ? breadthW*0.25 : moVal < -60 ? -breadthW
      : moVal < -20 ? -breadthW*0.6 : -breadthW*0.25;
  } else if (p50Val != null) {
    breadthScore = p50Val > 70 ? breadthW : p50Val > 55 ? breadthW*0.5 : p50Val < 30 ? -breadthW : p50Val < 45 ? -breadthW*0.5 : 0;
  }
  trendScore += breadthScore;

  // Net Highs Score (weight 8)
  const nhW = 8;
  let nhScore = 0;
  if (hlVal != null) {
    nhScore = hlVal > 50 ? nhW : hlVal > 20 ? nhW*0.625 : hlVal > 0 ? nhW*0.25
      : hlVal < -50 ? -nhW : hlVal < -20 ? -nhW*0.625 : -nhW*0.25;
  }
  trendScore += nhScore;

  // Clamp -100 bis +100
  trendScore = Math.max(-100, Math.min(100, trendScore));
  const trendRound = Math.round(trendScore * 10) / 10;

  // ── Zone ─────────────────────────────────────────
  const zone = trendScore >= 30 ? 'BULLISH' : trendScore <= -30 ? 'BEARISH' : 'NEUTRAL';
  const zoneCls = trendScore >= 30 ? 'pos' : trendScore <= -30 ? 'neg' : 'neu';
  const zoneColor = trendScore >= 30 ? 'var(--green)' : trendScore <= -30 ? 'var(--red)' : 'var(--yellow)';

  badge.textContent = zone;
  badge.className = `mc-badge ${zoneCls}`;
  score.textContent = (trendScore >= 0 ? '+' : '') + trendRound;
  score.style.color = zoneColor;

  // Score Bar (0% = -100, 50% = 0, 100% = +100)
  if (bar) {
    const barPct = Math.round(50 + trendScore / 2);
    const barColor = trendScore >= 30 ? 'var(--green)' : trendScore <= -30 ? 'var(--red)' : 'var(--yellow)';
    // Bar startet bei 50% (Mitte = 0), geht links oder rechts
    if (trendScore >= 0) {
      bar.style.left = '50%';
      bar.style.width = (trendScore / 2) + '%';
      bar.style.background = barColor;
      bar.style.borderRadius = '0 3px 3px 0';
    } else {
      bar.style.left = (50 + trendScore / 2) + '%';
      bar.style.width = Math.abs(trendScore / 2) + '%';
      bar.style.background = barColor;
      bar.style.borderRadius = '3px 0 0 3px';
    }
    bar.style.position = 'absolute';
  }

  // ── Komponenten-Zeilen (Pine Script Gewichte) ────
  const comps = [
    { label: 'MA Alignment',   weight: 35, score: maScore,     detail: maAlignBull ? 'Bull' : maAlignBear ? 'Bear' : 'Mixed', val: maStrength+'%' },
    { label: 'RSI (14)',        weight: 25, score: rsiScore,    detail: rsi.toFixed(1), val: '' },
    { label: 'Volatility/Mom', weight: 20, score: volScore,     detail: volStatus, val: momentum.toFixed(2)+'%' },
    { label: 'Breadth',        weight: 12, score: breadthScore, detail: moVal != null ? 'McC. Osc.' : '%>50SMA', val: moVal != null ? moVal.toFixed(0) : p50Val != null ? p50Val.toFixed(1)+'%' : '—' },
    { label: 'Net Highs/Lows', weight:  8, score: nhScore,     detail: '', val: hlVal != null ? (hlVal>0?'+':'')+hlVal.toFixed(0) : '—' },
  ];

  checks.innerHTML = comps.map(c => {
    const pct = Math.round(Math.abs(c.score) / (c.weight * 1.2) * 100);
    const col  = c.score > 0.5 ? 'var(--green)' : c.score < -0.5 ? 'var(--red)' : 'var(--muted)';
    const bar  = `<div style="height:3px;background:var(--surface2);border-radius:2px;margin-top:3px;">
      <div style="height:100%;width:${Math.min(100,pct)}%;background:${col};border-radius:2px;"></div></div>`;
    return `<div style="display:grid;grid-template-columns:1fr auto auto;align-items:center;gap:8px;padding:4px 0;">
      <div>
        <div style="font-family:var(--mono);font-size:11px;color:var(--muted);">${c.label} <span style="font-size:9px;opacity:.6">${c.weight}%</span></div>
        ${bar}
      </div>
      <div style="font-family:var(--mono);font-size:11px;color:var(--muted);text-align:right;">${c.detail}</div>
      <div style="font-family:var(--mono);font-size:12px;font-weight:600;color:${col};text-align:right;min-width:40px;">${c.score >= 0 ? '+' : ''}${c.score.toFixed(1)}</div>
    </div>`;
  }).join('');

  // ── Detail-Kacheln ────────────────────────────────
  const bItems = [
    { label: 'RSI(14)',      val: rsi.toFixed(1),       cls: rsi>55?'up':rsi<45?'dn':'' },
    { label: 'Momentum',     val: (momentum>0?'+':'')+momentum.toFixed(2)+'%', cls: momentum>0?'up':'dn' },
    { label: 'Volatility',   val: volStatus,             cls: atrRatio>1.4?'dn':atrRatio<0.7?'':'up' },
    { label: 'MA Strength',  val: (parseFloat(maStrength)>0?'+':'')+maStrength+'%', cls: parseFloat(maStrength)>0?'up':'dn' },
    { label: 'McC. Osc.',    val: moVal!=null?moVal.toFixed(0):'—', cls: moVal!=null?moVal>0?'up':'dn':'' },
    { label: 'SPY/200 SMA',  val: ((price/s200-1)*100>0?'+':'')+((price/s200-1)*100).toFixed(2)+'%', cls: price>s200?'up':'dn' },
  ];
  breadth.style.gridTemplateColumns = '1fr 1fr 1fr';
  breadth.innerHTML = bItems.map(b =>
    `<div class="mc-bitem"><div class="bl">${b.label}</div>
     <div class="bv ${b.cls}">${b.val}</div></div>`
  ).join('');
}

// ── Main Refresh ──────────────────────────────────────
async function refreshAll() {
  setStatus('loading','Loading…');
  document.getElementById('errBanner').classList.remove('show');
  try {
    const [idxData, perfData] = await Promise.all([loadIndices(), loadPerf()]);
    renderPerf(perfData);

    const spyMth=perfData?.spyMthPct||0;
    const spyDay=perfData?.spyDayPct||0;
    const spyWk =perfData?.spyWkPct ||0;

    const [trend,pt,yields,sectors,factors] = await Promise.all([
      loadTrend(), loadPT(), loadYields(),
      loadSectors(spyDay,spyWk,spyMth),
      loadFactors(spyMth),
    ]);
    renderTrend(trend);
    renderPT(pt,yields);
    renderFac(factors);
    renderSectors(sectors);

    if (perfData?.closes) await loadMarketConditions(perfData.closes);

    setStatus('live','Live · 5 min');
    document.getElementById('lastUpd').textContent =
      'Updated '+new Date().toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});
  } catch(e) {
    console.error(e);
    setStatus('error','Fehler');
    document.getElementById('errBanner').classList.add('show');
  }
}

function init() { refreshAll(); setInterval(refreshAll,REFRESH); }
</script>
</body>
</html>